``` abap
*&---------------------------------------------------------------------*
*& Form display_alv_payables
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_alv .

  IF go_con2 IS INITIAL.

    CLEAR: gt_fcat1, gs_fcat1.
    PERFORM set_header_fcat USING :     'X' 'STATUS'         ' '  ' ' ' ',
                                        'X' 'GJAHR'          'ZC103FIT0001'   'C' ' ',
                                        'X' 'BELNR'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BKTXT'          'ZC103FIT0001'   ' ' ' ',
                                        ' ' 'BP_ID'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BP_NAME'          'ZC103FIT0001'   ' ' 'X',
                                        ' ' 'BUDAT'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BLDAT'           'ZC103FIT0001'   'C' ' ',
                                        ' ' 'AUGBL'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'AUGDT'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'WAERS'         'ZC103FIT0001'   'C' ' '.

    CLEAR : gt_fcat2, gs_fcat2.
    PERFORM set_item_fcat USING :     'X' 'STATUS'       ' '  ' ' ' ',          "상태
                                      'X' 'BELNR'        'ZC103FIT0002' 'C' ' ', "전표번호
                                      ' ' 'BSCHL'        'ZC103FIT0002' 'C' ' ', "전기 키
                                      ' ' 'SHKZG'        'ZC103FIT0002' 'C' ' ', "차대변 지시자
                                      ' ' 'HKONT'        'ZC103FIT0002' 'C' ' ', "계정번호
                                      ' ' 'GL_NAME'      'ZC103FIT0002' ' ' ' ',
                                      ' ' 'SGTXT'        'ZC103FIT0002' ' ' ' ', "계정상세
                                      ' ' 'DMBTR'        'ZC103FIT0002' ' ' ' ',
                                      ' ' 'K_WAERS'      'ZC103FIT0002' 'C' ' ',
                                      ' ' 'WRBTR'        'ZC103FIT0002' ' ' ' ', "금액
                                      ' ' 'WAERS'        'ZC103FIT0002' 'C' ' ', "금액
                                      ' ' 'USNAME'       'ZC103FIT0002' 'C' ' ', "전표생성자
                                      ' ' 'AUGDT'        'ZC103FIT0002' 'C' ' '. "반제전표일자

    CLEAR : gt_fcat3, gs_fcat3.
    PERFORM set_pay_deposit_fcat USING : ' ' 'BANK_DATE' 'ZC103FIT0020' 'C' ' ',
                                         ' ' 'DMBTR'   'ZC103FIT0020' ' ' ' ',
                                         ' ' 'K_WAERS' 'ZC103FIT0020' 'C' ' ',
                                         ' ' 'WRBTR'    'ZC103FIT0020' ' ' ' ',
                                         ' ' 'WAERS' 'ZC103FIT0020' 'C' ' ',
                                         ' ' 'BANK_NAME' 'ZC103FIT0020' ' ' ' '.

    PERFORM set_layout.
    PERFORM create_obj.

    SET HANDLER : lcl_event_handler=>account_edit_toolbar   FOR go_right_btm_alv,
                  lcl_event_handler=>hotspot_click       FOR go_mid_alv,
                  lcl_event_handler=>user_command        FOR go_right_btm_alv.

    CALL METHOD go_mid_alv->set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout1
      CHANGING
        it_outtab       = gt_header
        it_fieldcatalog = gt_fcat1.

    CALL METHOD go_left_btm_alv->set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout2
      CHANGING
        it_outtab       = gt_item
        it_fieldcatalog = gt_fcat2.
*        it_sort         = gt_sort.

    CALL METHOD go_right_btm_alv->set_table_for_first_display
      EXPORTING
        is_variant      = gs_variant
        i_save          = 'A'
        i_default       = 'X'
        is_layout       = gs_layout3
      CHANGING
        it_outtab       = gt_account
        it_fieldcatalog = gt_fcat3.

  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout .

  gs_layout1-zebra       = 'X'.
  gs_layout1-cwidth_opt  = 'A'.
  gs_layout1-sel_mode    = 'D'.
  gs_layout1-totals_bef = abap_true. " Total line : First display
  gs_layout1-ctab_fname = 'COLOR'.

  gs_layout2 = gs_layout1.
  gs_layout3 = gs_layout1.
  PERFORM layout_title.

  gs_variant-report     = sy-repid.
  gs_variant-handle     = 'ALV1'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_header_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_header_fcat  USING : pv_key pv_field pv_table pv_just pv_emph.

  CLEAR: gs_fcat1.

  gs_fcat1-key       = pv_key.
  gs_fcat1-fieldname = pv_field.
  gs_fcat1-ref_table = pv_table.
  gs_fcat1-just      = pv_just.
  gs_fcat1-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'BELNR'.
      gs_fcat1-coltext = '전표번호'.
      gs_fcat1-hotspot = abap_true.
    WHEN 'GJAHR'.
      gs_fcat1-coltext = '회계연도'.
    WHEN 'STATUS'.
      gs_fcat1-coltext = '상태'.
      gs_fcat1-icon    = 'X'.
    WHEN 'BKTXT'.
      gs_fcat1-coltext = '전표헤더내역'.
    WHEN 'BP_ID'.
      gs_fcat1-coltext = 'BP코드'.
    WHEN 'BP_NAME'.
      gs_fcat1-coltext = 'BP명'.
    WHEN 'BUDAT'.
      gs_fcat1-coltext = '전기일'.
    WHEN 'BLDAT'.
      gs_fcat1-coltext = '작성일'.
    WHEN 'AUGDT'.
      gs_fcat1-coltext = '반제일자'.
    WHEN 'AUGBL'.
      gs_fcat1-coltext = '반제전표번호'.
    WHEN 'WAERS'.
      gs_fcat1-coltext = '통화코드'.
  ENDCASE.


  APPEND gs_fcat1 TO gt_fcat1.
  CLEAR gs_fcat1.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_item_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_item_fcat  USING : pv_key pv_field pv_table pv_just pv_emph.

  CLEAR: gs_fcat2.

  gs_fcat2-key       = pv_key.
  gs_fcat2-fieldname = pv_field.
  gs_fcat2-ref_table = pv_table.
  gs_fcat2-just      = pv_just.
  gs_fcat2-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'BELNR'.
      gs_fcat2-coltext = '전표번호'.
    WHEN 'GJAHR'.
      gs_fcat2-coltext = '회계연도'.
    WHEN 'BUZEI'.
      gs_fcat2-coltext = '항목'.
    WHEN 'STATUS'.
      gs_fcat2-coltext = '상태'.
      gs_fcat2-icon    = 'X'.
    WHEN 'BLART'.
      gs_fcat2-coltext = '전표유형'.
    WHEN 'SGTXT'.
      gs_fcat2-coltext = '전표아이템내역'.
    WHEN 'HKONT'.
      gs_fcat2-coltext = '계정번호'.
    WHEN 'GL_NAME'.
      gs_fcat2-coltext = '계정이름'.
    WHEN 'BSCHL'.
      gs_fcat2-coltext = '전기 키'.
    WHEN 'SHKZG'.
      gs_fcat2-coltext = '차대변지시자'.
    WHEN 'SAKNR'.
      gs_fcat2-coltext = '계정번호'.
    WHEN 'WRBTR'.
      gs_fcat2-do_sum     = abap_true.
      gs_fcat2-coltext = '전표통화'.
      gs_fcat2-cfieldname = 'WAERS'.
    WHEN 'DMBTR'.
      gs_fcat2-do_sum     = abap_true.
      gs_fcat2-coltext = '현지통화'.
      gs_fcat2-cfieldname = 'K_WAERS'.
    WHEN 'USNAME'.
      gs_fcat2-coltext = '전표생성자'.
    WHEN 'AUGDT'.
      gs_fcat2-coltext = '반제일자'.
    WHEN 'K_WAERS'.
      gs_fcat2-coltext = '현지통화키'.
    WHEN 'WAERS'.
      gs_fcat2-coltext = '전표통화키'.

  ENDCASE.

  APPEND gs_fcat2 TO gt_fcat2.
  CLEAR gs_fcat2.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_obj .

  CREATE OBJECT go_con2
    EXPORTING
      container_name = 'MAIN_CONT'.

*-- 화면 분할(1)
  CREATE OBJECT go_split_top
    EXPORTING
      parent  = go_con2
      rows    = 2
      columns = 1.

  CALL METHOD go_split_top->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_mid_cont.

  CALL METHOD go_split_top->get_container
    EXPORTING
      row       = 2
      column    = 1
    RECEIVING
      container = go_btm_cont.


*-- 화면 분할(2)
  CREATE OBJECT go_split_btm
    EXPORTING
      parent  = go_btm_cont
      rows    = 1
      columns = 2.

  CALL METHOD go_split_btm->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_left_btm_cont.

  CALL METHOD go_split_btm->get_container
    EXPORTING
      row       = 1
      column    = 2
    RECEIVING
      container = go_right_btm_cont.


*-- Patch ALV
  CREATE OBJECT go_mid_alv
    EXPORTING
      i_parent = go_mid_cont.

  CREATE OBJECT go_left_btm_alv
    EXPORTING
      i_parent = go_left_btm_cont.

  CREATE OBJECT go_right_btm_alv
    EXPORTING
      i_parent = go_right_btm_cont.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_item_edit_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_INTERACTIVE
*&      --> E_OBJECT
*&---------------------------------------------------------------------*
FORM handle_account_edit_toolbar  USING    pv_interactive
                                        po_object TYPE REF TO cl_alv_event_toolbar_set.

  DATA : lv_disabled.

  CLEAR : gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR : gs_button.
  gs_button-function  = 'CLEARING'.
  gs_button-icon      = icon_okay.
  gs_button-quickinfo = '반제처리'.
  gs_button-text      = '반제'.
  APPEND gs_button TO po_object->mt_toolbar.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_data .

  DATA : ls_stable  TYPE lvc_s_stbl.

*--- 안전 리프레시 옵션 추가
  ls_stable-row = 'X'.
  ls_stable-col = 'X'.

  CALL METHOD go_mid_alv->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

  CALL METHOD go_left_btm_alv->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

  CALL METHOD go_right_btm_alv->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_docdetail
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_docdetail .

  DATA: lt_rows   TYPE lvc_t_row,
        lv_index  TYPE lvc_index,
        gs_header LIKE gs_header,  " 전표헤더 구조
        lv_docno  TYPE i.

  " 선택된 행 가져오기
  CALL METHOD go_mid_alv->get_selected_rows
    IMPORTING
      et_index_rows = lt_rows.

  READ TABLE lt_rows INTO DATA(ls_row) INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE '전표를 선택하세요.' TYPE 'W'.
    RETURN..
  ENDIF.

  " 선택된 전표 헤더 데이터 가져오기
  READ TABLE gt_header INTO gs_header INDEX ls_row-index.
  IF sy-subrc <> 0.
    MESSAGE '선택된 전표가 없습니다.' TYPE 'S' DISPLAY LIKE 'E'..
    RETURN..
  ENDIF.

  lv_docno = gs_header-belnr.

  " 해당 전표번호에 해당하는 아이템만 SELECT
  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_item
    FROM zc103fit0002
    WHERE belnr = lv_docno.

  " 하단 ALV 새로고침
  CALL METHOD go_btm_alv->refresh_table_display.


ENDFORM.

*&---------------------------------------------------------------------*
*& Form handle_hotspot_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_ROW_ID
*&      --> E_COLUMN_ID
*&---------------------------------------------------------------------*
FORM handle_hotspot_click  USING    pv_row_id
                                    pv_column_id.

  DATA: lv_gjahr TYPE zc103fit0001-gjahr,
        lv_belnr TYPE zc103fit0001-belnr,
        lv_bpid  TYPE zc103fit0001-bp_id.

  CLEAR: lv_gjahr, lv_belnr, lv_bpid.

  READ TABLE gt_header INTO gs_header INDEX pv_row_id.

*-- 선택한 전표가 있는지 확인
  IF sy-subrc <> 0.
    MESSAGE '선택된 전표가 없습니다.' TYPE 'I'.
    RETURN..
  ENDIF.

  lv_gjahr = gs_header-gjahr.
  lv_belnr = gs_header-belnr.
  lv_bpid  = gs_header-bp_id.
  gv_belnr = gs_header-belnr.

  IF gs_header-bstat = 'A'.
    gv_status = 'N'.
  ELSE.
    gv_status = 'Y'.
  ENDIF.

*-- 선택한 전표번호에 해당하는 아이템 및 은행 정보 세팅
  PERFORM get_item_bank_data USING: lv_gjahr lv_belnr lv_bpid abap_false.
  PERFORM refresh_data.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form clearing_popup
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clearing_popup .

  " 선택된 행 가져오기
  DATA: lt_rows  TYPE lvc_t_row,
        lv_index TYPE sy-tabix.

  CALL METHOD go_left_btm_alv->get_selected_rows
    IMPORTING
      et_index_rows = lt_rows.

  IF lt_rows IS INITIAL.
    MESSAGE '행을 먼저 선택하세요.' TYPE 'I'.
    RETURN..
  ENDIF.

  READ TABLE lt_rows INTO DATA(ls_row) INDEX 1.
  lv_index = ls_row-index.

  READ TABLE gt_item INTO gs_item INDEX lv_index.

  " 선택된 행의 값을 팝업에 넘겨서 보여주기
  CALL SCREEN 110.  " ← 팝업 스크린 (modal dialog screen)


ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_clearing_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_clearing_screen .

  IF go_pop_cont IS INITIAL.

    PERFORM create_pop_obj.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_pop_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_pop_obj .

  CREATE OBJECT go_pop_cont
    EXPORTING
      container_name = 'CLEARING_CONT'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_UCOMM
*&---------------------------------------------------------------------*
FORM handle_user_command  USING    pv_ucomm.

  CASE pv_ucomm.
    WHEN 'CLEARING'.
      PERFORM clearing_docu_validation.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form clear_docu
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clearing_docu_validation .

  DATA: lt_rows             TYPE lvc_t_row,
        lt_selected_indices TYPE STANDARD TABLE OF sy-tabix,
        lv_total_selection  TYPE i,
        lv_index            TYPE sy-tabix,
        lv_selected_bpid    TYPE zc103fit0001-bp_id,
        lv_selected_belnr   TYPE zc103fit0001-belnr,
        lv_selected_gjahr   TYPE zc103fit0001-gjahr,
        lv_oldest_belnr     TYPE zc103fit0001-belnr,
        lv_oldest_gjahr     TYPE zc103fit0001-gjahr,
        lv_first_found      TYPE abap_bool VALUE abap_false,
        lv_sum_dmbtr        TYPE dmbtr,
        lv_target_amount    TYPE dmbtr,
        lv_excess_dmbtr     TYPE wrbtr,
        lv_answer,
        lv_new_belnr        TYPE zc103fit0001-belnr,
        lv_selected_waers   TYPE zc103fit0002-waers,
        lv_subrc            TYPE sy-subrc,
        lv_temp_dmbtr       TYPE zc103fit0002-wrbtr,
        lv_selected_wrbtr   TYPE wrbtr,
        lv_aught            TYPE zc103fit0001-augdt.

  IF                  gv_status = 'Y'.
    MESSAGE TEXT-e01 TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " 1. 선택된 행 가져오기
  CALL METHOD go_right_btm_alv->get_selected_rows
    IMPORTING
      et_index_rows = lt_rows.

  IF lt_rows IS INITIAL.
    MESSAGE TEXT-e02 TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " 2. 선택된 인덱스 수집
  LOOP AT lt_rows INTO DATA(ls_row).
    APPEND ls_row-index TO lt_selected_indices.
  ENDLOOP.

  SORT lt_selected_indices.

  " 3. 연속성 체크 (1번부터 빠짐없이 선택되었는지)
  lv_total_selection = lines( lt_selected_indices ).

  DO lv_total_selection TIMES.
    lv_index = sy-index.

    READ TABLE lt_selected_indices WITH TABLE KEY table_line = lv_index TRANSPORTING NO FIELDS.
    IF sy-subrc <> 0.
      MESSAGE TEXT-e03 TYPE 'S' DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.
  ENDDO.

  " 4. 선택된 BP_ID 가져오기
  READ TABLE gt_account INTO DATA(ls_selected_account) INDEX lt_selected_indices[ 1 ].
  IF sy-subrc <> 0.
    MESSAGE TEXT-e04 TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  lv_selected_bpid = ls_selected_account-bp_id.

  " 5. 이 BP에 대해 가장 오래된 미결건 BELNR 찾기
  LOOP AT gt_header INTO DATA(gs_header)
    WHERE bp_id = lv_selected_bpid
      AND bstat = 'A'. " 미결건만

    IF lv_first_found = abap_false.
      lv_oldest_gjahr = gs_header-gjahr.
      lv_oldest_belnr = gs_header-belnr.
      lv_oldest_gjahr = gs_header-gjahr.
      lv_first_found = abap_true.
    ELSE.
      " 먼저 GJAHR을 비교하고, 같으면 BELNR 비교
      IF gs_header-gjahr < lv_oldest_gjahr OR
         ( gs_header-gjahr = lv_oldest_gjahr AND gs_header-belnr < lv_oldest_belnr ).
        lv_oldest_gjahr = gs_header-gjahr.
        lv_oldest_belnr = gs_header-belnr.
      ENDIF.
    ENDIF.
  ENDLOOP.

  " 6. 선택된 전표의 BELNR 가져오기
  READ TABLE gt_item INTO DATA(ls_item) INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE TEXT-e05 TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  IF ls_item-waers = 'USD' AND lines( lt_selected_indices ) > 1.
    MESSAGE 'USD는 완전반제임으로, 하나의 건만 선택 가능합니다' TYPE 'E'.
    RETURN.
  ENDIF.

  lv_selected_belnr = ls_item-belnr. " BELNR 가져오기
  lv_selected_gjahr = ls_item-gjahr.
  lv_selected_waers = ls_item-waers.
  lv_selected_wrbtr = ls_item-wrbtr.

  " 7. 제일 오래된 미결건인지 확인
  IF lv_selected_belnr > lv_oldest_belnr. " BELNR 비교
    MESSAGE TEXT-e06 TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " 8. 선택된 입금합계 vs 거래금액 비교
  CLEAR: lv_sum_dmbtr, lv_target_amount, lv_subrc.

  " 8-1. 선택된 입금 내역 wrbtr 합계
  LOOP AT lt_selected_indices INTO lv_index.
    READ TABLE gt_account INTO ls_selected_account INDEX lv_index.
    IF sy-subrc = 0.
      lv_sum_dmbtr = lv_sum_dmbtr + ls_selected_account-dmbtr.
    ENDIF.
  ENDLOOP.

  " 8-2. 거래금액 = GT_ITEM 전체의 WRBTR 합계
  CLEAR lv_target_amount.

  LOOP AT gt_item INTO ls_item.
    lv_target_amount = lv_target_amount + ls_item-dmbtr.
  ENDLOOP.

  READ TABLE gt_item INTO ls_item INDEX 1.

  CASE ls_item-waers.
    WHEN 'KRW'.

      " 8-3. 비교
      IF lv_sum_dmbtr > lv_target_amount.
        MESSAGE TEXT-e07 TYPE 'S' DISPLAY LIKE 'E'.
        lv_excess_dmbtr = lv_sum_dmbtr - lv_target_amount.
      ELSE.
        CALL FUNCTION 'ZC1F030001'
          EXPORTING
            iv_action = '반제처리'
          IMPORTING
            ev_answer = lv_answer.

        IF lv_answer = '2'.
          RETURN.
        ENDIF.

        PERFORM clearing_docu_krw USING lv_selected_belnr lv_selected_gjahr lv_selected_bpid CHANGING lv_new_belnr lv_subrc.
      ENDIF.

    WHEN 'USD'.
      "USD는 부분반제가 없기 때문에 위쪽의 유효검증이 끝났다면 바로 반제 처리가 가능함.
      CALL FUNCTION 'ZC1F030001'
        EXPORTING
          iv_action = '반제처리'
        IMPORTING
          ev_answer = lv_answer.

      IF lv_answer = '2'.
        RETURN.

      ENDIF.

      PERFORM clearing_docu_usd USING lv_selected_belnr lv_selected_gjahr lv_selected_bpid
                                      lv_sum_dmbtr lv_target_amount lv_selected_waers CHANGING lv_new_belnr lv_subrc.
    WHEN OTHERS.
  ENDCASE.

  "미결 잔액이 0이 된다면 완결로 변경
  IF lv_subrc <> 4.
    CLEAR lv_target_amount.

    LOOP AT gt_item INTO ls_item.
      lv_target_amount = lv_target_amount + ls_item-dmbtr.
    ENDLOOP.

    IF lv_target_amount = 0 OR ls_item-waers = 'USD'.
      UPDATE zc103fit0001
      SET bstat = 'B'
          augbl = lv_new_belnr
          augdt = sy-datum
          aedat = sy-datum
          aenam = sy-uname
          aezet = sy-uzeit
      WHERE belnr = lv_selected_belnr
        AND gjahr = lv_selected_gjahr.
      IF sy-subrc = 0.
        COMMIT WORK.
        .
        IF sy-subrc <> 0.
* Implement suitable error handling here
        ENDIF.

        PERFORM get_data USING : ''.
        PERFORM set_header.
        PERFORM get_item_bank_data USING: lv_selected_gjahr lv_selected_belnr lv_selected_bpid abap_false.
        PERFORM refresh_data.

        CALL FUNCTION 'ZFMC103SD_CHANGE_STATUS'
          EXPORTING
            iv_gjahr        = lv_selected_gjahr
            iv_belnr        = lv_selected_belnr
            iv_payment_date = sy-datum.

*-- ALV에서 일어난 이벤트이기에 PBO로 안감. 그래서 강제로 스크린 이벤트 발생
        CALL METHOD cl_gui_cfw=>set_new_ok_code
          EXPORTING
            new_code = 'ENTER'.
        MESSAGE TEXT-s01 TYPE 'I'.
      ELSE.
        ROLLBACK WORK.
        MESSAGE '전표 상태 변경 실패' TYPE 'E'.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form text_editor
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM text_editor .

  DATA: lv_result         TYPE string.

  CALL FUNCTION 'ZC103PMFG0003'
    IMPORTING
      ev_text   = lv_result
    EXCEPTIONS
      cancelled = 1
      OTHERS    = 2.

  IF sy-subrc = 0.
    WRITE: / '입력된 텍스트:', lv_result.
  ELSE.
    WRITE: / '사용자가 취소했습니다.'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_pay_deposit_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_pay_deposit_fcat USING pv_key pv_field pv_table pv_just pv_emph.

  CLEAR: gs_fcat3.

  gs_fcat3-key       = pv_key.
  gs_fcat3-fieldname = pv_field.
  gs_fcat3-ref_table = pv_table.
  gs_fcat3-just      = pv_just.
  gs_fcat3-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'BANK_DATE'.
      gs_fcat3-coltext = '날짜'.
    WHEN 'DMBTR'.
      gs_fcat3-coltext = '현지통화'.
      gs_fcat3-cfieldname = 'K_WAERS'.
    WHEN 'WRBTR'.
      gs_fcat3-coltext = '전표통화'.
      gs_fcat3-cfieldname = 'WAERS'.
    WHEN 'WAERS'.
      gs_fcat3-coltext = '전표통화키'.
    WHEN 'BANKNAME'.
      gs_fcat3-coltext = '거래은행명'.
    WHEN 'BANKDATE'.
      gs_fcat3-coltext = '출금일자'.
    WHEN 'K_WAERS'.
      gs_fcat3-coltext = '현지통화키'.
  ENDCASE.

  APPEND gs_fcat3 TO gt_fcat3.
  CLEAR gs_fcat3.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form add_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LR_DD_TABLE
*&      --> COL_FIELD
*&      --> COL_VALUE
*&      --> P_
*&---------------------------------------------------------------------*
FORM add_row  USING pr_dd_table  TYPE REF TO cl_dd_table_element
                    pv_col_field TYPE REF TO cl_dd_area
                    pv_col_value TYPE REF TO cl_dd_area
                    pv_field
                    pv_text.

  DATA : lv_text TYPE sdydo_text_element.

*-- Field.
  lv_text = pv_field.

  CALL METHOD pv_col_field->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>strong
      sap_color    = cl_dd_document=>list_heading_inv.

  CALL METHOD pv_col_field->add_gap
    EXPORTING
      width = 3.

*-- Value.
  lv_text = pv_text.

  CALL METHOD pv_col_value->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>heading
      sap_color    = cl_dd_document=>list_negative_inv.

  CALL METHOD pv_col_value->add_gap
    EXPORTING
      width = 3.

  CALL METHOD pr_dd_table->new_row.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_data USING : pv_bpid.

  DATA : lv_cnt TYPE i.

  CASE gv_check.
    WHEN ' '.
      CASE pv_bpid.
        WHEN ''.
          IF pa_pay = 'X'.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
                   stblg stjah reversal_date attach_id type_id cat_id reversal_bool
                   erdat erzet ernam aedat aezet aenam augbl augdt
              INTO CORRESPONDING FIELDS OF TABLE gt_header
              FROM zc103fit0001
              WHERE blart = 'KR'
              AND   budat IN so_budt
              AND stblg = ''
              ORDER BY gjahr belnr.
          ELSE.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
               stblg stjah reversal_date attach_id type_id cat_id reversal_bool
               erdat erzet ernam aedat aezet aenam augbl augdt
          INTO CORRESPONDING FIELDS OF TABLE gt_header
          FROM zc103fit0001
          WHERE blart = 'DR'
          AND   budat IN so_budt
          AND stblg = ''
          ORDER BY gjahr belnr.
          ENDIF.
        WHEN OTHERS.
          IF pa_pay = 'X'.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
                   stblg stjah reversal_date attach_id type_id cat_id reversal_bool
                   erdat erzet ernam aedat aezet aenam augbl augdt
              INTO CORRESPONDING FIELDS OF TABLE gt_header
              FROM zc103fit0001
              WHERE blart = 'KR'
              AND   budat IN so_budt
              AND stblg = ''
              AND bp_id = pv_bpid
              ORDER BY gjahr belnr.
          ELSE.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
               stblg stjah reversal_date attach_id type_id cat_id reversal_bool
               erdat erzet ernam aedat aezet aenam augbl augdt
          INTO CORRESPONDING FIELDS OF TABLE gt_header
          FROM zc103fit0001
          WHERE blart = 'DR'
          AND   budat IN so_budt
          AND stblg = ''
              AND bp_id = pv_bpid
          ORDER BY gjahr belnr.
          ENDIF.
      ENDCASE.
    WHEN 'X'.
      CASE pv_bpid.
        WHEN ''.
          IF pa_pay = 'X'.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
                   stblg stjah reversal_date attach_id type_id cat_id reversal_bool
                   erdat erzet ernam aedat aezet aenam augbl augdt
              INTO CORRESPONDING FIELDS OF TABLE gt_header
              FROM zc103fit0001
              WHERE blart = 'KR'
              AND   budat IN so_budt
              AND stblg = ''
              AND bstat = 'A'
            ORDER BY gjahr belnr.
          ELSE.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
               stblg stjah reversal_date attach_id type_id cat_id reversal_bool
               erdat erzet ernam aedat aezet aenam augbl augdt
          INTO CORRESPONDING FIELDS OF TABLE gt_header
          FROM zc103fit0001
          WHERE blart = 'DR'
          AND   budat IN so_budt
          AND stblg = ''
          AND bstat = 'A'
            ORDER BY gjahr belnr.
          ENDIF.
        WHEN OTHERS.
          IF pa_pay = 'X'.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
                   stblg stjah reversal_date attach_id type_id cat_id reversal_bool
                   erdat erzet ernam aedat aezet aenam augbl augdt
              INTO CORRESPONDING FIELDS OF TABLE gt_header
              FROM zc103fit0001
              WHERE blart = 'KR'
              AND   budat IN so_budt
              AND stblg = ''
              AND bp_id = pv_bpid
              AND bstat = 'A'
            ORDER BY gjahr belnr.
          ELSE.
            SELECT bp_id bp_name usname bukrs belnr gjahr bldat blart budat waers bktxt mblnr bstat uscode
               stblg stjah reversal_date attach_id type_id cat_id reversal_bool
               erdat erzet ernam aedat aezet aenam augbl augdt
          INTO CORRESPONDING FIELDS OF TABLE gt_header
          FROM zc103fit0001
          WHERE blart = 'DR'
          AND   budat IN so_budt
          AND stblg = ''
              AND bp_id = pv_bpid
              AND bstat = 'A'
            ORDER BY gjahr belnr.
          ENDIF.
      ENDCASE.
    WHEN OTHERS.
  ENDCASE.

  " 임시전표는 보여주지 않아야함.
  DELETE gt_header WHERE bstat = 'C' OR bstat = ''.

  LOOP AT gt_header INTO gs_header.
    IF gs_header-bp_id IS INITIAL.
      gs_header-bp_id = 'CD000001'.
      gs_header-bp_name = '신한카드'.
      MODIFY gt_header FROM gs_header INDEX sy-tabix.
    ENDIF.
  ENDLOOP.

*--총 몇건의 데이터가 조회되었다
  lv_cnt = lines( gt_header ).
  MESSAGE s008 WITH lv_cnt.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_header
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_header.

*-- 미결/완결 건수 변수로 담기.
  gv_none_cnt = 0.
  gv_finish_cnt = 0.

  LOOP AT gt_header INTO gs_header.
    IF gs_header-bstat = 'A'.
      gs_header-status = icon_led_yellow.
      gv_none_cnt += 1.
    ELSEIF gs_header-bstat = 'B'.
      gs_header-status = icon_led_green.
      gv_finish_cnt += 1.
    ENDIF.
    MODIFY gt_header FROM gs_header INDEX sy-tabix TRANSPORTING status.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form search_bp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM search_bp .

  IF gv_search_bp = 'CD000001'.
    PERFORM get_data USING ''.
    DELETE gt_header WHERE bp_id <> 'CD000001'.
  ELSE.
    PERFORM get_data USING gv_search_bp.
  ENDIF.

  IF gt_header IS INITIAL.
    MESSAGE '데이터가 존재하지 않습니다.' TYPE 'S' DISPLAY LIKE 'E'.
  ELSE.
    PERFORM set_header.
    PERFORM remove_item_bank_data.
    PERFORM refresh_data.
    gv_search = gv_search_bp.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form remove_item_bank_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM remove_item_bank_data .

  CLEAR: gt_item, gt_account.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_item_bank_data_temp_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_item_bank_data USING: pv_gjahr pv_belnr pv_bpcode pv_init.

  IF pv_gjahr IS INITIAL.
    RETURN.
  ENDIF.

  IF pa_pay = 'X'.
    SELECT bukrs belnr gjahr buzei bldat blart budat sgtxt uscode type_id cat_id
         bschl koart shkzg hkont wrbtr dmbtr waers mwskz hwbas mwsts zuonr augbl
         augdt obelnr anln1 matnr werks erdat erzet ernam
         aedat aezet aenam usname
      INTO CORRESPONDING FIELDS OF TABLE gt_item
        FROM zc103fit0002
        WHERE bukrs = '0001'
        AND   belnr = pv_belnr
        AND   gjahr = pv_gjahr
        AND   shkzg = 'S'
      ORDER BY buzei.
  ELSE.
    SELECT bukrs belnr gjahr buzei bldat blart budat sgtxt uscode type_id cat_id
     bschl koart shkzg hkont wrbtr dmbtr waers mwskz hwbas mwsts zuonr augbl
     augdt obelnr anln1 matnr werks erdat erzet ernam
     aedat aezet aenam usname
      INTO CORRESPONDING FIELDS OF TABLE gt_item
      FROM zc103fit0002
      WHERE bukrs = '0001'
      AND   belnr = pv_belnr
      AND   gjahr = pv_gjahr
      AND   shkzg = 'H'
      ORDER BY buzei.
  ENDIF.

  IF pv_init = abap_false.
    IF sy-subrc <> 0.
      MESSAGE '해당 전표에 대한 아이템이 없습니다.' TYPE 'I'.
    ENDIF.
  ENDIF.

  CASE pa_pay.
    WHEN 'X'. "매입미결전표 , 입금내역 보여줘야함.

      SELECT deal_id deal_type bp_id wrbtr waers
     bank_name bank_date belnr erdat erzet ernam aedat aezet aenam dmbtr
    INTO CORRESPONDING FIELDS OF TABLE gt_account
    FROM zc103fit0020
    WHERE bp_id = pv_bpcode
      AND belnr = ''
      AND deal_type = '02'
    ORDER BY bank_date.

    WHEN OTHERS.

      SELECT deal_id deal_type bp_id wrbtr waers
      bank_name bank_date belnr erdat erzet ernam aedat aezet aenam dmbtr
      INTO CORRESPONDING FIELDS OF TABLE gt_account
      FROM zc103fit0020
      WHERE bp_id = pv_bpcode
      AND belnr = ''
      AND deal_type = '01'
      ORDER BY bank_date.

  ENDCASE.

  READ TABLE gt_header INTO gs_header WITH KEY gjahr = pv_gjahr belnr = pv_belnr.

  LOOP AT gt_item INTO gs_item.
    IF gs_header-bstat = 'A'.
      gs_item-status = icon_led_yellow.
    ELSE.
      gs_item-status = icon_led_green.
    ENDIF.
    gs_item-k_waers = 'KRW'.
    MODIFY gt_item FROM gs_item INDEX sy-tabix TRANSPORTING status k_waers.
  ENDLOOP.

*-- 반제 전표 가져와서 append시키기
  CLEAR: gt_item_temp, gs_item_temp.

  IF pa_pay = 'X'.
    SELECT bukrs belnr gjahr buzei bldat blart budat sgtxt uscode type_id cat_id
         bschl koart shkzg hkont wrbtr dmbtr waers mwskz hwbas mwsts zuonr augbl
         augdt obelnr anln1 matnr werks erdat erzet ernam usname
         aedat aezet aenam
      INTO CORRESPONDING FIELDS OF TABLE gt_item_temp
        FROM zc103fit0002
        WHERE obelnr = gv_belnr
*        AND   shkzg = 'H'
      ORDER BY buzei.
  ELSE.
    SELECT bukrs belnr gjahr buzei bldat blart budat sgtxt uscode type_id cat_id
     bschl koart shkzg hkont wrbtr dmbtr waers mwskz hwbas mwsts zuonr augbl
     augdt obelnr anln1 matnr werks erdat erzet ernam usname
     aedat aezet aenam
      INTO CORRESPONDING FIELDS OF TABLE gt_item_temp
      FROM zc103fit0002
      WHERE obelnr = gv_belnr
*      AND   shkzg = 'S'
      ORDER BY buzei.
  ENDIF.

*  DELETE gt_item_temp WHERE augdt(4) <> pv_gjahr.

  LOOP AT gt_item_temp INTO gs_item_temp.
    IF pa_pay = 'X'.
      IF gs_item_temp-hkont = '200001' AND gs_item_temp-shkzg = 'S'.
        CONTINUE.
      ENDIF.
      IF gs_item_temp-shkzg = 'H'.
        gs_item_temp-dmbtr = gs_item_temp-dmbtr * -1.
        gs_item_temp-wrbtr = gs_item_temp-wrbtr * -1.
      ENDIF.
    ELSE.
      IF gs_item_temp-hkont = '100004' AND gs_item_temp-shkzg = 'H'.
        CONTINUE.
      ENDIF.
      IF gs_item_temp-shkzg = 'S'.
        gs_item_temp-dmbtr = gs_item_temp-dmbtr * -1.
        gs_item_temp-wrbtr = gs_item_temp-wrbtr * -1.
      ENDIF.
    ENDIF.
    gs_item_temp-k_waers = 'KRW'.
    APPEND gs_item_temp TO gt_item.
  ENDLOOP.

  LOOP AT gt_account INTO gs_account.
    gs_account-k_waers = 'KRW'.
    MODIFY gt_account FROM gs_account INDEX sy-tabix TRANSPORTING k_waers.
  ENDLOOP.

  PERFORM set_gl_name.
  PERFORM make_display_item_color .

ENDFORM.
*&---------------------------------------------------------------------*
*& Form clear_search
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clear_search .

  CLEAR gv_search_bp.
  PERFORM get_data USING : ''.
  PERFORM set_header.
  CLEAR: gt_item, gt_account.
  PERFORM refresh_data.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form clearing_docu
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clearing_docu_krw USING pv_selected_belnr pv_selected_gjahr pv_selected_bpid CHANGING pv_new_belnr pv_subrc.

  DATA: lt_rows             TYPE lvc_t_row,
        lt_selected_indices TYPE STANDARD TABLE OF sy-tabix,
        lv_total_selection  TYPE i,
        lv_index            TYPE sy-tabix,
        gs_header           TYPE zc103fit0001,
        ls_item1            TYPE zc103fit0002, "외상매입금
        ls_item2            TYPE zc103fit0002, "보통예금
        lv_uscode           TYPE zc103fit0002-uscode,
        lv_usname           TYPE zc103fit0002-usname,
        lv_bp_name          TYPE zc103fit0001-bp_name.

  " 1. 선택된 행 가져오기
  CALL METHOD go_right_btm_alv->get_selected_rows
    IMPORTING
      et_index_rows = lt_rows.

  " 2. 선택된 인덱스 수집
  LOOP AT lt_rows INTO DATA(ls_row).
    APPEND ls_row-index TO lt_selected_indices.
  ENDLOOP.

  CLEAR: gs_header, ls_item1,ls_item2, pv_new_belnr.

  CALL FUNCTION 'ZC103PMFG0005'
    IMPORTING
      empno   = lv_uscode
      empname = lv_usname.

  IF sy-subrc <> 0.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  IF lv_uscode IS INITIAL.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "3. 선택된 인덱스의 값들을 돌면서 반제 로직 실행.
  LOOP AT lt_selected_indices INTO lv_index.
    READ TABLE gt_account INTO DATA(ls_selected_account) INDEX lv_index.
    IF sy-subrc = 0.

      " 전표번호 채번
      CALL FUNCTION 'NUMBER_GET_NEXT'
        EXPORTING
          nr_range_nr             = '01'     " 위에서 지정한 No
          object                  = 'ZC103FIZR'
        IMPORTING
          number                  = pv_new_belnr
        EXCEPTIONS
          interval_not_found      = 1
          number_range_not_intern = 2
          object_not_found        = 3
          quantity_is_0           = 4
          quantity_is_not_1       = 5
          interval_overflow       = 6
          buffer_overflow         = 7
          OTHERS                  = 8.
      IF sy-subrc <> 0.
        MESSAGE TEXT-e08 TYPE 'S' DISPLAY LIKE 'E'.
        RETURN.
      ENDIF.

      "1. 헤더 만들기

      READ TABLE gt_header INTO DATA(ls_header)
           WITH KEY belnr = pv_selected_belnr
                    gjahr = pv_selected_gjahr.

      IF sy-subrc = 0.
        lv_bp_name = ls_header-bp_name.
      ENDIF.

      gs_header-bukrs = '0001'.
      gs_header-belnr = pv_new_belnr.
      gs_header-gjahr = sy-datum(4).
      gs_header-bldat = sy-datum.
      gs_header-blart = 'ZR'.
      gs_header-budat = ls_selected_account-bank_date.
      gs_header-waers = 'KRW'.
      gs_header-bktxt = '계좌처리된 반제건입니다.'.
*-- TODO: 상균이 데이터 됬다하면 연결시켜보기.
      gs_header-mblnr = ''.
      gs_header-bstat = 'B'.
      gs_header-uscode = lv_uscode.
      "USNAM세팅해주기.
      gs_header-usname = lv_usname.
      gs_header-bp_id = ls_selected_account-bp_id.
      gs_header-bp_name = lv_bp_name.
      gs_header-augbl = pv_selected_belnr.
      gs_header-augdt = sy-datum.
      " 타임스탬프
      gs_header-erdat = sy-datum.
      gs_header-ernam = sy-uname.
      gs_header-erzet = sy-uzeit.
      gs_header-aedat = sy-datum.
      gs_header-aenam = sy-uname.
      gs_header-aezet = sy-uzeit.

      "2. 아이템 세팅하기.
      "공통코드
      ls_item1-k_waers = 'KRW'.
      ls_item1-bukrs = gs_header-bukrs.
      ls_item1-belnr = gs_header-belnr.
      ls_item1-gjahr = gs_header-gjahr.
      ls_item1-bldat = gs_header-bldat.
      ls_item1-blart = gs_header-blart.
      ls_item1-budat = gs_header-budat.
      ls_item1-uscode = sy-uname.
      ls_item1-wrbtr = ls_selected_account-wrbtr.
      ls_item1-dmbtr = ls_selected_account-dmbtr.
      ls_item1-waers = ls_selected_account-waers.
      ls_item1-bp_id = ls_selected_account-bp_id.
      ls_item1-bp_name = lv_bp_name.
      "타임스탬프
      ls_item1-erdat = sy-datum.
      ls_item1-ernam = sy-uname.
      ls_item1-erzet = sy-uzeit.
      ls_item1-aedat = sy-datum.
      ls_item1-aenam = sy-uname.
      ls_item1-aezet = sy-uzeit.

      READ TABLE gt_11 INTO gs_11 WITH KEY ernam = gs_header-uscode.
      IF sy-subrc = 0.
        ls_item1-usname = gs_11-empname.
      ELSE.
        ls_item1-usname = ''.
      ENDIF.

      "여기는 외상매입금/외상매출금(item1만 해당) +하려했으나, 반제를 아이템 밑에 보여줘야해서 둘다처리
      ls_item1-obelnr = pv_selected_belnr. "원전표번호
      ls_item1-augdt = gs_header-augdt.
      ls_item1-uscode = lv_uscode.
      ls_item1-usname = lv_usname.
      ls_item2 = ls_item1.
      ls_item2-hkont = '100002'.
      ls_item1-koart = 'S'.

      IF pa_pay = 'X'. "매입채무
        "item1: 외상매입금
        ls_item1-buzei = 1.
        ls_item1-sgtxt = '계좌이체완료'.
        ls_item1-bschl = 21.
        ls_item1-koart = 'K'.
        ls_item1-shkzg = 'S'.
        ls_item1-hkont = '200001'.


        "item2: 보통예금
        ls_item2-buzei = 2.
        ls_item2-bschl = 50.
        ls_item2-shkzg = 'H'.


      ELSE. "매출채권
        "item1: 외상매출금
        ls_item1-buzei = 2.
        ls_item1-sgtxt = '계좌입금확인'.
        ls_item1-bschl = 11.
        ls_item1-koart = 'D'.
        ls_item1-shkzg = 'H'.
        ls_item1-hkont = '100004'.

        "item2: 보통예금
        ls_item2-buzei = 1.
        ls_item2-bschl = 40.
        ls_item2-shkzg = 'S'.

      ENDIF.


      "append시키기
      INSERT zc103fit0001 FROM gs_header.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE TEXT-e09 TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        EXIT.
      ENDIF.

      INSERT zc103fit0002 FROM ls_item1.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE 'Item1 insert failed' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        EXIT.
      ENDIF.

      INSERT zc103fit0002 FROM ls_item2.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE 'Item2 insert failed' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        EXIT.
      ENDIF.

      ls_selected_account-belnr = pv_new_belnr.
      UPDATE zc103fit0020 FROM ls_selected_account.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE '은행내역의 체결 전환에 실패했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        EXIT.
      ENDIF.

      COMMIT WORK.

    ENDIF.
  ENDLOOP.

  PERFORM get_item_bank_data USING: pv_selected_gjahr pv_selected_belnr pv_selected_bpid abap_false.
  PERFORM refresh_data.
  MESSAGE '반제 처리 완료.' TYPE 'S'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form make_display_item_color
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM make_display_item_color .

  DATA : lv_tabix TYPE sy-tabix,
         ls_scol  TYPE lvc_s_scol.
*         ls_scol  TYPE LINE OF lvc_t_scol.

  LOOP AT gt_item INTO gs_item.

    lv_tabix = sy-tabix.

    CLEAR : ls_scol, gs_item-color. " Clear the Color manager
    CASE gs_item-belnr.
      WHEN gv_belnr.
*  -- Set color
        ls_scol-color-col = 5.  " Color value
        ls_scol-nokeycol  = abap_true.
        INSERT ls_scol INTO TABLE gs_item-color.
        MODIFY gt_item FROM gs_item INDEX lv_tabix
                                 TRANSPORTING color.
    ENDCASE.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_gl_name
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_gl_name .

  SELECT saknr txt50
    INTO CORRESPONDING FIELDS OF TABLE gt_gl
    FROM zc103fit0003.

  LOOP AT gt_item INTO gs_item.
    READ TABLE gt_gl INTO DATA(ls_gl) WITH KEY saknr = gs_item-hkont.
    IF sy-subrc = 0.
      gs_item-gl_name = ls_gl-txt50.
    ENDIF.
    MODIFY gt_item FROM gs_item.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form clearing_docu_usd
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_SELECTED_BELNR
*&      --> LV_SELECTED_GJAHR
*&      --> LV_SELECTED_BPID
*&      <-- LV_NEW_BELNR
*&---------------------------------------------------------------------*
FORM clearing_docu_usd  USING pv_selected_belnr pv_selected_gjahr pv_selected_bpid
                              pv_account_amount pv_deal_amount pv_waers CHANGING pv_new_belnr pv_subrc.

  DATA: lt_rows             TYPE lvc_t_row,
        lt_selected_indices TYPE STANDARD TABLE OF sy-tabix,
        lv_total_selection  TYPE i,
        lv_index            TYPE sy-tabix,
        ls_item1            TYPE zc103fit0002, "외상매입금
        ls_item2            TYPE zc103fit0002, "보통예금
        ls_item3            TYPE zc103fit0002,
        lv_case             TYPE i,
        lv_differ           TYPE dmbtr,
        lv_uscode           TYPE zc103fit0002-uscode,
        lv_usname           TYPE zc103fit0002-usname,
        lv_bp_name          TYPE zc103fit0001-bp_name,
        ls_item_db          TYPE zc103fit0002.

  " 1. 선택된 행 가져오기
  CALL METHOD go_right_btm_alv->get_selected_rows
    IMPORTING
      et_index_rows = lt_rows.

  " 2. 선택된 인덱스 수집
  LOOP AT lt_rows INTO DATA(ls_row).
    APPEND ls_row-index TO lt_selected_indices.
  ENDLOOP.

  CLEAR: gs_header, ls_item1,ls_item2, pv_new_belnr, ls_item3.

  CALL FUNCTION 'ZC103PMFG0005'
    IMPORTING
      empno   = lv_uscode
      empname = lv_usname.

  IF sy-subrc <> 0.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  IF lv_uscode IS INITIAL.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "3. 선택된 인덱스의 값들을 돌면서 반제 로직 실행.
  LOOP AT lt_selected_indices INTO lv_index.
    READ TABLE gt_account INTO DATA(ls_selected_account) INDEX lv_index.
    IF sy-subrc = 0.

      " 전표번호 채번
      CALL FUNCTION 'NUMBER_GET_NEXT'
        EXPORTING
          nr_range_nr             = '01'     " 위에서 지정한 No
          object                  = 'ZC103FIZR'
        IMPORTING
          number                  = pv_new_belnr
        EXCEPTIONS
          interval_not_found      = 1
          number_range_not_intern = 2
          object_not_found        = 3
          quantity_is_0           = 4
          quantity_is_not_1       = 5
          interval_overflow       = 6
          buffer_overflow         = 7
          OTHERS                  = 8.
      IF sy-subrc <> 0.
        MESSAGE TEXT-e08 TYPE 'S' DISPLAY LIKE 'E'.
        RETURN.
      ENDIF.

      "1. 헤더 만들기
      READ TABLE gt_header INTO DATA(ls_header)
           WITH KEY belnr = pv_selected_belnr
                    gjahr = pv_selected_gjahr.

      IF sy-subrc = 0.
        lv_bp_name = ls_header-bp_name.
      ENDIF.

      gs_header-bukrs = '0001'.
      gs_header-belnr = pv_new_belnr.
      gs_header-gjahr = sy-datum(4).
      gs_header-bldat = sy-datum.
      gs_header-blart = 'ZR'.
      gs_header-budat = ls_selected_account-bank_date.
      gs_header-waers = 'KRW'.
      gs_header-bktxt = '계좌처리된 반제건입니다.'.
      gs_header-mblnr = ''.
      gs_header-bstat = 'B'.
      gs_header-bp_id = ls_selected_account-bp_id.
      gs_header-bp_name = lv_bp_name.
      gs_header-augbl = pv_selected_belnr.
      gs_header-augdt = sy-datum.
      " 타임스탬프
      gs_header-erdat = sy-datum.
      gs_header-ernam = sy-uname.
      gs_header-erzet = sy-uzeit.
      gs_header-aedat = sy-datum.
      gs_header-aenam = sy-uname.
      gs_header-aezet = sy-uzeit.
      gs_header-uscode = lv_uscode.
      gs_header-usname = lv_usname.
      "2. 아이템 세팅하기.
      "공통코드
      ls_item1-k_waers = 'KRW'.
      ls_item1-bukrs = gs_header-bukrs.
      ls_item1-belnr = gs_header-belnr.
      ls_item1-gjahr = gs_header-gjahr.
      ls_item1-bldat = gs_header-bldat.
      ls_item1-blart = gs_header-blart.
      ls_item1-budat = gs_header-budat.
      ls_item1-uscode = sy-uname.
      ls_item1-wrbtr = ls_selected_account-wrbtr. "KRW기준! (USD는 따로 분기처리해야함)
      ls_item1-waers = ls_selected_account-waers.
      ls_item1-dmbtr = pv_deal_amount.
      ls_item1-uscode = lv_uscode.
      ls_item1-usname = lv_usname.
      ls_item1-bp_id = ls_selected_account-bp_id.
      ls_item1-bp_name = lv_bp_name.
      "타임스탬프
      ls_item1-erdat = sy-datum.
      ls_item1-ernam = sy-uname.
      ls_item1-erzet = sy-uzeit.
      ls_item1-aedat = sy-datum.
      ls_item1-aenam = sy-uname.
      ls_item1-aezet = sy-uzeit.

      READ TABLE gt_11 INTO gs_11 WITH KEY ernam = gs_header-uscode.
      IF sy-subrc = 0.
        ls_item1-usname = gs_11-empname.
      ELSE.
        ls_item1-usname = ''.
      ENDIF.

      "여기는 외상매입금/외상매출금(item1만 해당) +하려했으나, 반제를 아이템 밑에 보여줘야해서 둘다처리
      ls_item1-obelnr = pv_selected_belnr. "원전표번호
      ls_item1-augdt = gs_header-augdt.

      ls_item2 = ls_item1.
      ls_item3 = ls_item1. "외화차손, 외화차익
      ls_item2-hkont = '100002'.
      ls_item1-koart = 'S'.

      "8. 얘는 부분반제 없기 때문에 이때까지 가장 오래된미결건이였고, 첫번째 입금건이면 무조건 금액이 일치한다는 가정을 했었음.
      " 그렇기 떄문에 금액 차이가 나는건 무조건 외화차익/외화차손으로 처리.
      IF pa_pay = 'X'.
        IF pv_account_amount > pv_deal_amount. "은행 합이 더 많으면
          lv_case = 1.
          "매입채무 경우 "CASE 1: 더 많이 준거니까
          "( 외상매입금, 외화차손 / 보통예금 )

          lv_differ = pv_account_amount - pv_deal_amount.

          ls_item1-buzei = 1.
          ls_item1-sgtxt = '계좌이체완료'.
          ls_item1-bschl = 21.
          ls_item1-koart = 'K'.
          ls_item1-shkzg = 'S'.
          ls_item1-hkont = '200001'.


          "item2: 보통예금
          ls_item2-dmbtr = pv_account_amount.
          ls_item2-buzei = 2.
          ls_item2-bschl = 50.
          ls_item2-koart = 'S'.
          ls_item2-shkzg = 'H'.

          ls_item3-dmbtr = lv_differ.
          ls_item3-buzei = 3.
          ls_item3-bschl = 50.
          ls_item3-koart = 'S'.
          ls_item3-shkzg = 'S'.
          ls_item3-hkont = '500004'.
          ls_item3-wrbtr = 0.

        ELSEIF pv_account_amount < pv_deal_amount. "입금합이 적으면
          lv_case = 2.
          "매입채무 경우 "CASE 1: 더 적게 준거니까
          "( 외상매입금 / 보통예금, 외화차익 )

          lv_differ = pv_deal_amount - pv_account_amount.

          ls_item1-buzei = 1.
          ls_item1-sgtxt = '계좌이체완료'.
          ls_item1-bschl = 21.
          ls_item1-koart = 'K'.
          ls_item1-shkzg = 'S'.
          ls_item1-hkont = '200001'.


          "item2: 보통예금
          ls_item2-dmbtr = pv_account_amount.
          ls_item2-buzei = 2.
          ls_item2-bschl = 50.
          ls_item2-koart = 'S'.
          ls_item2-shkzg = 'H'.

          ls_item3-dmbtr = lv_differ.
          ls_item3-buzei = 3.
          ls_item3-bschl = 40.
          ls_item3-koart = 'S'.
          ls_item3-shkzg = 'H'.
          ls_item3-hkont = '400004'.
          ls_item3-wrbtr = 0.

        ELSE. "입금합과 같으면
          "매입채무 경우 "CASE 1
          "( 외상매입금 / 보통예금 )
          "item1: 외상매입금
          lv_case = 3.

          ls_item1-buzei = 1.
          ls_item1-sgtxt = '계좌이체완료'.
          ls_item1-bschl = 21.
          ls_item1-koart = 'K'.
          ls_item1-shkzg = 'S'.
          ls_item1-hkont = '200001'.

          "item2: 보통예금
          ls_item2-buzei = 2.
          ls_item2-bschl = 50.
          ls_item2-shkzg = 'H'.
        ENDIF.
      ELSE.
        IF pv_account_amount > pv_deal_amount. "은행 합이 더 많으면
          "매출채권일 경우 CASE 2: 더 많이 받은거니까
          "(보통예금 / 외상매출금, 외화차익)
          lv_case = 4.
          lv_differ = pv_account_amount - pv_deal_amount.
          ls_item1-buzei = 1.
          ls_item1-sgtxt = '계좌입금확인'.
          ls_item1-bschl = 11.
          ls_item1-koart = 'D'.
          ls_item1-shkzg = 'H'.
          ls_item1-hkont = '100004'.

          "item2: 보통예금
          ls_item2-dmbtr = pv_account_amount.
          ls_item2-buzei = 2.
          ls_item2-bschl = 40.
          ls_item2-koart = 'S'.
          ls_item2-shkzg = 'S'.

          ls_item3-dmbtr = lv_differ.
          ls_item3-buzei = 3.
          ls_item3-bschl = 50.
          ls_item3-koart = 'S'.
          ls_item3-shkzg = 'H'.
          ls_item3-hkont = '400004'.
          ls_item3-wrbtr = 0.

        ELSEIF pv_account_amount < pv_deal_amount. "입금합이 적으면
          "매출채권일 경우 CASE 2: 더 적게 받은거니까
          "(보통예금, 외화차손  / 외상매출금)
          lv_case = 5.

          lv_differ = pv_deal_amount - pv_account_amount.

          ls_item1-buzei = 1.
          ls_item1-sgtxt = '계좌입금확인'.
          ls_item1-bschl = 11.
          ls_item1-koart = 'D'.
          ls_item1-shkzg = 'H'.
          ls_item1-hkont = '100004'.


          "item2: 보통예금
          ls_item2-dmbtr = pv_account_amount.
          ls_item2-buzei = 2.
          ls_item2-bschl = 40.
          ls_item2-koart = 'S'.
          ls_item2-shkzg = 'S'.

          ls_item3-dmbtr = lv_differ.
          ls_item3-buzei = 3.
          ls_item3-bschl = 50.
          ls_item3-koart = 'S'.
          ls_item3-shkzg = 'S'.
          ls_item3-hkont = '500004'.
          ls_item3-wrbtr = 0.

        ELSE. "입금합과 같으면
          lv_case = 6.
          "매출채권일 경우 CASE 2
          "(보통예금  / 외상매출금)
          "item1: 외상매출금
          lv_case = 6.
          ls_item1-buzei = 2.
          ls_item1-sgtxt = '계좌입금확인'.
          ls_item1-bschl = 11.
          ls_item1-koart = 'D'.
          ls_item1-shkzg = 'H'.
          ls_item1-hkont = '100004'.

          "item2: 보통예금
          ls_item2-buzei = 1.
          ls_item2-bschl = 40.
          ls_item2-shkzg = 'S'.
        ENDIF.
      ENDIF.

      CLEAR gs_header_db.
      MOVE-CORRESPONDING gs_header TO gs_header_db.
      INSERT zc103fit0001 FROM gs_header_db.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE TEXT-e09 TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        RETURN.
      ENDIF.


      CLEAR ls_item_db.
      MOVE-CORRESPONDING ls_item1 TO ls_item_db.
      INSERT zc103fit0002 FROM ls_item_db.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE 'Item1 insert failed' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        RETURN.
      ENDIF.

      CLEAR ls_item_db.
      MOVE-CORRESPONDING ls_item2 TO ls_item_db.
      INSERT zc103fit0002 FROM ls_item_db.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE 'Item2 insert failed' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        RETURN.
      ENDIF.

      IF lv_case <> 3 AND lv_case <> 6.
        CLEAR ls_item_db.
        MOVE-CORRESPONDING ls_item3 TO ls_item_db.
        INSERT zc103fit0002 FROM ls_item_db.
        IF sy-subrc <> 0.
          ROLLBACK WORK.
          MESSAGE 'Item2 insert failed' TYPE 'S' DISPLAY LIKE 'E'.
          pv_subrc = 4.
          RETURN.
        ENDIF.
      ENDIF.

      ls_selected_account-belnr = pv_new_belnr.
      UPDATE zc103fit0020 FROM ls_selected_account.
      IF sy-subrc <> 0.
        ROLLBACK WORK.
        MESSAGE '은행내역의 체결 전환에 실패했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
        pv_subrc = 4.
        RETURN.
      ENDIF.

      COMMIT WORK.

    ENDIF.
  ENDLOOP.

  MESSAGE '반제 처리 완료.' TYPE 'S'.

  PERFORM get_data USING : ''.
  PERFORM set_header.
  PERFORM get_item_bank_data USING: pv_selected_gjahr pv_selected_belnr pv_selected_bpid abap_false.
  PERFORM refresh_data.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form toggle_check
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM toggle_check .

  PERFORM get_data USING gv_search.
  PERFORM set_header.
  PERFORM remove_item_bank_data.
  PERFORM refresh_data.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form layout_title
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM layout_title .

  gs_layout1-grid_title = '전표헤더'.
  gs_layout2-grid_title = '전표아이템'.
  IF pa_pay = 'X'.
    gs_layout3-grid_title = '은행출금내역'.
  ELSE.
    gs_layout3-grid_title = '은행입금내역'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_emp_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_emp_data .

  SELECT empname ernam
    INTO CORRESPONDING FIELDS OF TABLE gt_11
    FROM zc103fit0011.

ENDFORM.

----------------------------------------------------------------------------------
Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758

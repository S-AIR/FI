``` abap
*&---------------------------------------------------------------------*
*& Include          ZC103FIR0009F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen .

  IF go_tree IS NOT BOUND.

    PERFORM create_obj.
    PERFORM set_tree_header CHANGING gs_hierhdr.
    PERFORM build_comment USING gt_list_commentary gv_logo. " Top container(alv에 딸려있는 top cont)
    PERFORM define_field_catalog.
    PERFORM create_hierarchy.
    PERFORM fill_column_tree.

    SET HANDLER : lcl_event_handler=>top_of_page        FOR go_alv_grid. " Top of Page 클래스 실행

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form init_tree
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_obj .

  CREATE OBJECT go_container
    EXPORTING
      repid     = sy-repid
      dynnr     = sy-dynnr
      side      = go_container->dock_at_left
      extension = 5500.

  CREATE OBJECT go_tree
    EXPORTING
      parent              = go_container
      node_selection_mode = cl_gui_column_tree=>node_sel_mode_multiple
      item_selection      = 'X'.
*      no_html_header      = 'X'.

  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = go_container.

* Create TOP-Document
  CREATE OBJECT go_dyndoc_id
    EXPORTING
      style = 'ALV_GRID'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form define_hierarchy_header
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- GS_HIERHDR
*&---------------------------------------------------------------------*
FORM set_tree_header  CHANGING pv_hierhdr TYPE treev_hhdr.

  pv_hierhdr-heading = '손익계산서'.
  pv_hierhdr-tooltip = 'Treasure partner group'.
  pv_hierhdr-width = 50.
  pv_hierhdr-width_pix = space.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form build_comment
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GT_LIST_COMMENTARY
*&      --> GV_LOGO
*&---------------------------------------------------------------------*
FORM build_comment  USING pt_list_commentary TYPE slis_t_listheader
                          pv_logo            TYPE sdydo_value.

  DATA: ls_line TYPE slis_listheader.

  CLEAR ls_line.
  ls_line-typ = 'H'. " High font
  ls_line-info = '(주) S-AIR 손익계산서'.
  APPEND ls_line TO pt_list_commentary.

  CLEAR ls_line.
  ls_line-typ = 'S'. " Small font
  ls_line-key = '회사코드 : '.
  ls_line-info = pa_bukrs.
  APPEND ls_line TO pt_list_commentary.

  CLEAR ls_line.
  ls_line-typ = 'S'. " Small font
  ls_line-key = '조회기간 : '.
  ls_line-info = pa_gjahr && '년 ' && |{ pa_qua }| && '분기'.
  APPEND ls_line TO pt_list_commentary.

  pv_logo = 'ENJOYSAP_LOGO'.
  gs_variant-report = sy-repid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form define_field_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM define_field_catalog .

  CLEAR : gt_fcat, gs_fcat.
  PERFORM set_field_catalog USING :
                                    'PREV_AMT'   'ZC103FIT0002'  '전기금액' ' ',
                                    'PREV_CURR'  'ZC103FIT0002'  '통화'    ' ',
                                    'CURR_AMT'   'ZC103FIT0002'  '당기금액' ' ',
                                    'CURR_CURR'  'ZC103FIT0002'  '통화'    ' ',
                                    'PERCENTAGE' ' '  '변동률(%)'    ' '.

*-- Set layout
  gs_layout-ctab_fname = 'CELLCOLOR'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_hierarchy
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM  create_hierarchy .

*-- top of page 출력하는 메소드
  CALL METHOD go_tree->set_table_for_first_display
    EXPORTING
      is_variant          = gs_variant
      i_save              = 'A'
      i_default           = 'X'
      is_hierarchy_header = gs_hierhdr
      it_list_commentary  = gt_list_commentary
      i_logo              = 'SLOGO1'
      i_background_id     = 'SBACK1'
    CHANGING
      it_outtab           = gt_top
      it_fieldcatalog     = gt_fcat.

*--register item_cxt_menu_request------------------------------------*.
  SET HANDLER : lcl_event_handler=>on_item_cxt_menu_request  FOR go_tree,
                lcl_event_handler=>on_item_cxt_menu_selected FOR go_tree.

  CALL METHOD go_tree->get_registered_events
    IMPORTING
      events = gt_events.

  gs_event-eventid = cl_gui_column_tree=>eventid_item_context_menu_req.
  APPEND gs_event TO gt_events.

  CALL METHOD go_tree->set_registered_events
    EXPORTING
      events = gt_events.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_column_tree
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_column_tree .

  DATA: lv_rkey        TYPE lvc_nkey, "부모 노드 키
        lv_nkey        TYPE lvc_nkey, "현재 노드 키
        lv_node_key    TYPE lvc_nkey,
        lv_node_text   TYPE lvc_value,
        ls_layout      TYPE lvc_s_layn,
        lt_layout_item TYPE lvc_t_layi. "gt_fcat 변환을 위함 (alv tree에 맞는 fcat으로 변환)

*-- 첫번째 노드(최상위노드 : 당기순이익) 추가 (상위노드가 비어있는 data를 찾는다
  LOOP AT gt_pldata INTO gs_pldata WHERE parent_node_id IS INITIAL.
    EXIT.
  ENDLOOP.

  IF sy-subrc = 0. "최상위노드를 찾았다면

    " 폴더 아이콘으로 설정
    ls_layout-isfolder = 'X'.
*    ls_item_layout-font = cl_gui_column_tree=>item_font_bold.

    " 노드에 표시될 텍스트
    lv_node_text = gs_pldata-node_name.

    " ALV Tree에 노드 추가(First node)
    CALL METHOD go_tree->add_node
      EXPORTING
        i_relat_node_key = ''  " 최상위노드(부모 없음)
        i_relationship   = cl_gui_column_tree=>relat_last_child
        i_node_text      = lv_node_text
        is_outtab_line   = gs_pldata
        is_node_layout   = ls_layout
      IMPORTING
        e_new_node_key   = lv_nkey.

    "레이아웃
    PERFORM create_item_layouts CHANGING lt_layout_item.

    "루트 노드 키 매핑 후 저장
    ls_key_map-node_id = gs_pldata-node_id.
    ls_key_map-key     = lv_nkey.
    INSERT ls_key_map INTO TABLE lt_node_key_map.

    DATA(lv_root_node_id) = gs_pldata-node_id.
  ELSE.
    MESSAGE s003 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

*-- 두 번째 노드 추가(매출총이익, 판관비, 영업외수익, 영업외비용)
  LOOP AT gt_pldata INTO gs_pldata WHERE parent_node_id = lv_root_node_id.

    CLEAR ls_layout.
    IF gs_pldata-node_type = 'H'.
      ls_layout-isfolder = 'X'.
      lv_node_text = gs_pldata-node_name.
    ELSE.
      lv_node_text = |{ gs_pldata-gl_account } - { gs_pldata-node_name }|.
    ENDIF.

    " 상위 노드 키 가져오기(매핑된 부모노드의 키를 가져온다)
    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_pldata-parent_node_id.
    IF sy-subrc = 0.
      lv_rkey = ls_key_map-key.
    ELSE.
      lv_rkey = ''.  " 최상위 노드일 경우
    ENDIF.

    " 노드 삽입(Second node)
    CALL METHOD go_tree->add_node
      EXPORTING
        i_relat_node_key = lv_rkey
        i_relationship   = cl_gui_column_tree=>relat_last_child
        i_node_text      = lv_node_text
        is_outtab_line   = gs_pldata
        is_node_layout   = ls_layout
      IMPORTING
        e_new_node_key   = lv_nkey.

    "레이아웃
    PERFORM create_item_layouts CHANGING lt_layout_item.

    " 키 매핑 저장
    ls_key_map-node_id = gs_pldata-node_id.
    ls_key_map-key     = lv_nkey.
    INSERT ls_key_map INTO TABLE lt_node_key_map.

  ENDLOOP.

**-- 마지막 계층 노드 추가 (말단 노드들)
*  LOOP AT gt_pldata INTO gs_pldata WHERE node_type <> 'H'. "노드 타입 = A or B인 경우
*
*    CLEAR: lv_node_text, ls_layout, lv_rkey.
*
*    " 부모 노드 키 가져오기 (중간 H노드 기준)
*    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_pldata-parent_node_id.
*    IF sy-subrc = 0.
*      lv_rkey = ls_key_map-key.
*    ELSE.
*      CONTINUE. " 부모 키 못 찾으면 스킵
*    ENDIF.
*
*    "노드 텍스트 출력
*    lv_node_text = |{ gs_pldata-node_name }|.
*
*    "노드 삽입(Third node)
*    CALL METHOD go_tree->add_node
*      EXPORTING
*        i_relat_node_key = lv_rkey
*        i_relationship   = cl_gui_column_tree=>relat_last_child
*        i_node_text      = lv_node_text
*        is_outtab_line   = gs_pldata
*        is_node_layout   = ls_layout
*      IMPORTING
*        e_new_node_key   = lv_nkey.
*
*    "레이아웃
*    PERFORM create_item_layouts CHANGING lt_layout_item.
*
*    " 키 매핑
*    ls_key_map-node_id = gs_pldata-node_id.
*    ls_key_map-key     = lv_nkey.
*    INSERT ls_key_map INTO TABLE lt_node_key_map.
*
*  ENDLOOP.

*************************************
**-- 모든 노드 추가 (parent_node_id를 기준으로 계층 구성)
  LOOP AT gt_pldata INTO gs_pldata

    "노드 중복 출력 제거하기
    WHERE node_id <> '0001' "당기순이익
    AND node_id <> '0010' "매출총이익
    AND node_id <> '0020' "판관비
    AND node_id <> '0030' "영업외수익
    AND node_id <> '0040' "영업외비용
    AND node_id <> ''.    "최상위노드

    CLEAR: lv_node_text, ls_layout, lv_rkey.

    " 부모 노드 키 가져오기
    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_pldata-parent_node_id.
    IF sy-subrc = 0.
      lv_rkey = ls_key_map-key.
    ELSE.
      lv_rkey = ''. " 최상위 노드일 경우
    ENDIF.

    " 폴더 여부
    IF gs_pldata-node_type = 'H'.
      ls_layout-isfolder = 'X'.
      lv_node_text = gs_pldata-node_name.
    ELSE.
      lv_node_text = |{ gs_pldata-node_name }|.
    ENDIF.

    CALL METHOD go_tree->add_node
      EXPORTING
        i_relat_node_key = lv_rkey
        i_relationship   = cl_gui_column_tree=>relat_last_child
        i_node_text      = lv_node_text
        is_outtab_line   = gs_pldata
        is_node_layout   = ls_layout
      IMPORTING
        e_new_node_key   = lv_nkey.

    " 레이아웃
    PERFORM create_item_layouts CHANGING lt_layout_item.

    " 키 매핑
    ls_key_map-node_id = gs_pldata-node_id.
    ls_key_map-key     = lv_nkey.
    INSERT ls_key_map INTO TABLE lt_node_key_map.

  ENDLOOP.
*************************************

  CALL METHOD : go_tree->update_calculations,
                go_tree->frontend_update,
                cl_gui_cfw=>flush.

  PERFORM calculate_percentage. "백분률 필드 계산
  PERFORM refresh_node_text.    "node 리프레시

*-- 전체 폴더 노드 펼치기
  LOOP AT lt_node_key_map INTO ls_key_map.
    READ TABLE gt_pldata INTO gs_pldata WITH KEY node_id = ls_key_map-node_id.
    IF sy-subrc = 0 AND gs_pldata-node_type = 'H'.
      CALL METHOD go_tree->expand_node
        EXPORTING
          i_node_key       = ls_key_map-key
          i_level_count    = 1
          i_expand_subtree = 'X'.
    ENDIF.
  ENDLOOP.

ENDFORM.


*&---------------------------------------------------------------------*
*& Form set_field_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_field_catalog  USING pv_field pv_table pv_text pv_noout.

  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-coltext   = pv_text.
  gs_fcat-no_out    = pv_noout.
  gs_fcat-outputlen = 30.

  CASE pv_field.
    WHEN 'PREV_AMT'.
      gs_fcat-cfieldname = 'PREV_CURR'.
    WHEN 'CURR_AMT'.
      gs_fcat-cfieldname = 'CURR_CURR'.
    WHEN 'PERCENTAGE'.
      gs_fcat-outputlen = 10.
      gs_fcat-just = 'R'. " 오른쪽 정렬
*      gs_fcat-stylefieldname = 'CELLSTYLE'.
  ENDCASE.

  APPEND gs_fcat TO gt_fcat.
  CLEAR gs_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form change
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_1
*&      --> CL_GUI_COLUMN_TREE=>ITEM_FONT_
*&---------------------------------------------------------------------*
FORM change  USING type  TYPE i
                   value TYPE i.

  DATA: lt_selected_nodes   TYPE lvc_t_nkey,
        ls_selected_node    TYPE lvc_nkey,
        lt_item_layout      TYPE lvc_t_layi,
        ls_item_layout_wa   TYPE lvc_s_layi,
        lt_change_layout    TYPE lvc_t_laci,
        ls_change_layout_wa TYPE lvc_s_laci,
        l_fieldname         TYPE lvc_fname,
        ls_outtab           TYPE sflight.

  CALL METHOD go_tree->get_selected_nodes
    CHANGING
      ct_selected_nodes = lt_selected_nodes.

  IF lt_selected_nodes IS INITIAL.
    CALL METHOD go_tree->get_selected_item
      IMPORTING
        e_selected_node = ls_selected_node
        e_fieldname     = l_fieldname.
    APPEND ls_selected_node TO lt_selected_nodes.
  ENDIF.

  LOOP AT lt_selected_nodes INTO ls_selected_node.
    CALL METHOD go_tree->get_outtab_line
      EXPORTING
        i_node_key     = ls_selected_node
      IMPORTING
        e_outtab_line  = ls_outtab
        et_item_layout = lt_item_layout.

    CLEAR lt_change_layout.
    LOOP AT lt_item_layout INTO ls_item_layout_wa.
      IF l_fieldname IS INITIAL OR
         ls_item_layout_wa-fieldname EQ l_fieldname.

        MOVE-CORRESPONDING ls_item_layout_wa TO ls_change_layout_wa.

        CASE type.
          WHEN 0.
            ls_change_layout_wa-class = value.
            ls_change_layout_wa-u_class = 'X'.
            IF value EQ cl_gui_column_tree=>item_class_checkbox.
              ls_change_layout_wa-editable = 'X'.
            ELSE.
              ls_change_layout_wa-editable = space.
            ENDIF.
            ls_change_layout_wa-u_editable = 'X'.
          WHEN 1.
            ls_change_layout_wa-font = value.
            ls_change_layout_wa-u_font = 'X'.
          WHEN 2.
            ls_change_layout_wa-style = value.
            ls_change_layout_wa-u_style = 'X'.
          WHEN 3.
            IF value EQ 0.
              ls_change_layout_wa-t_image = icon_okay.
            ELSE.
              ls_change_layout_wa-t_image = space.
            ENDIF.

            ls_change_layout_wa-u_t_image = 'X'.
        ENDCASE.
        APPEND ls_change_layout_wa TO lt_change_layout.
      ENDIF.
    ENDLOOP.

    CALL METHOD go_tree->change_node
      EXPORTING
        i_node_key     = ls_selected_node
        i_outtab_line  = ls_outtab
        it_item_layout = lt_change_layout.

  ENDLOOP.

  CALL METHOD go_tree->frontend_update.
  CALL METHOD cl_gui_cfw=>flush.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_item_layouts
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- LT_LAYOUT_ITEM
*&---------------------------------------------------------------------*
FORM create_item_layouts  CHANGING pt_item_layout TYPE lvc_t_layi.

  DATA: ls_item_layout TYPE lvc_s_layi.

  CLEAR pt_item_layout.
  LOOP AT gt_fcat INTO gs_fcat.
    CLEAR ls_item_layout.
    IF gs_fcat-no_out EQ space.
      ls_item_layout-fieldname = gs_fcat-fieldname.
      APPEND ls_item_layout TO pt_item_layout.
    ENDIF.
  ENDLOOP.

  CLEAR ls_item_layout.
  ls_item_layout-fieldname = go_tree->c_hierarchy_column_name.
  APPEND ls_item_layout TO pt_item_layout.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_base_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_base_data .

*-- 분기 날짜 계산
  DATA: lv_date_from      TYPE budat,
        lv_prev_date_from TYPE budat,
        lv_prev_date_to   TYPE budat,
        lv_prev_gjahr     TYPE gjahr.

*-- 계정잔액 이외 data가져오기
  CLEAR gt_pldata.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE gt_pldata
    FROM zc103fit0019.

  lv_prev_gjahr = pa_gjahr - 1.

  CASE pa_qua.
    WHEN '1'.
      lv_date_from      = |{ pa_gjahr }0101|.
      gv_date_to        = |{ pa_gjahr }0331|.
      lv_prev_date_from = |{ lv_prev_gjahr }1001|.
      lv_prev_date_to   = |{ lv_prev_gjahr }1231|.
    WHEN '2'.
      lv_date_from      = |{ pa_gjahr }0401|.
      gv_date_to        = |{ pa_gjahr }0630|.
      lv_prev_date_from = |{ pa_gjahr }0101|.
      lv_prev_date_to   = |{ pa_gjahr }0331|.
    WHEN '3'.
      lv_date_from      = |{ pa_gjahr }0701|.
      gv_date_to        = |{ pa_gjahr }0930|.
      lv_prev_date_from = |{ pa_gjahr }0401|.
      lv_prev_date_to   = |{ pa_gjahr }0630|.
    WHEN '4'.
      lv_date_from      = |{ pa_gjahr }1001|.
      gv_date_to        = |{ pa_gjahr }1231|.
      lv_prev_date_from = |{ pa_gjahr }0701|.
      lv_prev_date_to   = |{ pa_gjahr }0930|.
  ENDCASE.

*-- 조회연도에 해당하는 계정별 잔액 가져오기
  DATA: lv_curr_amt   TYPE zc103fit0002-wrbtr,
        lv_prev_amt   TYPE zc103fit0002-wrbtr,
        lv_percentage TYPE decimal10_2.

  LOOP AT gt_pldata INTO gs_pldata.

    CLEAR: lv_curr_amt, lv_prev_amt.

    IF gs_pldata-gl_account IS NOT INITIAL.

      IF zc103fit0002-wrbtr IS INITIAL. "usd인 경우 wrbtr이 아닌 dmbtr값을 가져옴
        "당기 금액
        SELECT SUM( dmbtr )
          INTO @lv_curr_amt
          FROM zc103fit0002
         WHERE hkont EQ @gs_pldata-gl_account
           AND bukrs EQ @pa_bukrs
           AND budat BETWEEN @lv_date_from AND @gv_date_to.
        "전기 금액 (당기 - 1)
        SELECT SUM( dmbtr )
          INTO @lv_prev_amt
          FROM zc103fit0002
         WHERE hkont EQ @gs_pldata-gl_account
           AND bukrs EQ @pa_bukrs
           AND budat BETWEEN @lv_prev_date_from AND @lv_prev_date_to.
      ELSE.                             "krw 결제인 경우 wrbtr
        "당기 금액
        SELECT SUM( wrbtr )
          INTO @lv_curr_amt
          FROM zc103fit0002
         WHERE hkont EQ @gs_pldata-gl_account
           AND bukrs EQ @pa_bukrs
           AND budat BETWEEN @lv_date_from AND @gv_date_to.
        "전기 금액 (당기 - 1)
        SELECT SUM( wrbtr )
          INTO @lv_prev_amt
          FROM zc103fit0002
         WHERE hkont EQ @gs_pldata-gl_account
           AND bukrs EQ @pa_bukrs
           AND budat BETWEEN @lv_prev_date_from AND @lv_prev_date_to.
      ENDIF.
    ENDIF.

    gs_pldata-prev_amt = lv_prev_amt.
    gs_pldata-curr_amt = lv_curr_amt.

    "통화(당기)
    SELECT SINGLE k_waers
      INTO @gs_pldata-curr_curr
      FROM zc103fit0002.

    "통화(전기)
    SELECT SINGLE k_waers
      INTO @gs_pldata-prev_curr
      FROM zc103fit0002.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING curr_amt prev_amt curr_curr prev_curr.

  ENDLOOP.

*-- 변동률 계산하는 로직
  DATA: lv_percent_num TYPE p DECIMALS 2,
        lv_percent_str TYPE char10,
        lv_sign        TYPE char1.

  LOOP AT gt_pldata INTO gs_pldata.

    CLEAR: lv_percent_num, lv_percent_str, lv_sign, gs_pldata-percentage.

    IF gs_pldata-prev_amt IS NOT INITIAL.
      lv_percent_num = ( gs_pldata-curr_amt - gs_pldata-prev_amt )
                     / gs_pldata-prev_amt * 100.

      " 양/음에 따라 아이콘 기호 결정
      IF lv_percent_num > 0.
        lv_sign = '▲'.
      ELSEIF lv_percent_num < 0.
        lv_sign = '▼'.
      ELSE.
        lv_sign = ' '.
      ENDIF.

      " 문자열 포맷팅
      WRITE lv_percent_num TO lv_percent_str(8) DECIMALS 2.
      CONCATENATE lv_sign lv_percent_str '%' INTO gs_pldata-percentage
                                            SEPARATED BY space.
    ELSE.
      gs_pldata-percentage = '  0.00%'.
    ENDIF.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING percentage.

  ENDLOOP.

*-- 폴더노드 변동률 계산
  LOOP AT gt_pldata INTO gs_pldata
    WHERE node_type = 'H'. " 폴더 노드만

    CLEAR: lv_percent_num, lv_percent_str, lv_sign, gs_pldata-percentage.

    IF gs_pldata-prev_amt IS NOT INITIAL.
      lv_percent_num = ( gs_pldata-curr_amt - gs_pldata-prev_amt )
                     / gs_pldata-prev_amt * 100.

      IF lv_percent_num > 0.
        lv_sign = '▲'.
      ELSEIF lv_percent_num < 0.
        lv_sign = '▼'.
      ELSE.
        lv_sign = ' '.
      ENDIF.

      WRITE lv_percent_num TO lv_percent_str(8) DECIMALS 2.
      CONCATENATE lv_sign lv_percent_str '%' INTO gs_pldata-percentage
                                            SEPARATED BY space.
    ELSE.
      gs_pldata-percentage = '0.00%'.
    ENDIF.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING percentage.

  ENDLOOP.

*-- 데이터 출력확인 메시지
  IF gt_pldata IS INITIAL.
    MESSAGE s003 DISPLAY LIKE 'E'.
  ELSE.
    MESSAGE s000 WITH '조회가 완료되었습니다.' DISPLAY LIKE 'S'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form pdf_job
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM pdf_job .

  DATA : lv_line   TYPE i,
         lv_answer.

*-- Dialog box
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '다운로드'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer = '2'.  " No를 선택하면 종료
    RETURN.
  ENDIF.

  IF lv_answer NE '1'.
    EXIT.
  ENDIF.

  IF objfile IS  INITIAL.
    TRY.
        CREATE OBJECT objfile.
    ENDTRY.
  ENDIF.

*-- Open file save window -------------------------------------------*
  IF pfolder IS NOT INITIAL.
    initialfolder = pfolder.
  ELSE.
    objfile->get_temp_directory( CHANGING temp_dir = initialfolder
                                 EXCEPTIONS cntl_error = 1
                                           error_no_gui = 2
                                           not_supported_by_gui = 3 ).
  ENDIF.

  objfile->directory_browse( EXPORTING initial_folder = initialfolder
                             CHANGING selected_folder = pickedfolder
                             EXCEPTIONS cntl_error = 1
                                        error_no_gui = 2
                                        not_supported_by_gui = 3 ).

  IF sy-subrc = 0.
    pfolder = pickedfolder.
  ELSE.
    MESSAGE 'An error has occured picking a folder' TYPE 'I' DISPLAY LIKE 'W'.
    EXIT.
  ENDIF.
*--------------------------------------------------------------------*
  IF pfolder IS INITIAL.
    EXIT.
  ENDIF.

  CALL METHOD objfile->free.
  FREE objfile.

  PERFORM download_excel.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_pdf
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM download_excel .

  DATA : lv_rc  TYPE i.
  DATA: lv_date TYPE c LENGTH 8,
        lv_time TYPE c LENGTH 4,
        lv_name TYPE rlgrap-filename.

*-- 파일명 만들기용 기준 데이터(클릭된 행에 대한 data를 출력하는 경우)
  READ TABLE gt_pldata INTO gs_pldata INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE '선택된 데이터가 없습니다.' TYPE 'E'.
    EXIT.
  ENDIF.

*-- File name
  CLEAR gv_temp_filename.
  lv_date = sy-datum(4).      " 오늘 날짜 (예: 20250417)
  lv_time = sy-uzeit(4).      " 시분만 (예: 1352)

  CONCATENATE 'S-AIR' lv_date '년도' '_' '손익계산서' '.XLSX'
              INTO lv_name.

  CONCATENATE pfolder '\' lv_name INTO gv_temp_filename.

  gv_form = 'ZPL_TEMPLATE'.
  PERFORM download_template   USING gv_form gv_temp_filename.
  PERFORM open_excel_template USING gv_form.
*-- pdf data 추가
  PERFORM fill_excel_line.

*-- 기본적으로 Sheet 1을 보여주도록 셋팅
  CALL METHOD OF excel 'SHEETS' = sheet EXPORTING #1 = 1.
  CALL METHOD OF sheet 'SELECT' NO FLUSH.

*-- 모두 출력후 맨윗칸으로 커서 이동
  CALL METHOD OF excel 'Cells' = cell
    EXPORTING
      #1 = 1
      #2 = 1.

  CALL METHOD OF cell 'Select'.

  SET PROPERTY OF excel 'VISIBLE' = 1 . "엑셀 데이터를 다 뿌리고나서 보여줌


  PERFORM convert_to_pdf.

*  MESSAGE s001 WITH TEXT-s01.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&      --> GV_TEMP_FILENAME
*&---------------------------------------------------------------------*
FORM download_template  USING p_zform p_filename.

  DATA : wwwdata_item LIKE wwwdatatab,
         rc           TYPE i.

  gv_file = p_filename.

  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = gv_file
    IMPORTING
      return = rc.

  IF rc = 0 OR rc = 1.

  ELSE.
    MESSAGE e001  WITH '임시파일 초기화 실패.'
                       '이전에 Excel에서 자료를 OPEN하였는지 확인.'.
  ENDIF.

  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
   WHERE objid = p_zform.

  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = gv_file.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form convert_to_pdf
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM convert_to_pdf .

  DATA lv_rc TYPE i.

  CLEAR gv_temp_filename_pdf.
  CONCATENATE pfolder '\' '손익계산서' '.pdf'
              INTO gv_temp_filename_pdf.

  GET PROPERTY OF excel 'Workbooks' = workbook
    EXPORTING #1 = 1.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = '0'
      #2 = gv_temp_filename_pdf.

  CALL METHOD OF workbook 'Close'
    EXPORTING
      #1 = 0.

  CALL METHOD OF excel 'Quit'.

  CALL METHOD cl_gui_frontend_services=>file_delete
    EXPORTING
      filename = CONV #( gv_temp_filename )
    CHANGING
      rc       = lv_rc.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = 0
      #2 = gv_temp_filename_pdf.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form open_excel_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&---------------------------------------------------------------------*
FORM open_excel_template  USING    p_zform.

  IF excel IS INITIAL.
    CREATE OBJECT excel 'EXCEL.APPLICATION'.
  ENDIF.

  IF sy-subrc NE 0.
    MESSAGE i001 WITH sy-msgli.
  ENDIF.

  CALL METHOD OF excel 'WORKBOOKS' = workbook.
  SET PROPERTY OF excel 'VISIBLE' = 0 .

  CALL METHOD OF workbook 'OPEN' EXPORTING #1 = gv_file.

*-- Sheet에대한 설정을 할때 사용된다.

  GET PROPERTY OF : workbook    'Application' = application,
                    application 'ActiveSheet' = activesheet.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_excel_line
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_excel_line .

  DATA : lv_total_liability TYPE p DECIMALS 0,
         lv_total_equity    TYPE p DECIMALS 0,
         lv_total_sum       TYPE p DECIMALS 0,
         lv_char_date(10).



  DATA : lv_belnr              TYPE bkpf-belnr,
         lv_line               TYPE i,
         lv_amount(20),
         lv_date(10),
         lv_dmbtr_text         TYPE c LENGTH 30,
         lv_text(50),
         lv_curr_curr_text(20).

**********************************************************************
* Write Document header
**********************************************************************
  CASE pa_qua.
    WHEN 1.
      lv_char_date = '1분기'.
    WHEN 2.
      lv_char_date = '2분기'.
    WHEN 3.
      lv_char_date = '3분기'.
    WHEN 4.
      lv_char_date = '4분기'.
  ENDCASE.

*-- 날짜 텍스트 생성 및 출력 (손익계산서 상단용)
  lv_text = |{ pa_gjahr }년도 { lv_char_date }|.
  PERFORM fill_cells USING 3 2 lv_text.

  LOOP AT gt_pldata INTO gs_pldata.

    CASE gs_pldata-node_id.
*-- 매출액
      WHEN '0011'. "매출액
        gs_pldata-excel_row = 6.
      WHEN 'A001'. "여객매출
        gs_pldata-excel_row = 7.
      WHEN 'A002'. "화물운송매출
        gs_pldata-excel_row = 8.
*-- 매출원가
      WHEN '0013'. "매출원가
        gs_pldata-excel_row = 9.
      WHEN 'B001'. "유류비
        gs_pldata-excel_row = 10.
      WHEN 'B002'. "승무원급여
        gs_pldata-excel_row = 11.
      WHEN 'B003'. "공항이용료
        gs_pldata-excel_row = 12.
*-- 매출총이익
      WHEN '0010'. "매출총이익
        gs_pldata-excel_row = 13.
*-- 판관비
      WHEN '0020'. "판관비
        gs_pldata-excel_row = 14.
      WHEN '0024'. "직원급여
        gs_pldata-excel_row = 15.
      WHEN '0021'. "유지보수비
        gs_pldata-excel_row = 16.
      WHEN '0022'. "보험료
        gs_pldata-excel_row = 17.
      WHEN '0023'. "복리후생비
        gs_pldata-excel_row = 18.
      WHEN '0025'. "감가상각비
        gs_pldata-excel_row = 19.
      WHEN '0026'. "차량유지비
        gs_pldata-excel_row = 20.
      WHEN '0027'. "임차료
        gs_pldata-excel_row = 21.
*-- 영업외수익
      WHEN '0030'. "영업외수익
        gs_pldata-excel_row = 22.
      WHEN '0031'. "금융수익
        gs_pldata-excel_row = 23.
      WHEN '0032'. "자산수익
        gs_pldata-excel_row = 24.
      WHEN '0033'. "기타수익
        gs_pldata-excel_row = 25.
*-- 영업외비용
      WHEN '0040'. "영업외비용
        gs_pldata-excel_row = 26.
      WHEN '0041'. "금융비용
        gs_pldata-excel_row = 27.
      WHEN '0042'. "자산비용
        gs_pldata-excel_row = 28.
      WHEN '0043'. "기타비용
        gs_pldata-excel_row = 29.
*-- 당기순이익
      WHEN '0001'. "당기순이익
        gs_pldata-excel_row = 30.
    ENDCASE.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING excel_row.

*--(행, 열)
    WRITE gs_pldata-curr_amt TO lv_curr_curr_text CURRENCY 'KRW'.
    PERFORM fill_cells USING gs_pldata-excel_row 3 lv_curr_curr_text.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_cells
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_9
*&      --> P_3
*&      --> P_
*&---------------------------------------------------------------------*
FORM fill_cells  USING i j val.

  CALL METHOD OF excel 'CELLS' = cell
    EXPORTING
      #1 = i  " 행
      #2 = j. " 열

  SET PROPERTY OF cell 'VALUE' = val.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form event_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM event_top_of_page .

  DATA : lr_dd_table TYPE REF TO cl_dd_table_element,
         col_field   TYPE REF TO cl_dd_area,
         col_value   TYPE REF TO cl_dd_area.

  DATA : lv_text TYPE sdydo_text_element.

  CALL METHOD go_dyndoc_id->add_table
    EXPORTING
      no_of_columns = 2
      border        = '0'
    IMPORTING
      table         = lr_dd_table.

*-- Set column
  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_field.

  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_value.

  lv_text = '1000'.
  PERFORM add_row USING lr_dd_table col_field col_value 'Chart of Account' lv_text.

*-- 회계연도
*  lv_text = |{ so_budat-low(4) }년 { so_budat-low+4(2) }월 ~ { so_budat-high(4) }년 { so_budat-high+4(2) }월|.
*  PERFORM add_row USING lr_dd_table col_field col_value '조회기간' lv_text.

  lv_text = 'F4 Search help test'.
  PERFORM add_row USING lr_dd_table col_field col_value 'Sample' lv_text.

  PERFORM set_top_of_page.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form add_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LR_DD_TABLE
*&      --> COL_FIELD
*&      --> COL_VALUE
*&      --> P_
*&      --> LV_TEXT
*&---------------------------------------------------------------------*
FORM add_row  USING pr_dd_table  TYPE REF TO cl_dd_table_element
                    pv_col_field TYPE REF TO cl_dd_area
                    pv_col_value TYPE REF TO cl_dd_area
                    pv_field
                    pv_text.

  DATA : lv_text TYPE sdydo_text_element.

*-- Field.
  lv_text = pv_field.

  CALL METHOD pv_col_field->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>strong
      sap_color    = cl_dd_document=>list_heading_inv.

  CALL METHOD pv_col_field->add_gap
    EXPORTING
      width = 3.

*-- Value.
  lv_text = pv_text.

  CALL METHOD pv_col_value->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>heading
      sap_color    = cl_dd_document=>list_negative_inv.

  CALL METHOD pv_col_value->add_gap
    EXPORTING
      width = 3.

  CALL METHOD pr_dd_table->new_row.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_top_of_page .

* Creating html control
  IF go_html_cntrl IS INITIAL.
    CREATE OBJECT go_html_cntrl
      EXPORTING
        parent = go_top_container.
  ENDIF.

  CALL METHOD go_dyndoc_id->merge_document.
  go_dyndoc_id->html_control = go_html_cntrl.

* Display document
  CALL METHOD go_dyndoc_id->display_document
    EXPORTING
      reuse_control      = 'X'
      parent             = go_top_container
    EXCEPTIONS
      html_display_error = 1.

  IF sy-subrc NE 0.
    MESSAGE s001 WITH TEXT-e01 DISPLAY LIKE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen_loop
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen_loop .

  LOOP AT SCREEN.
    IF screen-name EQ 'PA_BUKRS'.
      screen-input = 0. " ON : 1, OFF : 0
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_value .

  pa_bukrs = '0001'.
  pa_gjahr = sy-datum(4).

  " 리스트박스 세팅
*-- List box
  CLEAR: gt_value[], gs_vrm_posi[].

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 1.
  gs_vrm_value-text = '1분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 2.
  gs_vrm_value-text = '2분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 3.
  gs_vrm_value-text = '3분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 4.
  gs_vrm_value-text = '4분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  gs_vrm_name = 'PA_QUA'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = gs_vrm_name
      values = gs_vrm_posi[].

ENDFORM.
*&---------------------------------------------------------------------*
*& Form alv_tree_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM alv_tree_catalog .

  PERFORM set_item_layout USING : 'AMOUNT'  'ZC103FIT0002',
                                  'K_WAERS' 'ZC103FIT0002'.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_item_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_item_layout USING pv_field pv_table." pv_just.

  DATA : ls_layi TYPE lvc_s_layi.

  ls_layi-fieldname = pv_field.
  ls_layi-editable  = pv_table.
*  ls_layi-just      = pv_just.

  APPEND ls_layi TO gt_item_layout.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_tree_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_tree_data .

  PERFORM set_second_node.
  PERFORM set_first_node.
  PERFORM set_cell_color.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_second_node
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_second_node .

*-- 폴더별로 합계를 집계하는 코드
  DATA : lt_reverse LIKE TABLE OF gs_pldata,
         ls_sum     TYPE ty_sum.

*-- 1) 역순으로 정렬
  lt_reverse = gt_pldata.
  SORT lt_reverse BY parent_node_id DESCENDING.

*-- 2) 집계 루프
  LOOP AT lt_reverse INTO DATA(ls_node).

    READ TABLE gt_pldata INTO DATA(ls_parent)
    WITH KEY node_id = ls_node-parent_node_id.

    IF sy-subrc = 0.

      ls_parent-prev_amt = ls_parent-prev_amt + ls_node-prev_amt.
      ls_parent-curr_amt = ls_parent-curr_amt + ls_node-curr_amt.

      MODIFY gt_pldata FROM ls_parent TRANSPORTING prev_amt curr_amt
      WHERE node_id = ls_parent-node_id.

    ENDIF.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_first_node
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_first_node .

  DATA: lv_prev TYPE wrbtr,
        lv_curr TYPE wrbtr.

  CLEAR: lv_prev, lv_curr.

*-- 매출총이익 = 매출액 - 매출원가
  " 매출총이익 (0010)
  READ TABLE gt_pldata INTO DATA(ls_0010) WITH KEY node_id = '0010'.
  " 매출액 (0011)
  READ TABLE gt_pldata INTO DATA(ls_0011) WITH KEY node_id = '0011'.
  " 매출원가 (0013)
  READ TABLE gt_pldata INTO DATA(ls_0013) WITH KEY node_id = '0013'.

  " 계산 수행
  ls_0010-prev_amt = ls_0011-prev_amt - ls_0013-prev_amt.
  ls_0010-curr_amt = ls_0011-curr_amt - ls_0013-curr_amt.

  MODIFY gt_pldata FROM ls_0010 TRANSPORTING prev_amt curr_amt
    WHERE node_id = '0010'.

  " 판매비와관리비 (0020)
  READ TABLE gt_pldata INTO DATA(ls_0020) WITH KEY node_id = '0020'.
  " 영업외수익 (0030)
  READ TABLE gt_pldata INTO DATA(ls_0030) WITH KEY node_id = '0030'.
  " 영업외비용 (0040)
  READ TABLE gt_pldata INTO DATA(ls_0040) WITH KEY node_id = '0040'.

  lv_prev = ls_0010-prev_amt - ls_0020-prev_amt + ls_0030-prev_amt - ls_0040-prev_amt.
  lv_curr = ls_0010-curr_amt - ls_0020-curr_amt + ls_0030-curr_amt - ls_0040-curr_amt.

  " 당기순이익 노드에 반영
  READ TABLE gt_pldata INTO DATA(ls_result) WITH KEY node_id = '0001'.

  IF sy-subrc = 0.
    ls_result-prev_amt = lv_prev.
    ls_result-curr_amt = lv_curr.
    MODIFY gt_pldata FROM ls_result TRANSPORTING prev_amt curr_amt WHERE node_id = '0001'.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form calculate_percentage
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM calculate_percentage .

  DATA: lv_percent_num TYPE p DECIMALS 2,
        lv_percent_str TYPE char10,
        lv_sign        TYPE char1.

  LOOP AT gt_pldata INTO gs_pldata.

    CLEAR: lv_percent_num, lv_percent_str, lv_sign, gs_pldata-percentage.

    IF gs_pldata-prev_amt IS NOT INITIAL.

      lv_percent_num = ( gs_pldata-curr_amt - gs_pldata-prev_amt )
                     / gs_pldata-prev_amt * 100.

      IF lv_percent_num > 0.
        lv_sign = '▲'.
      ELSEIF lv_percent_num < 0.
        lv_sign = '▼'.
      ELSE.
        lv_sign = ' '.
      ENDIF.

      WRITE lv_percent_num TO lv_percent_str(8) DECIMALS 2.
      CONCATENATE lv_sign lv_percent_str '%' INTO gs_pldata-percentage
                                            SEPARATED BY space.
    ELSE.
      gs_pldata-percentage = '0.00%'.
    ENDIF.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING percentage.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_cell_color
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_cell_color .

  DATA: lt_cellcolor TYPE ty_cellcolor_tab,
        ls_cellcolor TYPE ty_cellcolor,
        ls_color     TYPE lvc_s_scol.
  DATA: lt_color_tab TYPE ty_cellcolor_tab.

  LOOP AT gt_pldata INTO gs_pldata.

    CLEAR : ls_color, gs_pldata-cellcolor.
    ls_cellcolor-fieldname = 'PERCENTAGE'.

    IF gs_pldata-percentage CS '▲'.
      ls_color-color-col = 5.  " 초록
    ELSEIF gs_pldata-percentage CS '▼'.
      ls_color-color-col = 6.  " 빨강
    ELSE.
      ls_color-color-col = 3.  " 기본 회색
    ENDIF.

    INSERT ls_color INTO TABLE gs_pldata-cellcolor.

    MODIFY gt_pldata FROM gs_pldata TRANSPORTING cellcolor.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_node_text
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_node_text .

  LOOP AT gt_pldata INTO gs_pldata.

    " 폴더 노드만 갱신
    IF gs_pldata-node_type = 'H'.

      READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_pldata-node_id.
      IF sy-subrc = 0.

        CALL METHOD go_tree->change_node
          EXPORTING
            i_node_key    = ls_key_map-key
            i_outtab_line = gs_pldata.

      ENDIF.

    ENDIF.

  ENDLOOP.

  CALL METHOD go_tree->frontend_update.
  CALL METHOD cl_gui_cfw=>flush.

ENDFORM.

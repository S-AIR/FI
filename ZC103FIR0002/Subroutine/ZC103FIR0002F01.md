``` abap
*&---------------------------------------------------------------------*
*& Include          ZC103FIR0002F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form set_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_value .

  pa_buk = '0001'.
  pa_gja = sy-datum(4).

  "리스트박스 세팅
*-- List box
  CLEAR: gt_value[], gs_vrm_posi[].

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'AL'.
  gs_vrm_value-text = TEXT-l00.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'SA'.
  gs_vrm_value-text = TEXT-l01.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'KR'.
  gs_vrm_value-text = TEXT-l02.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'DR'.
  gs_vrm_value-text = TEXT-l03.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'ZR'.
  gs_vrm_value-text = TEXT-l04.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'SR'.
  gs_vrm_value-text = TEXT-l05.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 'AA'.
  gs_vrm_value-text = TEXT-l07.
  APPEND gs_vrm_value TO gs_vrm_posi.

  gs_vrm_name = 'PA_GROUP'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = gs_vrm_name
      values = gs_vrm_posi[].

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen_loop
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen_loop .

  LOOP AT SCREEN.
    IF screen-name EQ 'PA_BUK'
      OR screen-name EQ 'PA_GJA'.
      screen-input = 0. " ON : 1, OFF : 0
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_base_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_header_base_data .

*-- Set group code
  CASE pa_group.
    WHEN 'AL'.    " All
      _init gr_group.
    WHEN OTHERS. " Team
      gr_group[] = VALUE #( BASE gr_group[]
                            (
                              sign    = 'I'
                              option  = 'EQ'
                              low     = pa_group
                             )
                           ).
  ENDCASE.

  IF pa_group <> 'AL'.

    SELECT bukrs gjahr belnr blart bldat budat uscode stblg reversal_date bktxt
        reversal_bool bp_id waers usname reversal_reason bp_name usname mblnr
    INTO CORRESPONDING FIELDS OF TABLE gt_hbody
    FROM zc103fit0001
    WHERE blart IN gr_group
    AND budat IN so_bud
    AND belnr IN so_bel
    AND bukrs = pa_buk
    AND gjahr = pa_gja
    ORDER BY gjahr belnr.

  ELSE.
    SELECT bukrs gjahr belnr blart bldat budat uscode stblg reversal_date bktxt
            reversal_bool bp_id waers usname reversal_reason bp_name usname mblnr
    INTO CORRESPONDING FIELDS OF TABLE gt_hbody
    FROM zc103fit0001
      WHERE budat IN so_bud
      AND belnr IN so_bel
      AND bukrs = pa_buk
      AND gjahr = pa_gja
      ORDER BY gjahr belnr.
  ENDIF.

  SELECT saknr txt50
  INTO CORRESPONDING FIELDS OF TABLE gt_03
  FROM zc103fit0003.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_logic
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_logic .

  CALL TRANSACTION 'ZC103FIR0001'. " AND SKIP FIRST SCREEN.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form reversal_logic
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM reversal_logic .

  DATA: lv_belnr          TYPE zc103fit0001-belnr,      " 원본 전표 번호
        lv_gjahr          TYPE zc103fit0001-gjahr,      " 회계연도
        lv_new_belnr      TYPE zc103fit0001-belnr,      " 역분개 전표 번호
        lt_items          TYPE TABLE OF zc103fit0002,   " 원본 전표 아이템
        lt_reversal_items TYPE TABLE OF zc103fit0002,   " 역분개 아이템
        ls_reversal_item  TYPE zc103fit0002,
        lv_answer(1),
        lv_num            TYPE zc103fit0001-belnr,
        lv_blart          TYPE zc103fit0001-blart,
        lv_result         TYPE string,
        lv_index          TYPE i,
        lv_htxt           TYPE zc103fit0001-bktxt,
        lv_text           TYPE string,
        lt_roid           TYPE lvc_t_roid,
        ls_roid           TYPE lvc_s_roid,
        gs_hbody_selected TYPE zc103fit0001,
        lv_message        TYPE string.

  "1. 선택한 행 정보 가져오기
  CALL METHOD go_alv_grid1->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  IF lt_roid IS INITIAL.
    MESSAGE '선택된 항목이 없습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "2. 역분개 여부 사용자 확인
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '역분개'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer <> '1'. " Yes 선택 안 했으면
    RETURN.
  ENDIF.

  "3. 선택된 첫번째 전표 기준으로 작업
  READ TABLE lt_roid INTO ls_roid INDEX 1.
  READ TABLE gt_hbody INTO gs_hbody INDEX ls_roid-row_id.

  IF gs_hbody-stblg IS NOT INITIAL.
    MESSAGE '이미 역분개된 전표입니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  CLEAR gs_hbody_selected.
  MOVE-CORRESPONDING gs_hbody TO gs_hbody_selected.

  lv_belnr = gs_hbody-belnr.
  lv_gjahr = gs_hbody-gjahr.
  lv_blart = gs_hbody-blart.
  lv_htxt  = gs_hbody-bktxt.

  "4. 역분개 사유 입력
  CALL FUNCTION 'ZC103PMFG0003'
    EXPORTING
      iv_title  = '[역분개 사유]'
    IMPORTING
      ev_text   = lv_result
    EXCEPTIONS
      cancelled = 1
      OTHERS    = 2.

  IF sy-subrc <> 0.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.


  CLEAR gs_hbody.
  CALL FUNCTION 'ZC103PMFG0005'
    IMPORTING
      empno   = gs_hbody-uscode
      empname = gs_hbody-usname.

  IF gs_hbody-uscode IS INITIAL.
    MESSAGE '사용자가 취소했습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "5. 새로운 전표 번호 생성
  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      nr_range_nr             = '1'     " 위에서 지정한 No
      object                  = 'ZC103FI_SR'
    IMPORTING
      number                  = lv_num
    EXCEPTIONS
      interval_not_found      = 1
      number_range_not_intern = 2
      object_not_found        = 3
      quantity_is_0           = 4
      quantity_is_not_1       = 5
      interval_overflow       = 6
      buffer_overflow         = 7
      OTHERS                  = 8.

  IF sy-subrc <> 0.
    MESSAGE '전표번호 생성 실패.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  lv_new_belnr = lv_num.

  "6. 원본 아이템 가져오기
  SELECT bukrs belnr gjahr buzei bldat blart budat sgtxt uscode usname type_id cat_id bschl koart shkzg hkont wrbtr dmbtr waers
        mwskz hwbas mwsts zuonr augbl augdt obelnr bp_id bp_name anln1 matnr werks erdat erzet ernam aedat aezet aenam
   INTO CORRESPONDING FIELDS OF TABLE lt_items
   FROM zc103fit0002
   WHERE belnr = lv_belnr
     AND gjahr = lv_gjahr.

  IF sy-subrc <> 0.
    MESSAGE '원본 전표 아이템이 없습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "7. 아이템 차대 반전하여 역분개 데이터 생성
  LOOP AT lt_items INTO DATA(ls_item).
    CLEAR ls_reversal_item.
    MOVE-CORRESPONDING ls_item TO ls_reversal_item.

    IF ls_item-shkzg = 'S'.
      ls_reversal_item-shkzg = 'H'.
    ELSE.
      ls_reversal_item-shkzg = 'S'.
    ENDIF.

    ls_reversal_item-belnr = lv_new_belnr.
    ls_reversal_item-gjahr = lv_gjahr.

    ls_reversal_item-erdat = sy-datum.
    ls_reversal_item-ernam = sy-uname.
    ls_reversal_item-erzet = sy-uzeit.

    APPEND ls_reversal_item TO lt_reversal_items.
  ENDLOOP.

  "8. 역분개 헤더 생성
  gs_hbody-bukrs = '0001'.
  gs_hbody-gjahr = lv_gjahr.
  gs_hbody-belnr = lv_new_belnr.
  gs_hbody-blart = 'SR'.
  gs_hbody-budat = sy-datum.
  gs_hbody-bldat = sy-datum.
  gs_hbody-reversal_reason = lv_result.

  gs_hbody-stblg = lv_belnr.
  gs_hbody-stjah = lv_gjahr.
  gs_hbody-reversal_bool = 'X'.
  gs_hbody-mblnr = gs_hbody_selected-mblnr.
  gs_hbody-bstat = 'B'.
  gs_hbody-reversal_date = sy-datum.
  gs_hbody-bp_id = gs_hbody_selected-bp_id.
  gs_hbody-bp_name = gs_hbody_selected-bp_name.
  gs_hbody-erdat = sy-datum.
  gs_hbody-ernam = sy-uname.
  gs_hbody-erzet = sy-uzeit.
  MOVE-CORRESPONDING gs_hbody TO gs_hbody_db.
  INSERT zc103fit0001 FROM gs_hbody_db.

  "9. 역분개 아이템 테이블에 저장
  LOOP AT lt_reversal_items INTO ls_reversal_item.
    INSERT zc103fit0002 FROM ls_reversal_item.
  ENDLOOP.

  "10. 원본 전표 업데이트 (역분개 정보 기입)
  READ TABLE gt_hbody INTO gs_hbody INDEX ls_roid-row_id.

  IF sy-subrc = 0.
    gs_hbody-stblg = lv_new_belnr.
    gs_hbody-reversal_date = sy-datum.
    gs_hbody-reversal_reason = lv_result.
    gs_hbody-aedat = sy-datum.
    gs_hbody-aenam = sy-uname.
    gs_hbody-aezet = sy-uzeit.
    MOVE-CORRESPONDING gs_hbody TO gs_hbody_db.
    UPDATE zc103fit0001 FROM gs_hbody_db.
  ENDIF.

  COMMIT WORK AND WAIT.

  "11. alv Refresh
  PERFORM get_header_base_data.
  PERFORM set_data.
  PERFORM refresh_table.

  lv_message = '역분개가 완료되었습니다. 전표번호:' && lv_new_belnr.

  MESSAGE lv_message TYPE 'S'.

  PERFORM get_header_base_data.
  PERFORM set_data.
  PERFORM make_display_header. " ← 반드시 추가
  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen .

  IF go_container1 IS NOT BOUND.

    CLEAR: gt_fcat.
    PERFORM set_header_catalog USING :  'X' 'BUKRS'          'ZC103FIT0001'  'C' ' ',
                                        'X' 'GJAHR'          'ZC103FIT0001'   'C' ' ',
                                        'X' 'BELNR'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'LTEXT'          'T003T' ' ' ' ',
                                        ' ' 'BLDAT'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BUDAT'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BKTXT'          'ZC103FIT0001'   ' ' 'X',
                                        ' ' 'USNAME'        'ZC103FIT0001'   'C' ' ',
                                        ' ' 'MBLNR'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'STBLG'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'REVERSAL_DATE'  'ZC103FIT0001'   'C' ' ',
                                        ' ' 'REVERSAL_REASON'  'ZC103FIT0001'   ' ' ' ',
                                        ' ' 'BP_NAME'        'ZC103FIT0001' ' ' 'X'.

    CLEAR : gt_fcat2.
    PERFORM set_item_catalog USING :    'X' 'BUZEI'          'ZC103FIT0001'  'C' ' ',
                                        'X' 'BUKRS'          'ZC103FIT0001'   'C' ' ',
                                        'X' 'GJAHR'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'BELNR'          'ZC103FIT0001' 'C' ' ',
                                        ' ' 'SHKZG'          'ZC103FIT0001'   'C' ' ',
                                        ' ' 'SGTXT'          'ZC103FIT0001'   ' ' ' ',
                                        ' ' 'HKONT'        'ZC103FIT0002' 'C' ' ',
                                        ' ' 'TXT50'          'ZC103FIT0002'   ' ' ' ',
                                        ' ' 'DMBTR'          'ZC103FIT0002'   ' ' ' ',
                                        ' ' 'K_WAERS'          'ZC103FIT0002'   'C' ' ',
                                        ' ' 'WRBTR'          'ZC103FIT0002'   ' ' ' ',
                                        ' ' 'WAERS'          'ZC103FIT0002'   'C' ' '.






    PERFORM set_layout.
    PERFORM exclude_toolbar.
    PERFORM create_object.

    SET HANDLER : lcl_event_handler=>top_of_page   FOR go_alv_grid1,
                  lcl_event_handler=>hotspot_click FOR go_alv_grid1,
                  lcl_event_handler=>edit_toolbar FOR go_alv_grid1,
                  lcl_event_handler=>user_command FOR go_alv_grid1.

    CALL METHOD go_alv_grid1->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout1
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_hbody
        it_fieldcatalog      = gt_fcat.

    CALL METHOD go_alv_grid2->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout2
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_ibody
        it_fieldcatalog      = gt_fcat2.

    PERFORM register_event.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_data .

  DATA: lv_tabix TYPE i.

  CLEAR gs_hbody.

  LOOP AT gt_hbody INTO gs_hbody.

    lv_tabix = sy-tabix.

    CASE gs_hbody-blart.
      WHEN 'SA'.
        gs_hbody-ltext = '일반전표'.
      WHEN 'KR'.
        gs_hbody-ltext = '외상매입전표'.
      WHEN 'DR'.
        gs_hbody-ltext = '외상매출전표'.
        IF gs_hbody-bp_id IS INITIAL.
          gs_hbody-bp_name = '신한카드'.
        ENDIF.
      WHEN 'ZR'.
        gs_hbody-ltext = '반제전표'.
      WHEN 'SR'.
        gs_hbody-ltext = '역분개전표'.
      WHEN 'AA'.
        gs_hbody-ltext = '감가상각전표'.
      WHEN OTHERS.

    ENDCASE.

    MODIFY gt_hbody FROM gs_hbody INDEX lv_tabix
                                TRANSPORTING  ltext bp_name.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_header_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> p_
*&      --> p_
*&      --> p_
*&      --> p_
*&      --> p_
*&---------------------------------------------------------------------*
FORM set_header_catalog  USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat-key       = pv_key.
  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-just      = pv_just.
  gs_fcat-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'BUKRS'.
      gs_fcat-coltext = '회사코드'.
    WHEN 'GJAHR'.
      gs_fcat-coltext = '회계연도'.
    WHEN 'BELNR'.
      gs_fcat-coltext = '전표번호'.
      gs_fcat-hotspot = abap_true.
    WHEN 'LTEXT'.
      gs_fcat-coltext = '전표유형'.
    WHEN 'BKTXT'.
      gs_fcat-coltext = '적요'.
    WHEN 'USNAME'.
      gs_fcat-coltext = '전표작성자'.
    WHEN 'STBLG'.
      gs_fcat-coltext = '역분개전표번호'.
    WHEN 'REVERSAL_DATE'.
      gs_fcat-coltext = '역분개일자'.
    WHEN 'MBLNR'.
      gs_fcat-coltext = '참조문서번호'.
    WHEN 'BP_NAME'.
      gs_fcat-coltext = '거래처명'.
    WHEN 'REVERSAL_REASON'.
      gs_fcat-coltext = '역분개사유'.
    WHEN 'BUDAT'.
      gs_fcat-coltext = '전기일자'.
    WHEN 'BLDAT'.
      gs_fcat-coltext = '문서일자'.
  ENDCASE.

  APPEND gs_fcat TO gt_fcat.
  CLEAR gs_fcat.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_item_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> p_
*&      --> p_
*&      --> p_
*&      --> p_
*&      --> p_
*&---------------------------------------------------------------------*
FORM set_item_catalog  USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat2-key       = pv_key.
  gs_fcat2-fieldname = pv_field.
  gs_fcat2-ref_table = pv_table.
  gs_fcat2-just      = pv_just.
  gs_fcat2-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'BUZEI'.
      gs_fcat2-coltext = '항목번호'.
    WHEN 'BUKRS'.
      gs_fcat2-coltext = '회사코드'.
    WHEN 'GJAHR'.
      gs_fcat2-coltext = '회계연도'.
    WHEN 'BELNR'.
      gs_fcat2-coltext = '전표번호'.
    WHEN 'SHKZG'.
      gs_fcat2-coltext = '차/대변지시자'.
    WHEN 'SGTXT'.
      gs_fcat2-coltext = '아이템텍스트'.
    WHEN 'TXT50'.
      gs_fcat2-coltext = '계정내역'.
    WHEN 'WRBTR'.
      gs_fcat2-cfieldname = 'WAERS'.
      gs_fcat2-coltext = '전표통화'.
    WHEN 'DMBTR'.
      gs_fcat2-coltext = '현지통화'.
      gs_fcat2-cfieldname = 'K_WAERS'.
    WHEN 'WAERS'.
      gs_fcat2-coltext = '전표통화'.
    WHEN 'K_WAERS'.
      gs_fcat2-coltext = '현지통화'.

  ENDCASE.

  APPEND gs_fcat2 TO gt_fcat2.
  CLEAR gs_fcat2.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout .

  gs_layout1-zebra      = abap_true.
  gs_layout1-cwidth_opt = 'A'.
  gs_layout1-sel_mode   = 'S'.
  gs_layout1-stylefname = 'CELL_TAB'.
  gs_layout1-grid_title = '전표 헤더'.
  gs_layout1-ctab_fname = 'COLOR'.

  gs_layout2-zebra      = abap_true.
  gs_layout2-cwidth_opt = 'A'.
  gs_layout2-sel_mode   = 'S'.
  gs_layout2-stylefname = 'CELL_TAB'.
  gs_layout2-grid_title = '전표 아이템'.


  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV1'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_object .

  CREATE OBJECT go_top_container
    EXPORTING
      repid     = sy-cprog
      dynnr     = sy-dynnr
      side      = go_top_container->dock_at_top
      extension = 50.

  CREATE OBJECT go_doc_container
    EXPORTING
      repid     = sy-cprog
      dynnr     = sy-dynnr
      side      = go_doc_container->dock_at_left
      extension = 2000.

*-- 화면 분할
  CREATE OBJECT go_splitter
    EXPORTING
      parent  = go_doc_container
      rows    = 2
      columns = 1.

  CALL METHOD go_splitter->get_container
    EXPORTING
      row       = 1
      column    = 1
    RECEIVING
      container = go_container1.

  CALL METHOD go_splitter->get_container
    EXPORTING
      row       = 2
      column    = 1
    RECEIVING
      container = go_container2.

*-- Patch alv
  CREATE OBJECT go_alv_grid1
    EXPORTING
      i_parent = go_container1.

  CREATE OBJECT go_alv_grid2
    EXPORTING
      i_parent = go_container2.

*Create top-Document
  CREATE OBJECT go_dyndoc_id
    EXPORTING
      style = 'ALV_GRID'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form exclude_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM exclude_toolbar .

  DATA : ls_ui_functions TYPE ui_func.

  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form register_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_event .

  CALL METHOD go_alv_grid1->set_ready_for_input
    EXPORTING
      i_ready_for_input = 0.

  CALL METHOD go_alv_grid2->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.

  CALL METHOD go_alv_grid1->list_processing_events
    EXPORTING
      i_event_name = 'TOP_OF_PAGE'
      i_dyndoc_id  = go_dyndoc_id.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form event_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM event_top_of_page .

  DATA : lr_dd_table TYPE REF TO cl_dd_table_element,
         col_field   TYPE REF TO cl_dd_area,
         col_value   TYPE REF TO cl_dd_area.

  DATA : lv_text TYPE sdydo_text_element.

  CALL METHOD go_dyndoc_id->add_table
    EXPORTING
      no_of_columns = 2
      border        = '0'
    IMPORTING
      table         = lr_dd_table.

*-- Set column
  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_field.

  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_value.

  lv_text = '0001 (삼만리항공)'.
  PERFORM add_row USING lr_dd_table col_field col_value '회사코드' lv_text.

*-- 회계연도
  lv_text = pa_gja && '년'.
  PERFORM add_row USING lr_dd_table col_field col_value '회계연도' lv_text.

  CASE pa_group.
    WHEN 'AL'.
      lv_text = '전체'.
    WHEN 'SA'.
      lv_text = '일반전표'.
    WHEN 'KR'.
      lv_text = '외상매입전표'.
    WHEN 'DR'.
      lv_text = '외상매출전표'.
    WHEN 'ZR'.
      lv_text = '반제전표'.
    WHEN 'SR'.
      lv_text = '역분개전표'.
    WHEN 'AA'.
      lv_text = '감가상각전표'.
    WHEN OTHERS.
  ENDCASE.
  PERFORM add_row USING lr_dd_table col_field col_value '전표유형' lv_text.

  PERFORM set_top_of_page.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form add_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> lr_dd_table
*&      --> col_field
*&      --> col_value
*&      --> p_
*&      --> lv_text
*&---------------------------------------------------------------------*
FORM add_row  USING pr_dd_table  TYPE REF TO cl_dd_table_element
                    pv_col_field TYPE REF TO cl_dd_area
                    pv_col_value TYPE REF TO cl_dd_area
                    pv_field
                    pv_text.

  DATA : lv_text TYPE sdydo_text_element.

*-- Field.
  lv_text = pv_field.

  CALL METHOD pv_col_field->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>strong
      sap_color    = cl_dd_document=>list_heading_inv.

  CALL METHOD pv_col_field->add_gap
    EXPORTING
      width = 3.

*-- Value.
  lv_text = pv_text.

  CALL METHOD pv_col_value->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>heading
      sap_color    = cl_dd_document=>list_negative_inv.

  CALL METHOD pv_col_value->add_gap
    EXPORTING
      width = 3.

  CALL METHOD pr_dd_table->new_row.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_top_of_page .

  "creating html control
  IF go_html_cntrl IS INITIAL.
    CREATE OBJECT go_html_cntrl
      EXPORTING
        parent = go_top_container.
  ENDIF.

  CALL METHOD go_dyndoc_id->merge_document.
  go_dyndoc_id->html_control = go_html_cntrl.

  "Display document
  CALL METHOD go_dyndoc_id->display_document
    EXPORTING
      reuse_control      = 'X'
      parent             = go_top_container
    EXCEPTIONS
      html_display_error = 1.

  IF sy-subrc NE 0.
    MESSAGE s001 WITH TEXT-e01 DISPLAY LIKE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handel_hotspot_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> e_row_id
*&      --> e_column_id
*&---------------------------------------------------------------------*
FORM handel_hotspot_click  USING pv_row
                                pv_column.

  DATA: lv_txt50 TYPE skat-txt50,
        lv_hkont TYPE zc103fit0003-saknr.

  CLEAR: gs_hbody, gt_ibody, gs_ibody.
  READ TABLE gt_hbody INTO gs_hbody INDEX pv_row.

  SELECT a~bukrs belnr gjahr buzei bldat blart budat sgtxt uscode usname type_id cat_id
         bschl koart shkzg hkont wrbtr dmbtr a~waers mwskz hwbas mwsts zuonr augbl k_waers
         augdt obelnr bp_id bp_name anln1 matnr werks txt50
    INTO CORRESPONDING FIELDS OF TABLE gt_ibody
    FROM zc103fit0002 AS a LEFT OUTER JOIN zc103fit0003 AS b
    ON a~hkont = b~saknr
    AND a~bukrs = b~bukrs
    WHERE belnr = gs_hbody-belnr
    ORDER BY buzei.


  LOOP AT gt_ibody INTO gs_ibody.
    gs_ibody-k_waers = 'KRW'.

    READ TABLE gt_03 INTO gs_03 WITH KEY saknr = gs_ibody-hkont.
    IF sy-subrc = 0.
      gs_ibody-txt50 = gs_03-txt50.
    ENDIF.

    MODIFY gt_ibody FROM gs_ibody INDEX sy-tabix TRANSPORTING k_waers txt50.
  ENDLOOP.

  LOOP AT gt_ibody  INTO gs_ibody.
    IF gs_ibody-shkzg = 'H'.
      gs_ibody-wrbtr = ( gs_ibody-wrbtr * -1 ).
      gs_ibody-dmbtr = ( gs_ibody-dmbtr * -1 ).
      MODIFY gt_ibody FROM gs_ibody INDEX sy-tabix.
    ENDIF.
  ENDLOOP.

  PERFORM set_gl_name.

  PERFORM refresh_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_table .

  DATA : ls_stable  TYPE lvc_s_stbl.

*-- 현재 Cursor 위치를 Yuji : From Yongsan
  ls_stable-row = abap_true.
  ls_stable-col = abap_true.

*-- Refresh alv
  CALL METHOD go_alv_grid1->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

*-- Refresh alv
  CALL METHOD go_alv_grid2->refresh_table_display
    EXPORTING
      is_stable = ls_stable.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_edit_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> e_object
*&      --> e_interactive
*&---------------------------------------------------------------------*
FORM handle_edit_toolbar  USING po_object TYPE REF TO cl_alv_event_toolbar_set
                                pv_interactive.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-function  = 'REVERSAL'.
  gs_button-icon      = icon_failure.
  gs_button-text = '  역분개'.
  gs_button-quickinfo = '역분개'.
  APPEND gs_button TO po_object->mt_toolbar.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> e_ucomm
*&---------------------------------------------------------------------*
FORM handle_user_command  USING pv_ucomm.

  CASE pv_ucomm.
    WHEN 'REVERSAL'.
      PERFORM reversal_logic.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_pdf
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_excel .

  DATA : lt_roid   TYPE lvc_t_roid,
         ls_roid   TYPE lvc_s_roid,
         lv_line   TYPE i,
         lv_answer.

*-- 선택행 정보를 가져온다.
  CALL METHOD go_alv_grid1->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

*-- 선택행 없으면 오류메시지
  IF lt_roid IS INITIAL.
    MESSAGE s001 WITH TEXT-e01 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

*-- Dialog box
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '다운로드'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer = '2'.  " No를 선택하면 종료
    RETURN.
  ENDIF.

*-- 선택행의 전표정보 발췌
  CLEAR: gt_selected_header, gs_selected_header, gt_selected_item, gs_selected_item.

  LOOP AT lt_roid INTO ls_roid.
    READ TABLE gt_hbody INTO gs_hbody INDEX ls_roid-row_id.
    IF sy-subrc = 0.
      APPEND gs_selected_header TO gt_selected_header.

      "아이템 append하기.
      SELECT a~bukrs belnr gjahr buzei bldat blart budat sgtxt uscode usname type_id cat_id
         bschl koart shkzg hkont wrbtr dmbtr a~waers mwskz hwbas mwsts zuonr augbl
         augdt obelnr bp_id bp_name anln1 matnr werks txt50
      INTO CORRESPONDING FIELDS OF TABLE gt_selected_item
      FROM zc103fit0002 AS a LEFT OUTER JOIN zc103fit0003 AS b
      ON a~hkont = b~saknr
      WHERE belnr = gs_selected_header-belnr
      AND gjahr = gs_selected_header-gjahr.
    ENDIF.
  ENDLOOP.

  IF objfile IS INITIAL.
    TRY .
        CREATE OBJECT objfile.
    ENDTRY.
  ENDIF.

*-- Open file save window -------------------------------------------*
  IF pfolder IS NOT INITIAL.
    initialfolder = pfolder.
  ELSE.
    objfile->get_temp_directory( CHANGING temp_dir = initialfolder
                                 EXCEPTIONS cntl_error = 1
                                           error_no_gui = 2
                                           not_supported_by_gui = 3 ).
  ENDIF.

  objfile->directory_browse( EXPORTING initial_folder = initialfolder
                     CHANGING selected_folder = pickedfolder
                     EXCEPTIONS cntl_error = 1
                                error_no_gui = 2
                                not_supported_by_gui = 3 ).

  IF sy-subrc = 0.
    pfolder = pickedfolder.
  ELSE.
    MESSAGE 'An error has occured picking a folder' TYPE 'I' DISPLAY LIKE 'W'.
    EXIT.
  ENDIF.
*--------------------------------------------------------------------*
  IF pfolder IS INITIAL.
    EXIT.
  ENDIF.

  CALL METHOD objfile->free.
  FREE objfile.

  PERFORM download_excel.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_excel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM download_excel .

  DATA : lv_rc TYPE i.
  DATA: lv_date TYPE c LENGTH 8,
        lv_time TYPE c LENGTH 4,
        lv_name TYPE rlgrap-filename,
        lt_roid TYPE lvc_t_roid,
        ls_roid TYPE lvc_s_roid.

*-- 파일명 만들기용 기준 데이터
  READ    TABLE gt_selected_header INTO gs_selected_header INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE '선택된 데이터가 없습니다.' TYPE 'E'.
    EXIT.
  ENDIF.

*-- File name
  CLEAR gv_temp_filename.
  lv_date = sy-datum.         " 오늘 날짜 (예: 20250417)
  lv_time = sy-uzeit(4).    " 시분만 (예: 1352)

  CONCATENATE '전표' '_' lv_date '_' lv_time '.XLS'
    INTO lv_name.

  CONCATENATE pfolder '\' lv_name INTO gv_temp_filename.

  gv_form = 'ZGL_DOCU'.

  PERFORM download_template   USING gv_form gv_temp_filename.
  PERFORM open_excel_template USING gv_form.
  PERFORM fill_excel_line.

*-- 기본적으로 Sheet 1을 보여주도록 셋팅
  CALL METHOD OF excel 'SHEETS' = sheet EXPORTING #1 = 1.
  CALL METHOD OF sheet 'SELECT' NO FLUSH.

*-- 모두 출력 후 커서 맨 위로 이동
  CALL METHOD OF excel 'Cells' = cell
    EXPORTING
      #1 = 1
      #2 = 1.
  CALL METHOD OF cell 'Select'.

  SET PROPERTY OF excel 'VISIBLE' = 1 .


  PERFORM convert_to_pdf.


  MESSAGE s001 WITH TEXT-s01.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form convert_to_pdf
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM convert_to_pdf .

  DATA lv_rc TYPE i.

  CLEAR gv_temp_filename_pdf.
  CONCATENATE pfolder '\' gs_selected_header-belnr sy-uzeit '.PDF'
              INTO gv_temp_filename_pdf.


  GET PROPERTY OF excel 'Workbooks' = workbook
    EXPORTING #1 = 1.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = '0'
      #2 = gv_temp_filename_pdf.

  CALL METHOD OF workbook 'Close'
    EXPORTING
      #1 = 0.

  CALL METHOD OF excel 'Quit'.

  CALL METHOD cl_gui_frontend_services=>file_delete
    EXPORTING
      filename = CONV #( gv_temp_filename )
    CHANGING
      rc       = lv_rc.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = 0
      #2 = gv_temp_filename_pdf.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> gv_form
*&      --> gv_temp_filename
*&---------------------------------------------------------------------*
FORM download_template  USING p_zform p_filename.

  DATA : wwwdata_item LIKE wwwdatatab,
         rc           TYPE i.

  gv_file = p_filename.

  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = gv_file
    IMPORTING
      return = rc.

  IF rc = 0 OR rc = 1.

  ELSE.
    MESSAGE e001  WITH '임시파일 초기화 실패.'
                       '이전에 Excel에서 자료를 OPEN하였는지 확인.'.
  ENDIF.

  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
   WHERE objid = p_zform.

  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = gv_file.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form open_excel_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> gv_form
*&---------------------------------------------------------------------*
FORM open_excel_template   USING p_zform.

  IF excel IS INITIAL.
    CREATE OBJECT excel 'EXCEL.APPLICATION'.
  ENDIF.

  IF sy-subrc NE 0.
    MESSAGE i001 WITH sy-msgli.
  ENDIF.

  CALL METHOD OF excel 'WORKBOOKS' = workbook.
  SET PROPERTY OF excel 'VISIBLE' = 0 .

  CALL METHOD OF workbook 'OPEN' EXPORTING #1 = gv_file.

*-- Sheet에대한 설정을 할때 사용된다.






  GET PROPERTY OF : workbook    'Application' = application,
                    application 'ActiveSheet' = activesheet.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_excel_line
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_excel_line .

  DATA : lv_belnr      TYPE bkpf-belnr,
         lv_line       TYPE i,
         lv_amount(20),
         lv_date(10),
         lv_cnt        TYPE i,
         lt_roid       TYPE lvc_t_roid,
         ls_roid       TYPE lvc_s_roid.

  DATA lv_dmbtr_text TYPE c LENGTH 30.

  CALL METHOD go_alv_grid1->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

  IF lt_roid IS INITIAL.
    MESSAGE '선택된 항목이 없습니다.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "3. 선택된 첫번째 전표 기준으로 작업
  READ TABLE lt_roid INTO ls_roid INDEX 1.
  READ TABLE gt_hbody INTO gs_hbody INDEX ls_roid-row_id.

  lv_line = 14.
  lv_cnt  = 1.
*********************************************************************
*Write Document header
*********************************************************************
*-- 전기일자
  CLEAR lv_date.
  lv_date = gs_hbody-budat(4) && '.' && gs_hbody-budat+4(2) && '.' &&
            gs_hbody-budat+6(2).
  PERFORM fill_cells USING 8 3 lv_date.

*-- 증빙일자
  CLEAR lv_date.
  lv_date = gs_selected_header-bldat(4) && '.' && gs_selected_header-bldat+4(2) && '.' &&
            gs_selected_header-bldat+6(2).
  PERFORM fill_cells USING 9 3 lv_date.

  PERFORM fill_cells USING 10  3 gs_selected_header-bktxt.  " 전표 헤더텍스트
  PERFORM fill_cells USING 8  13 gs_selected_header-bukrs.  " 회사코드
  PERFORM fill_cells USING 9  13 gs_selected_header-waers.  " 통화키
  PERFORM fill_cells USING 10 13 gs_selected_header-belnr.  " 전표번호

  LOOP AT gt_selected_item INTO gs_selected_item.
    PERFORM fill_cells USING lv_line  2 lv_cnt.
    PERFORM fill_cells USING lv_line  3 gs_selected_item-shkzg.
    PERFORM fill_cells USING lv_line  4 gs_selected_item-hkont.
    PERFORM fill_cells USING lv_line  5 gs_selected_item-txt50.
    PERFORM fill_cells USING lv_line  8 gs_selected_item-dmbtr. "이게 KRW단위로 찍혀야함
    IF gs_selected_item-waers = 'KRW'.
      WRITE gs_selected_item-dmbtr TO lv_dmbtr_text CURRENCY 'KRW'.
      PERFORM fill_cells USING lv_line 8 lv_dmbtr_text.
    ELSE.
      PERFORM fill_cells USING lv_line 8 gs_selected_item-wrbtr.
    ENDIF.


    PERFORM fill_cells USING lv_line  10 gs_selected_item-sgtxt.

    lv_cnt += 1.
    lv_line += 1.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_cells
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> lv_line
*&      --> p_4
*&      --> GS_selected_header_BELNR
*&---------------------------------------------------------------------*
FORM fill_cells  USING i j val.

  CALL METHOD OF excel 'CELLS' = cell
    EXPORTING
      #1 = i  " 행
      #2 = j. " 열

  SET PROPERTY OF cell 'VALUE' = val.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_gl_name
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_gl_name .

  DATA lv_txt50(10).


  LOOP AT gt_ibody INTO gs_ibody.
    lv_txt50 = '0000' && gs_ibody-hkont.
    READ TABLE gt_03 INTO DATA(ls_03) WITH KEY saknr = lv_txt50.
    IF sy-subrc = 0.
      gs_ibody-txt50 = ls_03-txt50.
    ENDIF.
    MODIFY gt_ibody FROM gs_ibody.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form make_display_header
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM make_display_header .

  DATA: ls_scol TYPE lvc_s_scol.

  LOOP AT gt_hbody INTO gs_hbody WHERE stblg IS NOT INITIAL.

    CLEAR: ls_scol, gs_hbody-color. "Clear the Color manager

    ls_scol-color-col = 7.
    INSERT ls_scol INTO TABLE gs_hbody-color.
    MODIFY gt_hbody FROM gs_hbody INDEX sy-tabix TRANSPORTING color.
  ENDLOOP.

ENDFORM.

----------------------------------------------------------------------------------
Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 758

``` abap
*&---------------------------------------------------------------------*
*& Include          ZC103FIR0008F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form get_base_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_base_data .

*-- 분기 날짜 계산
  DATA: lv_date_from      TYPE budat,
        lv_prev_date_from TYPE budat,
        lv_prev_date_to   TYPE budat,
        lv_prev_gjahr     TYPE gjahr.

*-- 계정잔액 이외 data가져오기
  CLEAR: gt_bsdata.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE gt_bsdata
    FROM zc103fit0022.

  lv_prev_gjahr = pa_gjahr - 1.

  CASE pa_qua.
    WHEN '1'.
      lv_date_from      = |{ pa_gjahr }0101|.
      gv_date_to        = |{ pa_gjahr }0331|.
      lv_prev_date_from = |{ lv_prev_gjahr }1001|.
      lv_prev_date_to   = |{ lv_prev_gjahr }1231|.
    WHEN '2'.
      lv_date_from      = |{ pa_gjahr }0401|.
      gv_date_to        = |{ pa_gjahr }0630|.
      lv_prev_date_from = |{ pa_gjahr }0101|.
      lv_prev_date_to   = |{ pa_gjahr }0331|.
    WHEN '3'.
      lv_date_from      = |{ pa_gjahr }0701|.
      gv_date_to        = |{ pa_gjahr }0930|.
      lv_prev_date_from = |{ pa_gjahr }0401|.
      lv_prev_date_to   = |{ pa_gjahr }0630|.
    WHEN '4'.
      lv_date_from      = |{ pa_gjahr }1001|.
      gv_date_to        = |{ pa_gjahr }1231|.
      lv_prev_date_from = |{ pa_gjahr }0701|.
      lv_prev_date_to   = |{ pa_gjahr }0930|.
  ENDCASE.

*-- 금액 계산용 변수
  DATA: lv_curr_amt TYPE zc103fit0002-wrbtr,
        lv_prev_amt TYPE zc103fit0002-wrbtr.

  LOOP AT gt_bsdata INTO gs_bsdata.

    CLEAR: lv_curr_amt, lv_prev_amt.

    IF gs_bsdata-gl_account IS NOT INITIAL.

      IF zc103fit0002-wrbtr IS INITIAL.
        "당기 금액
        SELECT SUM( dmbtr )
          INTO @lv_curr_amt
          FROM zc103fit0002
         WHERE hkont = @gs_bsdata-gl_account
           AND bukrs = @pa_bukrs
           AND budat BETWEEN @lv_date_from AND @gv_date_to.

        "전기 금액
        SELECT SUM( dmbtr )
          INTO @lv_prev_amt
          FROM zc103fit0002
         WHERE hkont = @gs_bsdata-gl_account
           AND bukrs = @pa_bukrs
           AND budat BETWEEN @lv_prev_date_from AND @lv_prev_date_to.

      ELSE.
        "당기 금액
        SELECT SUM( wrbtr )
          INTO @lv_curr_amt
          FROM zc103fit0002
         WHERE hkont = @gs_bsdata-gl_account
           AND bukrs = @pa_bukrs
           AND budat BETWEEN @lv_date_from AND @gv_date_to.

        "전기 금액
        SELECT SUM( wrbtr )
          INTO @lv_prev_amt
          FROM zc103fit0002
         WHERE hkont = @gs_bsdata-gl_account
           AND bukrs = @pa_bukrs
           AND budat BETWEEN @lv_prev_date_from AND @lv_prev_date_to.
      ENDIF.

    ENDIF.

    gs_bsdata-prev_amt = lv_prev_amt.
    gs_bsdata-curr_amt = lv_curr_amt.
    gv_total = gv_total + lv_curr_amt.

    "통화(당기)
    SELECT SINGLE k_waers
      INTO @gs_bsdata-curr_curr
      FROM zc103fit0002
     WHERE hkont = @gs_bsdata-gl_account
       AND bukrs = @pa_bukrs
       AND budat BETWEEN @lv_date_from AND @gv_date_to.

    IF sy-subrc <> 0.
      gs_bsdata-curr_curr = 'KRW'.
    ENDIF.

    "통화(전기)
    SELECT SINGLE k_waers
      INTO @gs_bsdata-prev_curr
      FROM zc103fit0002
     WHERE hkont = @gs_bsdata-gl_account
       AND bukrs = @pa_bukrs
       AND budat BETWEEN @lv_prev_date_from AND @lv_prev_date_to.

    IF sy-subrc <> 0.
      gs_bsdata-prev_curr = 'KRW'.
    ENDIF.

    MODIFY gt_bsdata FROM gs_bsdata TRANSPORTING curr_amt prev_amt curr_curr prev_curr.

  ENDLOOP.

*-- 데이터 출력확인 메시지
  IF gt_bsdata IS INITIAL.
    MESSAGE s003 DISPLAY LIKE 'E'.
  ELSE.
    MESSAGE s000 WITH '조회가 완료되었습니다.' DISPLAY LIKE 'S'.
  ENDIF.
*
**-- 계정잔액 이외 data가져오기
*  CLEAR: gt_bsdata, gv_total.
*
*  SELECT *
*    INTO CORRESPONDING FIELDS OF TABLE gt_bsdata
*    FROM zc103fit0022.
*
**-- 조회연도에 해당하는 계정별 잔액 가져오기
*  DATA: lv_curr_amt   TYPE zc103fit0002-wrbtr,
*        lv_prev_amt   TYPE zc103fit0002-wrbtr,
*        lv_prev_gjahr TYPE gjahr.
*
*  lv_prev_gjahr = pa_gjahr - 1. "전기년도 변수 설정
*  LOOP AT gt_bsdata INTO gs_bsdata.
*
*    CLEAR: lv_curr_amt, lv_prev_amt.
*
*    IF gs_bsdata-gl_account IS NOT INITIAL.
*
*      IF zc103fit0002-wrbtr IS INITIAL. "usd인 경우 wrbtr이 아닌 dmbtr값을 가져옴
*        "당기 금액
*        SELECT SUM( dmbtr )
*          INTO @lv_curr_amt
*          FROM zc103fit0002
*         WHERE hkont EQ @gs_bsdata-gl_account
*           AND bukrs EQ @pa_bukrs
*           AND gjahr EQ @pa_gjahr.
*        "전기 금액 (당기 - 1)
*        SELECT SUM( dmbtr )
*          INTO @lv_prev_amt
*          FROM zc103fit0002
*         WHERE hkont EQ @gs_bsdata-gl_account
*           AND bukrs EQ @pa_bukrs
*           AND gjahr EQ @lv_prev_gjahr.
*      ELSE.                             "krw 결제인 경우 wrbtr
*        "당기 금액
*        SELECT SUM( wrbtr )
*          INTO @lv_curr_amt
*          FROM zc103fit0002
*         WHERE hkont EQ @gs_bsdata-gl_account
*           AND bukrs EQ @pa_bukrs
*           AND gjahr EQ @pa_gjahr.
*        "전기 금액 (당기 - 1)
*        SELECT SUM( wrbtr )
*          INTO @lv_prev_amt
*          FROM zc103fit0002
*         WHERE hkont EQ @gs_bsdata-gl_account
*           AND bukrs EQ @pa_bukrs
*           AND gjahr EQ @lv_prev_gjahr.
*      ENDIF.
*    ENDIF.
*
*    gs_bsdata-prev_amt = lv_prev_amt.
*    gs_bsdata-curr_amt = lv_curr_amt.
*    gv_total = gv_total + lv_curr_amt.
*
*    "통화(당기)
*    SELECT SINGLE k_waers
*      INTO @gs_bsdata-curr_curr
*      FROM zc103fit0002.
*
*    "통화(전기)
*    SELECT SINGLE k_waers
*      INTO @gs_bsdata-prev_curr
*      FROM zc103fit0002.
*
*    MODIFY gt_bsdata FROM gs_bsdata TRANSPORTING curr_amt prev_amt curr_curr prev_curr.
*
*  ENDLOOP.
*
**-- 데이터 출력확인 메시지
*  IF gt_bsdata IS INITIAL.
*    MESSAGE s003 DISPLAY LIKE 'E'.
*  ELSE.
*    MESSAGE s000 WITH '조회가 완료되었습니다.' DISPLAY LIKE 'S'.
*  ENDIF.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_screen .

  IF go_tree IS NOT BOUND.

    PERFORM create_obj.
    PERFORM define_hierarchy_header CHANGING gs_hierhdr.
    PERFORM build_comment USING gt_list_commentary gv_logo. " Top container(alv에 딸려있는 top cont)
    PERFORM define_field_catalog.
    PERFORM create_hierarchy.
    PERFORM fill_column_tree.

    SET HANDLER : lcl_event_handler=>top_of_page        FOR go_alv_grid. " Top of Page 클래스 실행

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_obj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_obj .

  CREATE OBJECT go_container
    EXPORTING
      repid     = sy-repid
      dynnr     = sy-dynnr
      side      = go_container->dock_at_left
      extension = 5500.

  CREATE OBJECT go_tree
    EXPORTING
      parent              = go_container
      node_selection_mode = cl_gui_column_tree=>node_sel_mode_multiple
      item_selection      = 'X'.

  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = go_container.

* Create TOP-Document
  CREATE OBJECT go_dyndoc_id
    EXPORTING
      style = 'ALV_GRID'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form define_hierarchy_header
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- GS_HIERHDR
*&---------------------------------------------------------------------*
FORM define_hierarchy_header  CHANGING pv_hierhdr TYPE treev_hhdr.

  pv_hierhdr-heading = '재무상태표'.
  pv_hierhdr-tooltip = 'Treasure partner group'.
  pv_hierhdr-width = 50.
  pv_hierhdr-width_pix = space.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form build_comment
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GT_LIST_COMMENTARY
*&      --> GV_LOGO
*&---------------------------------------------------------------------*
FORM build_comment  USING    pt_list_commentary TYPE slis_t_listheader
                             pv_logo            TYPE sdydo_value.

  DATA: ls_line TYPE slis_listheader.

  CLEAR ls_line.
  ls_line-typ = 'H'. " High font
  ls_line-info = '(주) S-AIR 재무상태표'.
  APPEND ls_line TO pt_list_commentary.

  CLEAR ls_line.
  ls_line-typ = 'S'. " Small font
  ls_line-key = '회사코드 : '.
  ls_line-info = '0001'.
  APPEND ls_line TO pt_list_commentary.

  CLEAR ls_line.
  ls_line-typ = 'S'.
  ls_line-key = '회계기간 : '.
  ls_line-info = pa_gjahr && '년 ' && |{ pa_qua }| && '분기'.
  APPEND ls_line TO pt_list_commentary.

  pv_logo = 'ENJOYSAP_LOGO'.
  gs_variant-report = sy-repid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form define_field_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM define_field_catalog .

  CLEAR : gt_fcat, gs_fcat.
  PERFORM set_field_catalog USING :
                                    'PREV_AMT'   'ZC103FIT0002'  '전기금액' ' ',
                                    'PREV_CURR'  'ZC103FIT0002'  '통화'    ' ',
                                    'CURR_AMT'   'ZC103FIT0002'  '당기금액' ' ',
                                    'CURR_CURR'  'ZC103FIT0002'  '통화'    ' '.


*-- Set layout
  gs_layout-ctab_fname = 'CELLCOLOR'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_field_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_field_catalog USING pv_field pv_table pv_text pv_noout.

  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-coltext   = pv_text.
  gs_fcat-no_out    = pv_noout.
  gs_fcat-outputlen = 30.

  CASE pv_field.
    WHEN 'PREV_AMT'.
      gs_fcat-cfieldname = 'PREV_CURR'.
    WHEN 'CURR_AMT'.
      gs_fcat-cfieldname = 'CURR_CURR'.
  ENDCASE.

  APPEND gs_fcat TO gt_fcat.
  CLEAR gs_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_hierarchy
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_hierarchy .

*-- top of page 출력하는 메소드
  CALL METHOD go_tree->set_table_for_first_display
    EXPORTING
      is_variant          = gs_variant
      i_save              = 'A'
      i_default           = 'X'
      is_hierarchy_header = gs_hierhdr
      it_list_commentary  = gt_list_commentary
      i_logo              = 'SLOGO1'
      i_background_id     = 'SBACK1'
    CHANGING
      it_outtab           = gt_top
      it_fieldcatalog     = gt_fcat.

*--register item_cxt_menu_request------------------------------------*.
  SET HANDLER : lcl_event_handler=>on_item_cxt_menu_request  FOR go_tree,
                lcl_event_handler=>on_item_cxt_menu_selected FOR go_tree.

  CALL METHOD go_tree->get_registered_events
    IMPORTING
      events = gt_events.

  gs_event-eventid = cl_gui_column_tree=>eventid_item_context_menu_req.
  APPEND gs_event TO gt_events.

  CALL METHOD go_tree->set_registered_events
    EXPORTING
      events = gt_events.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form change
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_1
*&      --> CL_GUI_COLUMN_TREE=>ITEM_FONT_
*&---------------------------------------------------------------------*
FORM change   USING type  TYPE i
                   value TYPE i.

  DATA: lt_selected_nodes   TYPE lvc_t_nkey,
        ls_selected_node    TYPE lvc_nkey,
        lt_item_layout      TYPE lvc_t_layi,
        ls_item_layout_wa   TYPE lvc_s_layi,
        lt_change_layout    TYPE lvc_t_laci,
        ls_change_layout_wa TYPE lvc_s_laci,
        l_fieldname         TYPE lvc_fname,
        ls_outtab           TYPE sflight.

  CALL METHOD go_tree->get_selected_nodes
    CHANGING
      ct_selected_nodes = lt_selected_nodes.

  IF lt_selected_nodes IS INITIAL.
    CALL METHOD go_tree->get_selected_item
      IMPORTING
        e_selected_node = ls_selected_node
        e_fieldname     = l_fieldname.
    APPEND ls_selected_node TO lt_selected_nodes.
  ENDIF.

  LOOP AT lt_selected_nodes INTO ls_selected_node.
    CALL METHOD go_tree->get_outtab_line
      EXPORTING
        i_node_key     = ls_selected_node
      IMPORTING
        e_outtab_line  = ls_outtab
        et_item_layout = lt_item_layout.

    CLEAR lt_change_layout.
    LOOP AT lt_item_layout INTO ls_item_layout_wa.
      IF l_fieldname IS INITIAL OR
         ls_item_layout_wa-fieldname EQ l_fieldname.

        MOVE-CORRESPONDING ls_item_layout_wa TO ls_change_layout_wa.

        CASE type.
          WHEN 0.
            ls_change_layout_wa-class = value.
            ls_change_layout_wa-u_class = 'X'.
            IF value EQ cl_gui_column_tree=>item_class_checkbox.
              ls_change_layout_wa-editable = 'X'.
            ELSE.
              ls_change_layout_wa-editable = space.
            ENDIF.
            ls_change_layout_wa-u_editable = 'X'.
          WHEN 1.
            ls_change_layout_wa-font = value.
            ls_change_layout_wa-u_font = 'X'.
          WHEN 2.
            ls_change_layout_wa-style = value.
            ls_change_layout_wa-u_style = 'X'.
          WHEN 3.
            IF value EQ 0.
              ls_change_layout_wa-t_image = icon_okay.
            ELSE.
              ls_change_layout_wa-t_image = space.
            ENDIF.

            ls_change_layout_wa-u_t_image = 'X'.
        ENDCASE.
        APPEND ls_change_layout_wa TO lt_change_layout.
      ENDIF.
    ENDLOOP.

    CALL METHOD go_tree->change_node
      EXPORTING
        i_node_key     = ls_selected_node
        i_outtab_line  = ls_outtab
        it_item_layout = lt_change_layout.

  ENDLOOP.

  CALL METHOD go_tree->frontend_update.
  CALL METHOD cl_gui_cfw=>flush.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form event_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM event_top_of_page .

  DATA : lr_dd_table TYPE REF TO cl_dd_table_element,
         col_field   TYPE REF TO cl_dd_area,
         col_value   TYPE REF TO cl_dd_area.

  DATA : lv_text TYPE sdydo_text_element.

  CALL METHOD go_dyndoc_id->add_table
    EXPORTING
      no_of_columns = 2
      border        = '0'
    IMPORTING
      table         = lr_dd_table.

*-- Set column
  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_field.

  CALL METHOD lr_dd_table->add_column
    IMPORTING
      column = col_value.

  lv_text = '1000'.
  PERFORM add_row USING lr_dd_table col_field col_value 'Chart of Account' lv_text.

*-- 회계연도
  lv_text = sy-datum(4) && '년 '.
  PERFORM add_row USING lr_dd_table col_field col_value 'Fiscal year' lv_text.

  lv_text = 'F4 Search help test'.
  PERFORM add_row USING lr_dd_table col_field col_value 'Sample' lv_text.

  PERFORM set_top_of_page.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form add_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LR_DD_TABLE
*&      --> COL_FIELD
*&      --> COL_VALUE
*&      --> P_
*&      --> LV_TEXT
*&---------------------------------------------------------------------*
FORM add_row   USING pr_dd_table  TYPE REF TO cl_dd_table_element
                    pv_col_field TYPE REF TO cl_dd_area
                    pv_col_value TYPE REF TO cl_dd_area
                    pv_field
                    pv_text.

  DATA : lv_text TYPE sdydo_text_element.

*-- Field.
  lv_text = pv_field.

  CALL METHOD pv_col_field->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>strong
      sap_color    = cl_dd_document=>list_heading_inv.

  CALL METHOD pv_col_field->add_gap
    EXPORTING
      width = 3.

*-- Value.
  lv_text = pv_text.

  CALL METHOD pv_col_value->add_text
    EXPORTING
      text         = lv_text
      sap_emphasis = cl_dd_document=>heading
      sap_color    = cl_dd_document=>list_negative_inv.

  CALL METHOD pv_col_value->add_gap
    EXPORTING
      width = 3.

  CALL METHOD pr_dd_table->new_row.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_top_of_page
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_top_of_page .

* Creating html control
  IF go_html_cntrl IS INITIAL.
    CREATE OBJECT go_html_cntrl
      EXPORTING
        parent = go_top_container.
  ENDIF.

  CALL METHOD go_dyndoc_id->merge_document.
  go_dyndoc_id->html_control = go_html_cntrl.

* Display document
  CALL METHOD go_dyndoc_id->display_document
    EXPORTING
      reuse_control      = 'X'
      parent             = go_top_container
    EXCEPTIONS
      html_display_error = 1.

  IF sy-subrc NE 0.
    MESSAGE s001 WITH TEXT-e01 DISPLAY LIKE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_value .

  pa_bukrs = '0001'.
  pa_gjahr = sy-datum(4).

  " 리스트박스 세팅
*-- List box
  CLEAR: gt_value[], gs_vrm_posi[].

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 1.
  gs_vrm_value-text = '1분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 2.
  gs_vrm_value-text = '2분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 3.
  gs_vrm_value-text = '3분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  CLEAR gs_vrm_value.
  gs_vrm_value-key  = 4.
  gs_vrm_value-text = '4분기'.
  APPEND gs_vrm_value TO gs_vrm_posi.

  gs_vrm_name = 'PA_QUA'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = gs_vrm_name
      values = gs_vrm_posi[].

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen_loop
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen_loop .

  LOOP AT SCREEN.
    IF screen-name EQ 'PA_BUKRS'.
      screen-input = 0. " ON : 1, OFF : 0
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_tree_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_tree_data .

  PERFORM set_second_node.
  PERFORM set_first_node.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_column_tree
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_column_tree .

  DATA: lv_rkey        TYPE lvc_nkey, "부모 노드 키
        lv_nkey        TYPE lvc_nkey, "현재 노드 키
*        lv_node_key    TYPE lvc_nkey,
        lv_node_text   TYPE lvc_value,
        ls_layout      TYPE lvc_s_layn,
        lt_layout_item TYPE lvc_t_layi. "gt_fcat 변환을 위함 (alv tree에 맞는 fcat으로 변환)

  SORT gt_bsdata BY folder_level node_id.

*-- 첫번째 노드(최상위노드 추가 (상위노드가 비어있는 data를 찾는다
  LOOP AT gt_bsdata INTO gs_bsdata WHERE parent_node_id IS INITIAL.
    CLEAR ls_layout.
    ls_layout-isfolder = 'X'.
    " 노드에 표시될 텍스트
    lv_node_text = gs_bsdata-node_name.

    " ALV Tree에 노드 추가(First node)
    CALL METHOD go_tree->add_node
      EXPORTING
        i_relat_node_key = ''  " 최상위노드(부모 없음)
        i_relationship   = cl_gui_column_tree=>relat_last_child
        i_node_text      = lv_node_text
        is_outtab_line   = gs_bsdata
        is_node_layout   = ls_layout
      IMPORTING
        e_new_node_key   = lv_nkey.

    "루트 노드 키 매핑 후 저장
    ls_key_map-node_id = gs_bsdata-node_id.
    ls_key_map-key     = lv_nkey.
    INSERT ls_key_map INTO TABLE lt_node_key_map.
  ENDLOOP.

*  DATA(lv_root_node_id) = gs_bsdata-node_id.
**ELSE.
*  MESSAGE s003 DISPLAY LIKE 'E'.
*  RETURN.

*-- [2단계] 하위 노드 전체 (A/B 노드 포함, parent_node_id IS NOT INITIAL)
  LOOP AT gt_bsdata INTO gs_bsdata WHERE parent_node_id IS NOT INITIAL.

    CLEAR: lv_node_text, ls_layout, lv_rkey.

    " 텍스트 설정: 폴더(H/A)는 이름만, 계정(B)는 코드 포함
    IF gs_bsdata-node_type = 'H' OR gs_bsdata-node_type = 'A'.
      ls_layout-isfolder = 'X'.
      lv_node_text = gs_bsdata-node_name.
    ELSE.
      lv_node_text =  gs_bsdata-node_name.
    ENDIF.

    " 부모 노드 키 찾기 (없으면 CONTINUE)
    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_bsdata-parent_node_id.
    IF sy-subrc = 0.
      lv_rkey = ls_key_map-key.
    ELSE.
      CONTINUE.
    ENDIF.

**-- 두 번째 노드 추가(매출총이익, 판관비, 영업외수익, 영업외비용)
*  LOOP AT gt_bsdata INTO gs_bsdata WHERE parent_node_id = lv_root_node_id.
*
*    CLEAR ls_layout.
*    IF gs_bsdata-node_type = 'H'.
*      ls_layout-isfolder = 'X'.
*      lv_node_text = gs_bsdata-node_name.
*    ELSE.
*      lv_node_text = |{ gs_bsdata-gl_account } - { gs_bsdata-node_name }|.
*    ENDIF.
*
*    " 상위 노드 키 가져오기(매핑된 부모노드의 키를 가져온다)
*    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_bsdata-parent_node_id.
*    IF sy-subrc = 0.
*      lv_rkey = ls_key_map-key.
*    ELSE.
*      lv_rkey = ''.  " 최상위 노드일 경우
*    ENDIF.

    " 노드 삽입(Second node)
    CALL METHOD go_tree->add_node
      EXPORTING
        i_relat_node_key = lv_rkey
        i_relationship   = cl_gui_column_tree=>relat_last_child
        i_node_text      = lv_node_text
        is_outtab_line   = gs_bsdata
        is_node_layout   = ls_layout
      IMPORTING
        e_new_node_key   = lv_nkey.

    "레이아웃
    PERFORM create_item_layouts CHANGING lt_layout_item.

    " 키 매핑 저장
    ls_key_map-node_id = gs_bsdata-node_id.
    ls_key_map-key     = lv_nkey.
    INSERT ls_key_map INTO TABLE lt_node_key_map.

  ENDLOOP.

*************************************
**-- 모든 노드 추가 (parent_node_id를 기준으로 계층 구성)
*  LOOP AT gt_bsdata INTO gs_bsdata
*
*    "노드 중복 출력 제거하기
*    WHERE node_id <> 'A110' "유동자산
*    AND node_id <> 'A120' "비유동자산
*    AND node_id <> 'A210' "유동부채
*    AND node_id <> 'A220' "비유동부채
*    AND node_id <> 'H100' "자산
*    AND node_id <> 'H200' "부채
*    AND node_id <> 'H300' "자본
*    AND node_id <> ''.    "최상위노드
*
*    CLEAR: lv_node_text, ls_layout, lv_rkey.
*
*    " 부모 노드 키 가져오기
*    READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_bsdata-parent_node_id.
*    IF sy-subrc = 0.
*      lv_rkey = ls_key_map-key.
*    ELSE.
*      lv_rkey = ''. " 최상위 노드일 경우
*    ENDIF.
*
*    " 폴더 여부
*    IF gs_bsdata-node_type = 'H'.
*      ls_layout-isfolder = 'X'.
*      lv_node_text = gs_bsdata-node_name.
*    ELSE.
*      lv_node_text = |{ gs_bsdata-node_name }|.
*    ENDIF.
*
*    CALL METHOD go_tree->add_node
*      EXPORTING
*        i_relat_node_key = lv_rkey
*        i_relationship   = cl_gui_column_tree=>relat_last_child
*        i_node_text      = lv_node_text
*        is_outtab_line   = gs_bsdata
*        is_node_layout   = ls_layout
*      IMPORTING
*        e_new_node_key   = lv_nkey.
*
*    "레이아웃
*    PERFORM create_item_layouts CHANGING lt_layout_item.
*
*    " 키 매핑
*    ls_key_map-node_id = gs_bsdata-node_id.
*    ls_key_map-key     = lv_nkey.
*    INSERT ls_key_map INTO TABLE lt_node_key_map.
*
*  ENDLOOP.
*************************************

  CALL METHOD : go_tree->update_calculations,
                go_tree->frontend_update,
                cl_gui_cfw=>flush.

  PERFORM refresh_node_text.    "node 리프레시

*-- 전체 폴더 노드 펼치기
  LOOP AT lt_node_key_map INTO ls_key_map.
    READ TABLE gt_bsdata INTO gs_bsdata WITH KEY node_id = ls_key_map-node_id.
    IF sy-subrc = 0 AND gs_bsdata-node_type = 'H'.
      CALL METHOD go_tree->expand_node
        EXPORTING
          i_node_key       = ls_key_map-key
          i_level_count    = 1
          i_expand_subtree = 'X'.
    ENDIF.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_item_layouts
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- LT_LAYOUT_ITEM
*&---------------------------------------------------------------------*
FORM create_item_layouts  CHANGING pt_item_layout TYPE lvc_t_layi.

  DATA: ls_item_layout TYPE lvc_s_layi.

  CLEAR pt_item_layout.
  LOOP AT gt_fcat INTO gs_fcat.
    CLEAR ls_item_layout.
    IF gs_fcat-no_out EQ space.
      ls_item_layout-fieldname = gs_fcat-fieldname.
      APPEND ls_item_layout TO pt_item_layout.
    ENDIF.
  ENDLOOP.

  CLEAR ls_item_layout.
  ls_item_layout-fieldname = go_tree->c_hierarchy_column_name.
  APPEND ls_item_layout TO pt_item_layout.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_node_text
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_node_text .

  LOOP AT gt_bsdata INTO gs_bsdata.

    " 폴더 노드만 갱신
    IF gs_bsdata-node_type = 'H'.

      READ TABLE lt_node_key_map INTO ls_key_map WITH KEY node_id = gs_bsdata-node_id.
      IF sy-subrc = 0.

        CALL METHOD go_tree->change_node
          EXPORTING
            i_node_key    = ls_key_map-key
            i_outtab_line = gs_bsdata.

      ENDIF.

    ENDIF.

  ENDLOOP.

  CALL METHOD go_tree->frontend_update.
  CALL METHOD cl_gui_cfw=>flush.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_second_node
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_second_node .

*-- 폴더별로 합계를 집계하는 코드
  DATA : lt_reverse LIKE TABLE OF gs_bsdata,
         ls_sum     TYPE ty_sum.

*-- 1) 역순으로 정렬
  lt_reverse = gt_bsdata.
  SORT lt_reverse BY parent_node_id DESCENDING.

*-- 2) 집계 루프
  LOOP AT lt_reverse INTO DATA(ls_node).

    READ TABLE gt_bsdata INTO DATA(ls_parent)
    WITH KEY node_id = ls_node-parent_node_id.

    IF sy-subrc = 0.

      ls_parent-prev_amt = ls_parent-prev_amt + ls_node-prev_amt.
      ls_parent-curr_amt = ls_parent-curr_amt + ls_node-curr_amt.

      MODIFY gt_bsdata FROM ls_parent TRANSPORTING prev_amt curr_amt
      WHERE node_id = ls_parent-node_id.

    ENDIF.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_first_node
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_first_node .

  DATA: lv_prev TYPE wrbtr,
        lv_curr TYPE wrbtr.

  CLEAR: lv_prev, lv_curr.

  READ TABLE gt_bsdata INTO DATA(ls_h100) WITH KEY node_id = 'H100'. "자산
  READ TABLE gt_bsdata INTO DATA(ls_a110) WITH KEY node_id = 'A110'. "유동자산
  READ TABLE gt_bsdata INTO DATA(ls_a120) WITH KEY node_id = 'A120'. "비유동자산

  IF sy-subrc = 0.
    " 계산 수행
    ls_h100-prev_amt = ls_a110-prev_amt + ls_a120-prev_amt.
    ls_h100-curr_amt = ls_a110-curr_amt + ls_a120-curr_amt.

    MODIFY gt_bsdata FROM ls_h100 TRANSPORTING prev_amt curr_amt
      WHERE node_id = 'H100'.
  ENDIF.
**********************************************************************

  READ TABLE gt_bsdata INTO DATA(ls_h200) WITH KEY node_id = 'H200'. "부채
  READ TABLE gt_bsdata INTO DATA(ls_a210) WITH KEY node_id = 'A210'. "유동부채
  READ TABLE gt_bsdata INTO DATA(ls_a220) WITH KEY node_id = 'A220'. "비유동부채
  " 계산 수행
  IF sy-subrc = 0.
    ls_h200-prev_amt = ls_a210-prev_amt + ls_a210-prev_amt.
    ls_h200-curr_amt = ls_a220-curr_amt + ls_a220-curr_amt.

    MODIFY gt_bsdata FROM ls_h200 TRANSPORTING prev_amt curr_amt
      WHERE node_id = 'H200'.
  ENDIF.

**********************************************************************

* 자본 = 자산 - 부채
  READ TABLE gt_bsdata INTO DATA(ls_h300) WITH KEY node_id = 'H300'.

  IF sy-subrc = 0.
    ls_h300-prev_amt = ls_h100-prev_amt - ls_h200-prev_amt.
    ls_h300-curr_amt = ls_h100-curr_amt - ls_h200-curr_amt.

    MODIFY gt_bsdata FROM ls_h300 TRANSPORTING prev_amt curr_amt
      WHERE node_id = 'H300'.
  ENDIF.

**********************************************************************
  " 자본금
  READ TABLE gt_bsdata INTO DATA(ls_capital) WITH KEY node_name = '자본금'.
  IF sy-subrc = 0.
    ls_capital-curr_amt = ls_h300-curr_amt * '0.2'.
    ls_capital-prev_amt = ls_h300-prev_amt * '0.2'.
    MODIFY gt_bsdata FROM ls_capital TRANSPORTING curr_amt prev_amt WHERE node_name = '자본금'.
  ENDIF.

  " 자본잉여금
  READ TABLE gt_bsdata INTO DATA(ls_surplus) WITH KEY node_name = '자본잉여금'.
  IF sy-subrc = 0.
    ls_surplus-curr_amt = ls_h300-curr_amt * '0.4'.
    ls_surplus-prev_amt = ls_h300-prev_amt * '0.4'.
    MODIFY gt_bsdata FROM ls_surplus TRANSPORTING curr_amt prev_amt WHERE node_name = '자본잉여금'.
  ENDIF.

  " 이익잉여금
  READ TABLE gt_bsdata INTO DATA(ls_retained) WITH KEY node_name = '이익잉여금'.
  IF sy-subrc = 0.
    ls_retained-curr_amt = ls_h300-curr_amt * '0.1'.
    ls_retained-prev_amt = ls_h300-prev_amt * '0.1'.
    MODIFY gt_bsdata FROM ls_retained TRANSPORTING curr_amt prev_amt WHERE node_name = '이익잉여금'.
  ENDIF.

  " 기타포괄손익누계액
  READ TABLE gt_bsdata INTO DATA(ls_oci) WITH KEY node_name = '기타포괄손익누계액'.
  IF sy-subrc = 0.
    ls_oci-curr_amt = ls_h300-curr_amt * '0.3'.
    ls_oci-prev_amt = ls_h300-prev_amt * '0.3'.
    MODIFY gt_bsdata FROM ls_oci TRANSPORTING curr_amt prev_amt WHERE node_name = '기타포괄손익누계액'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form pdf_job
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM pdf_job .

  DATA : lv_line   TYPE i,
         lv_answer.

*-- Dialog box
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '다운로드'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer = '2'.  " No를 선택하면 종료
    RETURN.
  ENDIF.

  IF lv_answer NE '1'.
    EXIT.
  ENDIF.

  IF objfile IS  INITIAL.
    TRY.
        CREATE OBJECT objfile.
    ENDTRY.
  ENDIF.
*-- Open file save window -------------------------------------------*
  IF pfolder IS NOT INITIAL.
    initialfolder = pfolder.
  ELSE.
    objfile->get_temp_directory( CHANGING temp_dir = initialfolder
                                 EXCEPTIONS cntl_error = 1
                                           error_no_gui = 2
                                           not_supported_by_gui = 3 ).
  ENDIF.

  objfile->directory_browse( EXPORTING initial_folder = initialfolder
                             CHANGING selected_folder = pickedfolder
                             EXCEPTIONS cntl_error = 1
                                        error_no_gui = 2
                                        not_supported_by_gui = 3 ).

  IF sy-subrc = 0.
    pfolder = pickedfolder.
  ELSE.
    MESSAGE 'An error has occured picking a folder' TYPE 'I' DISPLAY LIKE 'W'.
    EXIT.
  ENDIF.
*--------------------------------------------------------------------*
  IF pfolder IS INITIAL.
    EXIT.
  ENDIF.

  CALL METHOD objfile->free.
  FREE objfile.

  PERFORM download_excel.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_excel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM download_excel .

  DATA : lv_rc  TYPE i.
  DATA: lv_date TYPE c LENGTH 8,
        lv_time TYPE c LENGTH 4,
        lv_name TYPE rlgrap-filename.

**-- 파일명 만들기용 기준 데이터(클릭된 행에 대한 data를 출력하는 경우)
*  READ TABLE gt_bsdata INTO gs_bsdata INDEX 1.
*  IF sy-subrc <> 0.
*    MESSAGE '선택된 데이터가 없습니다.' TYPE 'E'.
*    EXIT.
*  ENDIF.

*-- File name
  CLEAR gv_temp_filename.
  lv_date = sy-datum(4).      " 오늘 날짜 (예: 20250417)
  lv_time = sy-uzeit(4).      " 시분만 (예: 1352)

  CONCATENATE 'S-AIR' lv_date '년도' '_' '재무상태표' sy-uzeit '.XLSX'
              INTO lv_name.

  CONCATENATE pfolder '\' lv_name INTO gv_temp_filename.

  gv_form = 'ZBS_TEMPLATE'.
  PERFORM download_template   USING gv_form gv_temp_filename.
  PERFORM open_excel_template USING gv_form.

*-- pdf data 추가
  PERFORM fill_excel_line.

*-- 기본적으로 Sheet 1을 보여주도록 셋팅
  CALL METHOD OF excel 'SHEETS' = sheet EXPORTING #1 = 1.
  CALL METHOD OF sheet 'SELECT' NO FLUSH.

*-- 모두 출력후 맨윗칸으로 커서 이동
  CALL METHOD OF excel 'Cells' = cell
    EXPORTING
      #1 = 1
      #2 = 1.

  CALL METHOD OF cell 'Select'.

  SET PROPERTY OF excel 'VISIBLE' = 1 . "엑셀 데이터를 다 뿌리고나서 보여줌

  PERFORM convert_to_pdf.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&      --> GV_TEMP_FILENAME
*&---------------------------------------------------------------------*
FORM download_template  USING p_zform p_filename.

  DATA : wwwdata_item LIKE wwwdatatab,
         rc           TYPE i.

  gv_file = p_filename.

  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = gv_file
    IMPORTING
      return = rc.

  IF rc = 0 OR rc = 1.

  ELSE.
    MESSAGE e001  WITH '임시파일 초기화 실패.'
                       '이전에 Excel에서 자료를 OPEN하였는지 확인.'.
  ENDIF.

  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
   WHERE objid = p_zform.

  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = gv_file.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form open_excel_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&---------------------------------------------------------------------*
FORM open_excel_template  USING    p_zform.

  IF excel IS INITIAL.
    CREATE OBJECT excel 'EXCEL.APPLICATION'.
  ENDIF.

  IF sy-subrc NE 0.
    MESSAGE i001 WITH sy-msgli.
  ENDIF.

  CALL METHOD OF excel 'WORKBOOKS' = workbook.
  SET PROPERTY OF excel 'VISIBLE' = 0 .

  CALL METHOD OF workbook 'OPEN' EXPORTING #1 = gv_file.

*-- Sheet에대한 설정을 할때 사용된다.

  GET PROPERTY OF : workbook    'Application' = application,
                    application 'ActiveSheet' = activesheet.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_excel_line
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_excel_line .

  DATA : lv_total_liability TYPE p DECIMALS 0,
         lv_total_equity    TYPE p DECIMALS 0,
         lv_total_sum       TYPE p DECIMALS 0,
         lv_char_date(10).


  DATA : lv_belnr      TYPE bkpf-belnr,
         lv_line       TYPE i,
         lv_amount(20),
         lv_date(10),
         lv_dmbtr_text TYPE c LENGTH 30,
         lv_text(50).

**********************************************************************
* Write Document header
**********************************************************************

  CASE pa_qua.
    WHEN 1.
      lv_char_date = '3월 31일'.
    WHEN 2.
      lv_char_date = '6월 30일'.
    WHEN 3.
      lv_char_date = '9월 30일'.
    WHEN 4.
      lv_char_date = '12월 31일'.
  ENDCASE.

*-- 날짜 텍스트 생성 및 출력 (손익계산서 상단용)
  lv_text = |{ pa_gjahr }년도 { lv_char_date }|.
  PERFORM fill_cells USING 3 2 lv_text. " 날짜는 루프 밖에서 1회만 출력

  LOOP AT gt_bsdata INTO gs_bsdata.

    CASE gs_bsdata-node_id.
*유동자산
      WHEN  'A110'. "유동자산
        gs_bsdata-excel_row = 6.

      WHEN 'B100001'. "현금
        gs_bsdata-excel_row = 7.
      WHEN 'B100002'." 보통예금
        gs_bsdata-excel_row = 8.
      WHEN 'B100004'." 외상매출금
        gs_bsdata-excel_row = 9.
      WHEN 'B100005'." 카드미수금
        gs_bsdata-excel_row = 10.
      WHEN 'B100006'." 미수금
        gs_bsdata-excel_row = 11.
      WHEN 'B100007'." 선급금
        gs_bsdata-excel_row = 12.
      WHEN 'B100008'. " 선급비용
        gs_bsdata-excel_row = 13.
      WHEN 'B100009'. " 부가세대급금
        gs_bsdata-excel_row = 14.
      WHEN 'B100010'. "매입부가세
        gs_bsdata-excel_row = 15.
*비유동자산
      WHEN 'A120'. "비유동자산
        gs_bsdata-excel_row = 16.

      WHEN 'B100011'. "자재재고
        gs_bsdata-excel_row = 17.

      WHEN 'B100012'. "상품재고
        gs_bsdata-excel_row = 18.

      WHEN 'B100014'. "비품
        gs_bsdata-excel_row = 19.

      WHEN 'B100015'. "감가상각누계액
        gs_bsdata-excel_row = 20.

      WHEN 'B100016'. "상각자산
        gs_bsdata-excel_row = 21.

      WHEN  'B100017'. "무형자산
        gs_bsdata-excel_row = 22.

      WHEN 'H100'. "자산총계
        gs_bsdata-excel_row = 23.

*부채
      WHEN 'A210'. "유동부채
        gs_bsdata-excel_row = 24.

      WHEN 'B200001'. "외상매입금
        gs_bsdata-excel_row = 25.

      WHEN 'B200002'. "미지급금
        gs_bsdata-excel_row = 26.

      WHEN 'B200003'. "카드 미지급금
        gs_bsdata-excel_row = 27.

      WHEN 'A220'. "비유동부채
        gs_bsdata-excel_row = 28.

      WHEN 'B200007'. "계약부채
        gs_bsdata-excel_row = 29.

      WHEN 'B200008'. "매출부가세
        gs_bsdata-excel_row = 30.

      WHEN 'H200'.  "부채 총계
        gs_bsdata-excel_row = 31.
        lv_total_liability = gs_bsdata-curr_amt.
*자본
      WHEN 'H300'. "자본
        gs_bsdata-excel_row = 32.
        lv_total_equity = gs_bsdata-curr_amt.
      WHEN 'B300001'. "자본금
        gs_bsdata-excel_row = 33.
      WHEN 'B300002'. "자본잉여금
        gs_bsdata-excel_row = 34.
      WHEN 'B300003'. "이익잉여금
        gs_bsdata-excel_row = 35.
      WHEN 'B300004'. "기타포괄손익누계액
        gs_bsdata-excel_row = 36.

    ENDCASE.

    WRITE gs_bsdata-curr_amt TO lv_dmbtr_text CURRENCY 'KRW'.
    PERFORM fill_cells USING gs_bsdata-excel_row 3 lv_dmbtr_text.

*    MODIFY gt_bsdata FROM gs_bsdata TRANSPORTING excel_row.

  ENDLOOP.

* 부채총계 + 자본총계 계산해서 36행에 넣기
  lv_total_sum = lv_total_liability + lv_total_equity.

  WRITE lv_total_sum TO lv_dmbtr_text CURRENCY 'KRW'.
  PERFORM fill_cells USING 37 3 lv_dmbtr_text.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_cells
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_BSDATA_EXCEL_ROW
*&      --> P_3
*&      --> GS_BSDATA_CURR_AMT
*&---------------------------------------------------------------------*
FORM fill_cells  USING    i j val.

  CALL METHOD OF excel 'CELLS' = cell
    EXPORTING
      #1 = i  " 행
      #2 = j. " 열

  SET PROPERTY OF cell 'VALUE' = val.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form convert_to_pdf
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM convert_to_pdf .

  DATA lv_rc TYPE i.

  CLEAR gv_temp_filename_pdf.
  CONCATENATE pfolder '\' '재무상태표' '.pdf'
              INTO gv_temp_filename_pdf.

  GET PROPERTY OF excel 'Workbooks' = workbook
    EXPORTING #1 = 1.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = '0'
      #2 = gv_temp_filename_pdf.

  CALL METHOD OF workbook 'Close'
    EXPORTING
      #1 = 0.

  CALL METHOD OF excel 'Quit'.

  CALL METHOD cl_gui_frontend_services=>file_delete
    EXPORTING
      filename = CONV #( gv_temp_filename )
    CHANGING
      rc       = lv_rc.

  CALL METHOD OF workbook 'ExportAsFixedFormat'
    EXPORTING
      #1 = 0
      #2 = gv_temp_filename_pdf.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form gjarh
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM gjarh .

  DATA(lv_year_now) = sy-datum(4). " 현재 연도 가져오기 (예: '2025')

  IF pa_gjahr > lv_year_now.
    MESSAGE e077(zmsgc103)." '회계연도는 현재연도보다 클 수 없습니다.'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form check_fit_100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_fit_100 .

  DATA: lv_today TYPE sy-datum.

  lv_today = sy-datum.

  " 분기 종료일이 오늘 이후이거나 오늘인 경우 → 아직 결산되지 않은 분기
  IF gv_date_to >= lv_today.
    MESSAGE '아직 결산되지 않은 분기입니다.' TYPE 'S' DISPLAY LIKE 'E'.
  ELSE.
    CALL SCREEN 100.
  ENDIF.

ENDFORM.

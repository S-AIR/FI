``` abap
*&---------------------------------------------------------------------*
*& Include          ZC103FIR0012F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form get_base_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_base_data .

  DATA: lv_pattern TYPE string.  "이름 검색용 패턴

  CLEAR :gt_emp, gs_emp, lv_pattern.
  lv_pattern = '%' && gv_empname && '%'.  "LIKE 검색용 패턴 구성

*  IF gv_epos IS NOT INITIAL AND
*     ( gv_epos < '01' OR gv_epos > '08' ).
*    MESSAGE s044 DISPLAY LIKE 'E'.
*    RETURN.
*  ENDIF.

  "조회조건에 따라 직원 마스터 테이블 조회
  SELECT
    FROM zc103fit0011
    FIELDS  empno, dptcode, empname, telno, birth, gender, email, joindate, resdate, emppos,
           approver_yn ,erdat, erzet, ernam, aedat, aezet, aenam
    WHERE ( dptcode = @gv_dptcode OR @gv_dptcode IS INITIAL )
    AND   ( emppos = @gv_epos OR @gv_epos IS INITIAL )
    AND   ( empname LIKE @lv_pattern OR @gv_empname IS INITIAL )
    ORDER BY empno
    INTO CORRESPONDING FIELDS OF TABLE @gt_emp.

  "조회결과 없음 메시지 처리
  IF gt_emp IS INITIAL.
    MESSAGE s003 DISPLAY LIKE 'E'. " 데이터 없음
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_displayscreen100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_displayscreen100 .

  IF ( go_container IS NOT BOUND ) .

    PERFORM set_fcat USING : 'X' 'EMPNO' 'ZC103FIT0011' '직원 번호' ' ' ' ' 1,
                             ' ' 'EMPNAME' 'ZC103FIT0011' '직원이름' ' ' 'X' 2,
                             'X' 'DPTCODE' 'ZC103FIT0011' '부서코드' 'C' ' ' 3 ,
                             ' ' 'NUMTEXT' 'DD07V'  '부서명' ' ' 'X'       4,
                             ' ' 'TELNO' 'ZC103FIT0011' '연락처' ' ' ' '   5,
                             ' ' 'BIRTH' 'ZC103FIT0011' '생년월일' 'C' ' ' 6,
                             ' ' 'GENDER' 'ZC103FIT0011' '성별코드' 'C' ' ' 7,
                             ' ' 'GENTEXT' 'DD07V' '성별' ' ' 'X' 8,
                             ' ' 'EMAIL' 'ZC103FIT0011' '이메일' ' ' ' ' 9,
                             ' ' 'JOINDATE' 'ZC103FIT0011' '입사일자' 'C'  ' ' 10,
                             ' ' 'RESDATE' 'ZC103FIT0011' '퇴사일자' 'C' ' ' 11,
                             ' ' 'EMPPOS' 'ZC103FIT0011' '직급코드' 'C' ' ' 12,
                             ' ' 'DOTEXT'      'DD07V'        '직급명' 'C' 'X' 13,
                             ' '  'APPROVER_YN' 'ZC103FIT0011' '결재자여부' ' ' ' ' 14.


    PERFORM set_layout.
    PERFORM exclude_toolbar.
    PERFORM create_object.

    SET HANDLER : lcl_event_handler=>modify_value FOR go_alv_grid,
                  lcl_event_handler=>edit_toolbar FOR go_alv_grid,
                  lcl_event_handler=>user_command FOR go_alv_grid,
                  lcl_event_handler=>hotspot_click FOR go_alv_grid.
*--display ALV1
    CALL METHOD go_alv_grid->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_emp
        it_fieldcatalog      = gt_fcat.

*--변경 이벤트 등록
    PERFORM register_event.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_fcat  USING  pv_key pv_field pv_table pv_coltext pv_just pv_emph pv_col_pos.

  gs_fcat-key       = pv_key.
  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-coltext   = pv_coltext.
  gs_fcat-just      = pv_just.
  gs_fcat-emphasize = pv_emph.
  gs_fcat-col_pos   = pv_col_pos.

  CASE pv_field.
    WHEN 'APPROVER_YN'.
      gs_fcat-checkbox = 'X'.
      gs_fcat-edit     = ''.

    WHEN 'EMPNO'.
      gs_fcat-hotspot = 'X' .
  ENDCASE.

  APPEND gs_fcat TO gt_fcat.
  CLEAR gs_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout .

*-- Variant
  gs_variant-report = sy-repid.
  gs_variant-handle = 'ALV1'.

*-- Layout
  gs_layout-zebra      = abap_true.
  gs_layout-cwidth_opt = 'A'.
  gs_layout-sel_mode   = 'D'.
  gs_layout-stylefname = 'CELL_TAB'.  " cell_tab 등록 'crud할때 지브라 씹히나바'

ENDFORM.
*&---------------------------------------------------------------------*
*& Form exclude_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM exclude_toolbar .

  DATA : ls_ui_functions TYPE ui_func.

  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_copy_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_auf.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_average.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_print.
  APPEND ls_ui_functions TO gt_ui_functions.
  ls_ui_functions = cl_gui_alv_grid=>mc_fc_graph.
  APPEND ls_ui_functions TO gt_ui_functions.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_object
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_object .

*-- Container1
  CREATE OBJECT go_container
    EXPORTING
      container_name = 'MAIN_CONT'.

*-- ALV1
  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = go_container.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_edit_toolbar
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_OBJECT
*&      --> E_INTERACTIVE
*&---------------------------------------------------------------------*
FORM handle_edit_toolbar  USING     po_object TYPE REF TO cl_alv_event_toolbar_set
                                   pv_interactive.
  DATA : lv_disabled.

  IF gv_mode EQ 'D'.
    lv_disabled = abap_true.
  ENDIF.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-function  = 'CHANGE'.
  gs_button-icon      = icon_toggle_display_change.
  gs_button-quickinfo = '편집'.
*  gs_button-text      = TEXT-100.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-function  = 'OUT'.
  gs_button-icon      = icon_next_object.
  gs_button-quickinfo = '퇴사처리'.
  gs_button-text      = TEXT-101.
  gs_button-disabled  = lv_disabled.  " 수정모드일 때만 활성화
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-function  = 'CREA'.
  gs_button-icon      = icon_create.
  gs_button-quickinfo = '생성'.
  gs_button-text      = TEXT-104.
  gs_button-disabled  = lv_disabled.  " 수정모드일 때만 활성화
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

*  CLEAR gs_button.
*  gs_button-function  = 'SAVED'.
*  gs_button-icon      = icon_system_save.
*  gs_button-quickinfo = '저장'.
*  gs_button-text      = TEXT-105.
**  gs_button-disabled  = lv_disabled.  " 수정모드일 때만 활성화
*  APPEND gs_button TO po_object->mt_toolbar.
*
*  CLEAR gs_button.
*  gs_button-butn_type = '3'.
*  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-function  = 'DELETE'.
  gs_button-icon      = icon_delete_row.
  gs_button-quickinfo = '삭제'.
  gs_button-text      = TEXT-103.
  gs_button-disabled  = lv_disabled.  " 수정모드일 때만 활성화
  APPEND gs_button TO po_object->mt_toolbar.

  CLEAR gs_button.
  gs_button-butn_type = '3'.
  APPEND gs_button TO po_object->mt_toolbar.

*  CLEAR gs_button.
*  gs_button-function  = 'SRCH'.
*  gs_button-icon      = icon_search.
*  gs_button-quickinfo = '직원검색'.
*  gs_button-text      = TEXT-102.
**  gs_button-disabled  = lv_disabled.  " 수정모드일 때만 활성화
  APPEND gs_button TO po_object->mt_toolbar.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_UCOMM
*&---------------------------------------------------------------------*
FORM handle_user_command  USING    pv_ucomm.

  CASE pv_ucomm.
    WHEN 'CHANGE'.
      PERFORM edit.
*      PERFORM set_screen.
*      PERFORM refresh_screen USING go_alv_grid.
    WHEN 'OUT'.
      PERFORM set_out_row.
    WHEN 'DELETE'.
      PERFORM set_delete_row.
*    when 'CTR'.  "생성버튼
*      PERFORM create_empinfo.
    WHEN 'CREA'.
      PERFORM create_emp.
*    WHEN 'SAVED'.
*      PERFORM save_data.

    WHEN 'SRCH'.
      CALL SCREEN 200 STARTING AT 10 5 ENDING AT 120 20.

  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_empinfo
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_empinfo .

  DATA: lv_number  TYPE n LENGTH 3,
        lv_padded  TYPE string,
        lo_matcher TYPE REF TO cl_abap_matcher.
  "----------------------------------------------------------------------
  " 필수 입력값 체크
  "----------------------------------------------------------------------
  IF pv_dptcode IS INITIAL OR
     pv_empname IS INITIAL OR
     pv_telno IS INITIAL OR
     pv_birth IS INITIAL OR
     pv_gender IS INITIAL OR
     pv_email IS INITIAL OR
     pv_joindate IS INITIAL OR
     pv_emppos IS INITIAL.

    MESSAGE s020 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  "----------------------------------------------------------------------
  " [이름] 유효성 검사
  "----------------------------------------------------------------------
  " 이름에 숫자 포함 여부 체크
  FIND REGEX '[0-9]' IN pv_empname MATCH OFFSET DATA(lv_num_off).
  IF sy-subrc = 0.
    MESSAGE s041 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " 이름에 특수기호 포함 여부 체크
  FIND REGEX '[^a-zA-Z가-힣\s]' IN pv_empname MATCH OFFSET DATA(lv_sym_off).
  IF sy-subrc = 0.
    MESSAGE s041 DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " 진짜 공백만 입력한 경우 (여기서만 CONDENSE 사용)
  DATA(lv_trimmed) = pv_empname.
  CONDENSE lv_trimmed.
  IF lv_trimmed IS INITIAL.
    MESSAGE '이름은 필수 입력 항목입니다.' TYPE 'E'.
    RETURN.
  ENDIF.

  "----------------------------------------------------------------------
  " [이메일] 유효성 검사
  "----------------------------------------------------------------------
  " 이메일 공백 제거 및 소문자 변환
  CONDENSE pv_email.
  TRANSLATE pv_email TO LOWER CASE.

  " 이메일 한글 포함 불가
  FIND REGEX '[가-힣]' IN pv_email MATCH OFFSET DATA(lv_match).
  IF sy-subrc = 0.
    MESSAGE s079 DISPLAY LIKE 'E'. " 이메일주소에 한글이 포함될 수 없습니다. 영문/ 영문+숫자 조합만 가능합니다.
    RETURN.
  ENDIF.

  " 이메일 형식 체크 (@ 포함)
  IF NOT pv_email CP '*@s-air.com'.
    MESSAGE s037 DISPLAY LIKE 'E'. " '이메일 형식이 올바르지 않습니다.'
    RETURN.
  ENDIF.

  " 특수문자 포함 여부 검사 (허용: 영문, 숫자, @, .)
  DATA: lv_local_part TYPE string, "@ 문자의 위치
        lv_at_pos     TYPE i. "이메일의 앞부분,

  FIND '@' IN pv_email MATCH OFFSET lv_at_pos.
  IF sy-subrc = 0 AND lv_at_pos > 0.
    lv_local_part = substring( val = pv_email off = 0 len = lv_at_pos ).
  ENDIF.

* 이메일 앞부분에 허용되지 않은 문자 포함 여부 검사
* 허용: 영문(a-zA-Z), 숫자(0-9)만
  DATA(lo_matcher_front) = cl_abap_matcher=>create(
    pattern     = '^[a-zA-Z0-9]+$'
    text        = lv_local_part
    ignore_case = abap_true ).

  IF lo_matcher_front->match( ) = abap_false.
    MESSAGE s037 DISPLAY LIKE 'E'. " 이메일 앞부분에 특수문자를 포함할 수 없습니다.
    RETURN.
  ENDIF.

  " 이메일 앞부분이 숫자만인지 확인
  DATA(lo_matcher_email) = cl_abap_matcher=>create(
    pattern     = '^[0-9]+$'      "정규표현식 '^[0-9]+$' 는 "숫자만 있을 때" 를 의미함
    text        = lv_local_part   "lv_local_part (즉, 이메일 앞부분)
    ignore_case = abap_true ).

  IF lo_matcher_email->match( ) = abap_true.
    MESSAGE s055 DISPLAY LIKE 'E'.  " **"이메일 앞부분이 숫자로만 이루어졌는지 확인하고, 그렇다면 에러 메시지를 출력하고 중단한다"**
    RETURN.
  ENDIF.

  " 이메일 중복 체크
  READ TABLE gt_emp WITH KEY email = pv_email TRANSPORTING NO FIELDS.
  IF sy-subrc = 0.
    MESSAGE s039 DISPLAY LIKE 'E'."'이미 등록된 이메일입니다'.
    RETURN.
  ENDIF.

  "----------------------------------------------------------------------
  " [전화번호] 유효성 검사
  "----------------------------------------------------------------------
  "전화번호 포맷 체크
  DATA(lo_tel_matcher) = cl_abap_matcher=>create(
    pattern     = '^010-\d{4}-\d{4}$'
    text        = pv_telno
    ignore_case = abap_false ).

  IF lo_tel_matcher->match( ) = abap_false.
    MESSAGE s040 DISPLAY LIKE 'E'. "'전화번호 형식이 올바르지 않습니다. 예) 010-1234-5678'
    RETURN.
  ENDIF.

  " 전화번호 중복 체크
  READ TABLE gt_emp WITH KEY telno = pv_telno TRANSPORTING NO FIELDS.
  IF sy-subrc = 0.
    MESSAGE s038 DISPLAY LIKE 'E'. "'이미 등록된 전화번호입니다'.
    RETURN.
  ENDIF.

  "----------------------------------------------------------------------
  " 날짜 유효성 검사
  "----------------------------------------------------------------------
*--생년월일 유효성 검사
  IF pv_birth > sy-datum.
    MESSAGE s043 DISPLAY LIKE 'E'. " '생년월일은 미래일 수 없습니다'
    RETURN.
  ENDIF.

***입사일자
  IF pv_joindate > sy-datum.
    MESSAGE s045 DISPLAY LIKE 'E'." '입사일자를 다시 확인해주세요' TYPE 'E'.
    RETURN.
  ENDIF.

  "----------------------------------------------------------------------
  " 신규 직원 정보 구성
  "----------------------------------------------------------------------
  CLEAR gs_emp.

  gs_emp-dptcode  = pv_dptcode.
  gs_emp-empname  = pv_empname.
  gs_emp-telno    = pv_telno.
  gs_emp-birth    = pv_birth.
  gs_emp-gender   = pv_gender.
  gs_emp-email    = pv_email.
  gs_emp-joindate = pv_joindate.
  gs_emp-emppos   = pv_emppos.
  gs_emp-modi_yn = abap_true.

  " 부서명 텍스트 변환
  CASE gs_emp-dptcode.
    WHEN 'FI'.
      gs_emp-numtext = '회계부서'.
    WHEN 'PM'.
      gs_emp-numtext = '설비관리부서'.
    WHEN 'MM'.
      gs_emp-numtext = '구매부서'.
    WHEN 'SD'.
      gs_emp-numtext = '판매부서'.
    WHEN OTHERS.
  ENDCASE.

  " 성별 텍스트 변환
  CASE gs_emp-gender.
    WHEN 'W'.
      gs_emp-gentext = '여성'.
    WHEN 'M'.
      gs_emp-gentext = '남성'.
    WHEN OTHERS.
  ENDCASE.

  " 직급 텍스트 변환
  CASE gs_emp-emppos.
    WHEN '01'.
      gs_emp-dotext = '사원'.
    WHEN '02'.
      gs_emp-dotext = '주임'.
    WHEN '03'.
      gs_emp-dotext = '대리'.
    WHEN '04'.
      gs_emp-dotext = '과장'.
    WHEN '05'.
      gs_emp-dotext = '차상'.
    WHEN '06'.
      gs_emp-dotext = '부장'.
    WHEN '07'.
      gs_emp-dotext = '이사'.
    WHEN '08'.
      gs_emp-dotext = '대표'.
    WHEN OTHERS.
  ENDCASE.

  "----------------------------------------------------------------------
  " 결재자 여부 자동 체크: 직급이 '04'(과장) 이상이면 자동 결재자 지정
  "----------------------------------------------------------------------

  IF gs_emp-emppos >= 4.
    gs_emp-approver_yn = abap_true.
  ELSE.
    gs_emp-approver_yn = abap_false.
  ENDIF.

  "----------------------------------------------------------------------
  " 직원 정보 ALV 테이블에 추가 및 화면 갱신
  "----------------------------------------------------------------------
  APPEND gs_emp TO gt_emp.

  CALL METHOD go_alv_grid->refresh_table_display.
  PERFORM refresh_pop.

  LEAVE TO SCREEN 0.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_modify_value
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_MODIFIED
*&      --> ET_GOOD_CELLS
*&---------------------------------------------------------------------*
FORM handle_modify_value  USING   pv_modified
                                  pt_good_cells TYPE lvc_t_modi.

  CHECK pv_modified IS NOT INITIAL. " 수정 데이터가 없다면 EXIT

  LOOP AT pt_good_cells INTO DATA(ls_cells).  " 수정 데이터를 LOOP를 통해 반영

    CLEAR gs_emp.
    READ TABLE gt_emp INTO gs_emp INDEX ls_cells-row_id.  " 수정 데이터 추출

*    CASE ls_cells-fieldname.  " 수정 데이터 필드에 따라 수정 사항 반영
*    ENDCASE.

*-- 수정 표시
    gs_emp-modi_yn = abap_true.

*-- 수정한 데이터 ITAB에 반영
    MODIFY gt_emp FROM gs_emp INDEX ls_cells-row_id
                                TRANSPORTING modi_yn.

    PERFORM refresh_screen USING go_alv_grid. " 수정 후 스크린 초기화
  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_screen USING po_object
                   TYPE REF TO cl_gui_alv_grid..

  DATA : ls_stable TYPE lvc_s_stbl. " 갱신 시에도 마우스 위치 고정

  ls_stable = VALUE #(
                         row = abap_true
                         col = abap_true
                      ).
  po_object->refresh_table_display(
    EXPORTING
      is_stable = ls_stable ).

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_delete_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_out_row .

  DATA: lv_tabix TYPE sy-tabix.

*-- 현재 선택된 ALV 행 가져오기
  CALL METHOD go_alv_grid->get_current_cell
    IMPORTING
      e_row = lv_tabix.

  IF lv_tabix IS INITIAL.
    MESSAGE '퇴사처리할 직원을 선택하세요.' TYPE 'S' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

*-- 선택된 행 데이터 읽기
  READ TABLE gt_emp INTO gs_emp INDEX lv_tabix.
  IF sy-subrc = 0.

    IF gs_emp-resdate IS NOT INITIAL.
      MESSAGE s029 DISPLAY LIKE 'E'.
    ENDIF.

*-- 퇴사일자 입력 및 수정 플래그
    gs_emp-resdate = sy-datum.
    gs_emp-modi_yn   = abap_true.

*-- 테이블에 반영
    MODIFY gt_emp FROM gs_emp INDEX lv_tabix
                             TRANSPORTING resdate modi_yn.


*-- ALV 갱신
    CALL METHOD go_alv_grid->refresh_table_display.
    MESSAGE s030 DISPLAY LIKE 'S'.

  ENDIF.

  PERFORM refresh_screen USING go_alv_grid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form register_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_event .

  CALL METHOD go_alv_grid->set_ready_for_input
    EXPORTING
      i_ready_for_input = 0.

  CALL METHOD go_alv_grid->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form save_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_data .

**********************************************************************
* DB Table의 Layout과 Internal table의 Layout은 100% 동일해야함
**********************************************************************
  DATA: lv_number TYPE n LENGTH 3,
        lv_padded TYPE string.

  DATA : lt_save   TYPE TABLE OF zc103fit0011,
         ls_save   TYPE zc103fit0011,
         lv_tabix  TYPE sy-tabix,
         lv_flag,
         lv_answer.

*-- ALV상에서 변경된 데이터가 있는지 체크후 Internal table에 반영.
  CALL METHOD go_alv_grid->check_changed_data.

*-- 변경사항이 있는지 확인
  CLEAR gs_emp.
  READ TABLE gt_emp INTO gs_emp WITH KEY modi_yn = abap_true.
  IF ( sy-subrc NE 0 ) AND
     ( gt_emp_d IS INITIAL ).
    MESSAGE s031 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

*-- Set Time stamp
  LOOP AT gt_emp INTO gs_emp WHERE modi_yn EQ abap_true.

    lv_tabix  = sy-tabix.

* 이메일 소문자 변환
    TRANSLATE gs_emp-email TO LOWER CASE.

* 이메일 한글 포함 불가
    IF gs_emp-email CP '*[가-힣]*'.
      MESSAGE s037 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

* 이메일 도메인 체크
    IF NOT gs_emp-email CP '*@s-air.com'.
      MESSAGE s037 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

* 중복체크 추가하기

* 이메일 앞부분 숫자만 입력 여부 검사
    DATA: lv_local_part TYPE string,
          lv_at_pos     TYPE i.

    FIND '@' IN gs_emp-email MATCH OFFSET lv_at_pos.
    IF sy-subrc = 0 AND lv_at_pos > 0.
      lv_local_part = gs_emp-email+0(lv_at_pos).

      DATA(lo_matcher_email) = cl_abap_matcher=>create(
        pattern     = '^[0-9]+$'
        text        = lv_local_part
        ignore_case = abap_true ).
      IF lo_matcher_email->match( ) = abap_true.
        MESSAGE s055 DISPLAY LIKE 'E'.
        RETURN.
      ENDIF.
    ENDIF.

*전화번호 유효성
    IF gs_emp-telno IS INITIAL.
      MESSAGE s056 DISPLAY LIKE 'E'. " 전화번호는 필수입니다.
      RETURN.
    ENDIF.

    DATA(lo_tel_matcher) = cl_abap_matcher=>create(
      pattern     = '^010-\d{4}-\d{4}$'
      text        = gs_emp-telno
      ignore_case = abap_false ).

    IF lo_tel_matcher->match( ) = abap_false.
      MESSAGE s040 DISPLAY LIKE 'E'. " 전화번호 형식이 올바르지 않습니다.
      RETURN.
    ENDIF.

* 이름 숫자/특수문자 금지
    FIND REGEX '[0-9]' IN gs_emp-empname MATCH OFFSET DATA(lv_num_off).
    IF sy-subrc = 0.
      MESSAGE s041 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    FIND REGEX '[^a-zA-Z가-힣\s]' IN gs_emp-empname MATCH OFFSET DATA(lv_sym_off).
    IF sy-subrc = 0.
      MESSAGE s041 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    DATA(lv_trimmed) = gs_emp-empname.
    CONDENSE lv_trimmed.
    IF lv_trimmed IS INITIAL.
      MESSAGE '이름은 필수 입력 항목입니다.' TYPE 'E'.
      RETURN.
    ENDIF.

* 성별 유효성
    IF gs_emp-gender <> 'M' AND gs_emp-gender <> 'W'.
      MESSAGE s042 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

* 생년월일 미래 불가
    IF gs_emp-birth > sy-datum.
      MESSAGE s043 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

* 입사일자 미래 불가
    IF gs_emp-joindate > sy-datum.
      MESSAGE s045 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

* 직급 유효성
    IF gs_emp-emppos < '01' OR gs_emp-emppos > '08'.
      MESSAGE s044 DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    IF gs_emp-empno IS INITIAL.

      CALL FUNCTION 'NUMBER_GET_NEXT'
        EXPORTING
          object        = 'ZC103FIEMP'
          nr_range_nr   = '01'
          ignore_buffer = 'X'
        IMPORTING
          number        = lv_number.


      IF sy-subrc <> 0.
        MESSAGE '직원번호 채번 실패!' TYPE 'E'. " ● 예외처리 추가
        RETURN.
      ENDIF.

      lv_padded = |{ lv_number WIDTH = 3 ALIGN = RIGHT PAD = '0' }|.
      gs_emp-empno = |ADMIN{ lv_padded }|.
    ENDIF.

    IF gs_emp-erdat  IS INITIAL.
      gs_emp-erdat = sy-datum.
      gs_emp-ernam = sy-uname.
      gs_emp-erzet = sy-uzeit.
    ELSE.
      gs_emp-aedat = sy-datum.
      gs_emp-aenam = sy-uname.
      gs_emp-aezet = sy-uzeit.
    ENDIF.

    CLEAR gs_emp-modi_yn.

    MODIFY gt_emp FROM gs_emp INDEX lv_tabix
                                TRANSPORTING empno erdat ernam erzet
                                             aedat aenam aezet
                                             modi_yn.

  ENDLOOP.

*-- Move data for save
  MOVE-CORRESPONDING gt_emp TO lt_save.


*-- 삭제대상이 있으면 삭제
  IF gt_emp_d IS NOT INITIAL.
    DELETE zc103fit0011 FROM TABLE gt_emp_d.
  ENDIF.

  CLEAR : gt_emp_d, gs_emp_d.

*-- Save data
  MODIFY zc103fit0011 FROM TABLE lt_save.
  IF sy-subrc EQ 0.
    MESSAGE s022 DISPLAY LIKE 'S'.
    COMMIT WORK.
  ELSE.
    ROLLBACK WORK.
  ENDIF.

*  PERFORM save_after.
  PERFORM set_screen.
  PERFORM refresh_screen USING go_alv_grid.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form call_pop_up
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_ANSWER
*&---------------------------------------------------------------------*
FORM call_pop_up  USING    pv_answer.

*-- Popup 창 호출 및 유저 응답 pv_answer에 저장해 전달
  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'User check'
      text_question         = 'Save OK?'
      text_button_1         = 'Yes'
      icon_button_1         = 'ICON_OKAY'
      text_button_2         = 'No'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '1'
      display_cancel_button = 'X'
    IMPORTING
      answer                = pv_answer.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_time_stamp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_time_stamp .

  DATA : lv_tabix TYPE sy-tabix.

  LOOP AT gt_emp INTO gs_emp WHERE modi_yn = abap_true.
    lv_tabix = sy-tabix.

    IF gs_emp-erdat IS INITIAL.
      gs_emp-erdat = sy-datum.
      gs_emp-ernam = sy-uname.
      gs_emp-erzet = sy-uzeit.

    ELSE.

      gs_emp-aedat = sy-datum.
      gs_emp-aenam = sy-uname.
      gs_emp-aezet = sy-uzeit.

    ENDIF.

    CLEAR gs_emp-modi_yn.
    MODIFY gt_emp FROM gs_emp INDEX lv_tabix TRANSPORTING
                                                  erdat ernam erzet
                                                  aedat aenam aezet
                                                  modi_yn.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_table .

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_screen .
*--도메인 텍스트 테이블 선언
  DATA: lt_emppos  TYPE TABLE OF dd07v,          "직급 도메인 텍스트
        ls_emppos  TYPE dd07v,
        lt_numtext TYPE TABLE OF dd07v,          "부서 도메인 텍스트
        ls_numtext TYPE dd07v,
        lt_gentext TYPE TABLE OF dd07v,          "성별 도메인 텍스트
        ls_gentext TYPE dd07v.

*-- 스타일 및 키값 처리용 변수
  DATA : ls_style       TYPE lvc_s_styl,         "ALV 스타일 구조
         lv_tabix       TYPE sy-tabix,           "인덱스 추적용
         lv_emppos_key  TYPE dd07v-domvalue_l,   "직급 도메인 키값
         lv_numtext_key TYPE dd07v-domvalue_l,   "부서 도메인 키값
         lv_gentext_key TYPE dd07v-domvalue_l.   "성별 도메인 키값

*--도메인 값 조회하는 콜펑션
  CALL FUNCTION 'GET_DOMAIN_VALUES'  "직급 도메인
    EXPORTING
      domname    = 'ZC103D_FI_POS'
      text       = abap_true
    TABLES
      values_tab = lt_emppos.

  CALL FUNCTION 'GET_DOMAIN_VALUES'  "부서 도메인
    EXPORTING
      domname    = 'ZC103D_FI_DPT'
      text       = abap_true
    TABLES
      values_tab = lt_numtext.


  CALL FUNCTION 'GET_DOMAIN_VALUES'  "성별 도메인
    EXPORTING
      domname    = 'ZD103E_FI_GEND'
      text       = abap_true
    TABLES
      values_tab = lt_gentext.

  CLEAR : gs_emp.
  LOOP AT  gt_emp INTO gs_emp.

    lv_tabix = sy-tabix.

    CLEAR : ls_style, gs_emp-cell_tab.

*-- 결재자 여부 자동 체크: 직급이 04(과장) 이상이면 체크

    IF gs_emp-emppos >= 4.
      gs_emp-approver_yn = abap_true.
    ELSE.
      gs_emp-approver_yn = abap_false.
    ENDIF.

*--편집 가능한 필드 스타일 설정
    ls_style-fieldname = 'DPTCODE'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname = 'EMPNAME'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'TELNO'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'BIRTH'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'GENDER'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'EMAIL'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'JOINDATE'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'RESDATE'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

    ls_style-fieldname =  'EMPPOS'.
    ls_style-style = cl_gui_alv_grid=>mc_style_enabled.
    INSERT ls_style INTO TABLE gs_emp-cell_tab.

*-- 도메인 키값 변환 처리 (NUMC → 문자 0패딩) ->
    lv_emppos_key = |{ gs_emp-emppos WIDTH = 2 PAD = '0' }|. "도메인 고정값이 2자리 문자(CHAR(2))인데, 테이블 필드는 숫자형(NUMC) 혹은 숫자 1자리일 수 있어서, 형식 맞추려고 패딩처리함.
    lv_numtext_key = gs_emp-dptcode.                         " 부서코드 (CHAR) "변환 필요없어서 안함.
    lv_gentext_key = gs_emp-gender.                          " 성별코드 (CHAR) "변환 필요없어서 안함.

    CONDENSE: lv_emppos_key NO-GAPS,
              lv_numtext_key NO-GAPS,
              lv_gentext_key NO-GAPS.

* 직급명
    READ TABLE lt_emppos INTO ls_emppos
         WITH KEY domvalue_l = lv_emppos_key.

    IF sy-subrc = 0.
      gs_emp-dotext = ls_emppos-ddtext.
    ELSE.
      gs_emp-dotext = ''. "매칭 실패 시 공백
    ENDIF.

*-- 부서 코드는 CHAR → 바로 사용 가능
    READ TABLE lt_numtext INTO ls_numtext
         WITH KEY domvalue_l = gs_emp-dptcode.
*
    IF sy-subrc = 0.
      gs_emp-numtext = ls_numtext-ddtext.
    ELSE.
      gs_emp-numtext = ''. " 또는 '기타'
    ENDIF.

* 성별 텍스트
    READ TABLE lt_gentext INTO ls_gentext
         WITH KEY domvalue_l = gs_emp-gender.
    IF sy-subrc = 0.
      gs_emp-gentext = ls_gentext-ddtext.
    ELSE.
      gs_emp-gentext = ''. " 또는 '기타'
    ENDIF.

* 가공 결과를 gt_emp에 반영
    MODIFY gt_emp FROM gs_emp INDEX lv_tabix TRANSPORTING cell_tab dotext numtext gentext approver_yn.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_style_field
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> CL_GUI_ALV_GRID=>MC_STYLE_ENAB
*&      <-- LS_STYLE
*&---------------------------------------------------------------------*
FORM set_style_field  USING    pv_field pv_mode

                      CHANGING ps_style TYPE lvc_s_styl.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form edit
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM edit .

  CASE gv_mode.
    WHEN 'E'.
      gv_mode = 'D'.
      CALL METHOD go_alv_grid->set_ready_for_input
        EXPORTING
          i_ready_for_input = 0.
    WHEN 'D'.
      gv_mode = 'E'.
      CALL METHOD go_alv_grid->set_ready_for_input
        EXPORTING
          i_ready_for_input = 1.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form upload_logic
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM upload_logic .

  " 엑셀 데이터 타입 정의
  TYPES: truxs_t_text_data(4096) TYPE c OCCURS 0.

  " 파일 다이얼로그용 변수
  DATA: lt_files  TYPE filetable,
        ls_files  LIKE LINE OF lt_files,
        lv_filter TYPE string,
        lv_path   TYPE rlgrap-filename,
        lv_rc     TYPE i.

  " 엑셀 읽기용 변수
  DATA: lt_excel TYPE TABLE OF alsmex_tabline WITH HEADER LINE,
        ls_excel TYPE alsmex_tabline,
        lv_index TYPE sy-tabix,
        lv_row   TYPE i VALUE 0.

  "  데이터 유효성 검사 변수
  DATA: lv_valid TYPE abap_bool VALUE abap_true.
  "  데이터 에러 변수
  DATA: lv_has_error TYPE abap_bool VALUE abap_false. "한 줄에서 lv_valid = abap_false되면 이걸 true로 바꿔줌:

  " 필드 매핑용 필드심볼
  FIELD-SYMBOLS: <field>.

  " 초기화
  CLEAR: gt_excel, gs_excel, lv_index.

*-----------------------------------------------------------------------
* 1. 파일 다이얼로그
*-----------------------------------------------------------------------
  CONCATENATE cl_gui_frontend_services=>filetype_excel
              'Excel 문서 (*.XLS)|*.XLS|'
              INTO lv_filter.

  CALL METHOD cl_gui_frontend_services=>file_open_dialog
    EXPORTING
      window_title            = '파일 열기'
      file_filter             = lv_filter
    CHANGING
      file_table              = lt_files
      rc                      = lv_rc
    EXCEPTIONS
      file_open_dialog_failed = 1
      cntl_error              = 2
      error_no_gui            = 3
      not_supported_by_gui    = 4
      OTHERS                  = 5.

  IF sy-subrc <> 0 OR lt_files IS INITIAL.
    MESSAGE '파일을 선택하지 않았습니다.' TYPE 'I'.
    RETURN.
  ENDIF.

  ls_files = lt_files[ 1 ].
  lv_path  = ls_files-filename.
*-----------------------------------------------------------------------
* 2. 엑셀 읽기
*-----------------------------------------------------------------------
  CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE'
    EXPORTING
      filename                = lv_path
      i_begin_col             = 3
      i_begin_row             = 6
      i_end_col               = 100
      i_end_row               = 50000
    TABLES
      intern                  = lt_excel
    EXCEPTIONS
      inconsistent_parameters = 1
      upload_ole              = 2
      OTHERS                  = 3.

  IF sy-subrc <> 0 OR lt_excel[] IS INITIAL.
    MESSAGE '엑셀 업로드 중 오류가 발생했습니다.' TYPE 'E'.
    RETURN.
  ENDIF.

  SORT lt_excel BY row col.

*-----------------------------------------------------------------------
* 3. 엑셀 → 내부 구조 매핑
*-----------------------------------------------------------------------
*  LOOP AT lt_excel.
*
*    lv_index = lt_excel-col.
*    ASSIGN COMPONENT lv_index OF STRUCTURE gs_excel TO <field>.
*    IF sy-subrc = 0.
*      <field> = lt_excel-value.
*    ENDIF.
*
*    AT END OF row.
*      APPEND gs_excel TO gt_excel.
*      CLEAR gs_excel.
*    ENDAT.
*
*  ENDLOOP.

  LOOP AT lt_excel INTO ls_excel.

    " row 변경되었으면 구조체 append
    IF lv_row <> 0 AND lv_row <> ls_excel-row.
      IF lv_valid = abap_true.
        APPEND gs_excel TO gt_excel.
      ENDIF.
      CLEAR : gs_excel, lv_valid.
      lv_valid = abap_true.       " 새로 검사 시작하니까 lv_valid = abap_true로 초기화.
    ENDIF.

    " 구조체 필드에 값 매핑
    ASSIGN COMPONENT ls_excel-col OF STRUCTURE gs_excel TO <field>.
    IF sy-subrc = 0.
      CASE ls_excel-col.

*        WHEN 2.
*          IF ls_excel-value IS INITIAL.
*            CLEAR <field>.
*          ELSE.
*            lv_valid = abap_false.
*          ENDIF.

        WHEN 1. " 직원번호 - 빈값이어야 함 (자동채번)
          IF ls_excel-value IS INITIAL.
            CLEAR <field>.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 2. " 부서코드 CHAR 2
          IF strlen( ls_excel-value ) = 2.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 3. " 직원이름 - 필수
          IF ls_excel-value IS NOT INITIAL.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.
****여기서 시잗
        WHEN 4. " 연락처 - 간단 패턴 검사
          IF ls_excel-value CP '___-____-____'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.
          lv_row = ls_excel-row.

        WHEN 5. " 생년월일 - 8자리 숫자만 (DATS)
          IF ls_excel-value CP '########'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
            lv_valid = abap_false.
          ENDIF.

        WHEN 6. " 성별 - 1 또는 2
          IF ls_excel-value = '1' OR ls_excel-value = '2'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 7. " 이메일 - 이메일 패턴
          IF ls_excel-value CP '*@*.*'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 8.
          IF ls_excel-value CP '########'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 9. "퇴사일 - 8자리 숫자 또는 빈값 허용
          IF ls_excel-value CP '########' OR ls_excel-value IS INITIAL.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 10. " 직급 - 숫자만 (NUMC 2자리)
          IF ls_excel-value CP '##'.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

        WHEN 11. " 결재자 여부 - 'X' 또는 빈값
          IF ls_excel-value = 'X' OR ls_excel-value IS INITIAL.
            <field> = ls_excel-value.
          ELSE.
*            lv_valid = abap_false.
            IF lv_has_error = abap_true.
              MESSAGE '필드 포맷을 확인하여 작성해주세요.' TYPE 'E'.
            ENDIF.
            RETURN.
          ENDIF.

      ENDCASE.
    ENDIF.

    lv_row = ls_excel-row.

  ENDLOOP.

  " 마지막 row 추가
  IF gs_excel IS NOT INITIAL AND lv_valid = abap_true.
    APPEND gs_excel TO gt_excel.
  ENDIF.


*-----------------------------------------------------------------------
* 4. 결과 적용
*-----------------------------------------------------------------------
  LOOP AT gt_excel INTO gs_excel.

    CLEAR gs_emp.
    MOVE-CORRESPONDING gs_excel TO gs_emp.

*중복 여부 체크: PK 기준 (예: 회사코드 + 계정번호)
    READ TABLE gt_emp WITH KEY empno = gs_emp-empno
                          TRANSPORTING NO FIELDS.
    IF sy-subrc = 0.
      " 중복이므로 스킵
      CONTINUE.
    ENDIF.

    " 수정여부 플래그
    gs_emp-modi_yn = 'X'.
*  "만약 gs_emp-saknr의 길이가 6자리라면
*  IF NOT gs_emp-saknr+6(1) <> space.
*    gs_emp-saknr = '0000' && gs_emp-saknr.
*  ENDIF.
*
    APPEND gs_emp TO gt_emp.

  ENDLOOP.

  PERFORM refresh_table.

  MESSAGE |총 { lines( gt_excel ) }건의 데이터를 업로드했습니다.| TYPE 'S'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_logic
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM download_logic .

  DATA : lt_roid   TYPE lvc_t_roid,
         ls_roid   TYPE lvc_s_roid,
         lv_line   TYPE i,
         lv_answer.

*-- 선택행 정보를 가져온다.
  CALL METHOD go_alv_grid->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

*-- 선택행 없으면 오류메시지
  IF lt_roid IS INITIAL.
    MESSAGE s004 DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

*-- Dialog box
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '엑셀로 출력'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer = '2'.  " No를 선택하면 종료
    RETURN.
  ENDIF.

*-- 선택행의 전표정보 발췌
  CLEAR: gt_selected_body, gs_selected_body.

  LOOP AT lt_roid INTO ls_roid.
    READ TABLE gt_emp INDEX ls_roid-row_id INTO gs_emp.
    IF sy-subrc = 0.
      gs_selected_body = CORRESPONDING #( gs_emp ).
      APPEND gs_selected_body TO gt_selected_body.
    ENDIF.
  ENDLOOP.

  IF objfile IS INITIAL.
    TRY .
        CREATE OBJECT objfile.
    ENDTRY.
  ENDIF.

*-- Open file save window -------------------------------------------*
  IF pfolder IS NOT INITIAL.
    initialfolder = pfolder.
  ELSE.
    objfile->get_temp_directory( CHANGING temp_dir = initialfolder
                                 EXCEPTIONS cntl_error = 1
                                           error_no_gui = 2
                                           not_supported_by_gui = 3 ).
  ENDIF.

  objfile->directory_browse( EXPORTING initial_folder = initialfolder
                             CHANGING selected_folder = pickedfolder
                             EXCEPTIONS cntl_error = 1
                                        error_no_gui = 2
                                        not_supported_by_gui = 3 ).

  IF sy-subrc = 0.
    pfolder = pickedfolder.
  ELSE.
    MESSAGE 'An error has occured picking a folder' TYPE 'I' DISPLAY LIKE 'W'.
    EXIT.
  ENDIF.

*--------------------------------------------------------------------*
  IF pfolder IS INITIAL.
    EXIT.
  ENDIF.

  CALL METHOD objfile->free.
  FREE objfile.

  PERFORM download_excel.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_excel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM download_excel .

  DATA : lv_rc TYPE i.
  DATA: lv_date TYPE c LENGTH 8,
        lv_time TYPE c LENGTH 4,
        lv_name TYPE rlgrap-filename.

*-- 파일명 만들기용 기준 데이터
  READ TABLE gt_selected_body INTO gs_selected_body INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE '선택된 데이터가 없습니다.' TYPE 'E'.
    EXIT.
  ENDIF.

*-- File name
  CLEAR gv_temp_filename.
  lv_date = sy-datum.         " 오늘 날짜 (예: 20250417)
  lv_time = sy-uzeit(4).    " 시분만 (예: 1352)

  CONCATENATE '사원마스터' '_' lv_date '_' lv_time '.XLS'
  INTO lv_name.

  CONCATENATE pfolder '\' lv_name INTO gv_temp_filename.

  gv_form = 'ZEMP_MASTERTEMPLAST'. "swm0들어가서 엑셀양식 추가하기(이름을 ZEMP_MASTER로 저장하면 매칭됨)

  PERFORM download_template   USING gv_form gv_temp_filename.
  PERFORM open_excel_template USING gv_form.
  PERFORM fill_excel_line.

*-- 기본적으로 Sheet 1을 보여주도록 셋팅
  CALL METHOD OF excel 'SHEETS' = sheet EXPORTING #1 = 1.
  CALL METHOD OF sheet 'SELECT' NO FLUSH.

*-- 모두 출력 후 커서 맨 위로 이동
  CALL METHOD OF excel 'Cells' = cell
    EXPORTING
      #1 = 1
      #2 = 1.
  CALL METHOD OF cell 'Select'.

  SET PROPERTY OF excel 'VISIBLE' = 1 .

  MESSAGE s001 WITH TEXT-s01.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&      --> GV_TEMP_FILENAME
*&---------------------------------------------------------------------*
FORM download_template  USING    p_zform p_filename.

  DATA : wwwdata_item LIKE wwwdatatab,
         rc           TYPE i.

  gv_file = p_filename.

  CALL FUNCTION 'WS_FILE_DELETE'
    EXPORTING
      file   = gv_file
    IMPORTING
      return = rc.

  IF rc = 0 OR rc = 1.

  ELSE.
    MESSAGE e001  WITH '임시파일 초기화 실패.'
                       '이전에 Excel에서 자료를 OPEN하였는지 확인.'.
  ENDIF.

  SELECT SINGLE * FROM wwwdata
    INTO CORRESPONDING FIELDS OF wwwdata_item
   WHERE objid = p_zform.

  CALL FUNCTION 'DOWNLOAD_WEB_OBJECT'
    EXPORTING
      key         = wwwdata_item
      destination = gv_file.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form open_excel_template
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GV_FORM
*&---------------------------------------------------------------------*
FORM open_excel_template  USING    p_zform.

  IF excel IS INITIAL.
    CREATE OBJECT excel 'EXCEL.APPLICATION'.
  ENDIF.

  IF sy-subrc NE 0.
    MESSAGE i001 WITH sy-msgli.
  ENDIF.

  CALL METHOD OF excel 'WORKBOOKS' = workbook.
  SET PROPERTY OF excel 'VISIBLE' = 0 .

  CALL METHOD OF workbook 'OPEN' EXPORTING #1 = gv_file.

*-- Sheet에대한 설정을 할때 사용된다.


  GET PROPERTY OF : workbook    'Application' = application,
                    application 'ActiveSheet' = activesheet.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_excel_line
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM fill_excel_line .
  "여기 원하는대로 다 바꿔야함.

  DATA(lv_resdate) = gs_selected_body-resdate.

  DATA : lv_line  TYPE i,
         lv_cnt   TYPE i,
         lv_bukrs TYPE c.

  CLEAR: gs_selected_body.

  lv_line   = 6.
  lv_cnt    = 1.

  LOOP AT gt_selected_body INTO gs_selected_body.

    PERFORM fill_cells USING lv_line  2 lv_cnt.
    PERFORM fill_cells USING lv_line  3 gs_selected_body-empno.
    PERFORM fill_cells USING lv_line  4 gs_selected_body-numtext.
    PERFORM fill_cells USING lv_line  5 gs_selected_body-empname.
    PERFORM fill_cells USING lv_line  6 gs_selected_body-telno.
    PERFORM fill_cells USING lv_line  7 gs_selected_body-birth.
    PERFORM fill_cells USING lv_line  8 gs_selected_body-gender.
    PERFORM fill_cells USING lv_line  9 gs_selected_body-email.
    PERFORM fill_cells USING lv_line  10 gs_selected_body-joindate.
*    PERFORM fill_cells USING lv_line  11 gs_selected_body-resdate.
    PERFORM fill_cells USING lv_line  12 gs_selected_body-dotext.
    PERFORM fill_cells USING lv_line  13 gs_selected_body-approver_yn.


    IF gs_selected_body-resdate = ''.
      PERFORM fill_cells USING lv_line 11 ' '.
    ELSE.
      PERFORM fill_cells USING lv_line 11 gs_selected_body-resdate.
    ENDIF.

    lv_line += 1.
    lv_cnt += 1.

  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form fill_cells
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_LINE
*&      --> P_2
*&      --> LV_CNT
*&---------------------------------------------------------------------*
FORM fill_cells  USING   i j val.

  CALL METHOD OF excel 'CELLS' = cell
    EXPORTING
      #1 = i  " 행
      #2 = j. " 열

  SET PROPERTY OF cell 'VALUE' = val.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form search_emp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM search_emp .

*  DATA: lv_pattern TYPE string. " 명시적으로 string으로 선언
*
*  DATA: lt_emp          TYPE TABLE OF zc103fit0011,
*        ls_emp          TYPE zc103fit0011,
*        lv_name         TYPE zc103fit0011-empname,
*        ls_selected_row TYPE slis_selfield.
*
**-- 1. 입력된 이름 값 가져오기
*  lv_name = gv_empname.  " 또는 p_empname (형 상황에 맞게)
*
**-- 2. 이름 LIKE 검색용 패턴 생성
*  lv_pattern = '%' && lv_name && '%'.
*
**-- 3. 해당 이름 포함된 직원 목록 조회
*  SELECT
* empno
* dptcode
* empname
* telno
* birth
* gender
* email
* joindate
* resdate
* emppos
* payroll
* currency
* approver_yn
*    INTO CORRESPONDING FIELDS OF TABLE lt_emp
*    FROM zc103fit0011
*    WHERE empname LIKE lv_pattern.
*
*  IF lt_emp IS INITIAL.
*    MESSAGE '검색된 직원이 없습니다.' TYPE 'S'.
*    RETURN.
*  ENDIF.
*

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_popup_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_popup_data .
*
*  DATA: lv_pattern TYPE string.
*
*  CLEAR gt_emp.
*
*  lv_pattern = '%' && gv_name && '%'.
*
*  SELECT empno
*         dptcode
*         empname
*         telno
*         birth
*         gender
*         email
*         joindate
*         resdate
*         emppos
*         payroll
*         currency
*         approver_yn
*         erdat
*         erzet
*         ernam
*         aedat
*         aezet
*         aenam
*     INTO CORRESPONDING FIELDS OF TABLE gt_emp
*     FROM zc103fit0011
*     WHERE empname LIKE lv_pattern.
*
*  IF pop_container IS INITIAL.
*
*    PERFORM create_popobject.
*
*    CALL METHOD go_alv_grid->set_table_for_first_display
*      EXPORTING
*        is_variant           = gs_variant
*        i_save               = 'A'
*        i_default            = 'X'
*        is_layout            = gs_layout
*        it_toolbar_excluding = gt_ui_functions
*      CHANGING
*        it_outtab            = gt_emp
*        it_fieldcatalog      = gt_fcat.
*
*  ENDIF.
*
*  PERFORM set_screen.
*  PERFORM refresh_screen USING go_alv_grid.
*
ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_popobject
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_popobject .

*-- pop Container
  CREATE OBJECT pop_container
    EXPORTING
      container_name = 'POP_CONT'.

*-- ALV
  CREATE OBJECT go_alv_grid
    EXPORTING
      i_parent = pop_container.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_data .

  CLEAR :gv_empno,
        gv_dptcode,
        gv_empname ,
        gv_name,
        gv_telno,
        gv_birth,
        gv_gender,
        gv_email,
        gv_joindate,
        gv_epos.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_delete_row
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_delete_row .

  DATA: lv_answer TYPE c.

  DATA : lt_roid TYPE lvc_t_roid,
         ls_roid TYPE lvc_s_roid.

*-- 사용자가 선택한 행 정보를 받아온다.
  CALL METHOD go_alv_grid->get_selected_rows
    IMPORTING
      et_row_no = lt_roid.

*-- 삭제할 행을 선택하지 않고 Delete row 버튼 누르면 오류
  IF lt_roid IS INITIAL.
    MESSAGE s026 DISPLAY LIKE 'E'. " 삭제할 행을 선택해주세요.
    EXIT.
  ENDIF.

*-- 삭제 전 사용자 확인
  CALL FUNCTION 'ZC1F030001'
    EXPORTING
      iv_action = '삭제'
    IMPORTING
      ev_answer = lv_answer.

  IF lv_answer = '2'.  " No를 선택하면 종료
    RETURN.
  ENDIF.

*-- Index를 역순으로 정렬하여 밑부분 부터 삭제
  SORT lt_roid BY row_id DESCENDING.

*-- Delete row
  LOOP AT lt_roid INTO ls_roid.

*-- 삭제대상 데이터 Backup
    READ TABLE gt_emp INTO gs_emp INDEX ls_roid-row_id.
    MOVE-CORRESPONDING gs_emp TO gs_emp_d.
    APPEND gs_emp_d TO gt_emp_d.
    CLEAR gs_emp_d.

*-- ITAB에서 삭제
    DELETE gt_emp INDEX ls_roid-row_id.

  ENDLOOP.

  PERFORM refresh_screen USING go_alv_grid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_hotspot_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_ROW_ID
*&      --> E_COLUMN_ID
*&---------------------------------------------------------------------*
FORM handle_hotspot_click  USING    pv_row_id
                                    pv_column_id.

  READ TABLE gt_emp INTO gs_emp INDEX pv_row_id.
  IF sy-subrc = 0 AND pv_column_id = 'EMPNO'.
    " 직원번호를 전역 변수에 저장
    gv_techid = gs_emp-empno.

    " 팝업 화면 호출
    CALL SCREEN 0101 STARTING AT 35 5 ENDING AT 85 18.
*CALL SCREEN 0101 STARTING AT 50 5 ENDING AT 95 25.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form uplooad_pic101
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_0101
*&---------------------------------------------------------------------*
FORM uplooad_pic101  USING gv_techid TYPE zc103e_fi_empno.

  DATA(lv_obj) = |Z{ gv_techid }|.

*   0. 기존 객체 해제
  IF pic IS BOUND.
    pic->free( ).
    FREE: pic.
  ENDIF.

  IF pop_containeremp IS BOUND.
    pop_containeremp->free( ).
    FREE: pop_containeremp.
  ENDIF.

  " 1. Custom 컨테이너 객체 생성 (→ 'CUST_PIC'은 화면에 올린 Custom Control의 이름)
  CREATE OBJECT pop_containeremp
    EXPORTING
      container_name = 'CUST_PIC'.

  " 2. Picture 객체 생성
  CREATE OBJECT pic
    EXPORTING
      parent = pop_containeremp.
  CLEAR : gs_fcat, gt_fcat.

  " 3. SMW0 메타데이터 조회
  CLEAR : gt_wwwtab.
  SELECT SINGLE *
    INTO gt_wwwtab
    FROM wwwparams
   WHERE relid  =  'MI'
     AND objid  =  lv_obj. "SMW0에 등록한 Obj File 이름

  IF sy-subrc <> 0.
    CLEAR gt_wwwtab.  " ← 이거 안 하면 이전 objid 계속 남음
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_pic0101
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_pic0101 .

  IF pic IS BOUND. " 객체 존재 여부 확인 후 모드 설정
    CALL METHOD pic->set_display_mode
      EXPORTING
        display_mode = cl_gui_picture=>display_mode_stretch.

    " URL 생성
    CALL FUNCTION 'DP_PUBLISH_WWW_URL'
      EXPORTING
        objid    = gt_wwwtab-objid
        lifetime = 'T'
      IMPORTING
        url      = url
      EXCEPTIONS
        OTHERS   = 1.

    "실제 이미지 로딩 (URL 있을 경우)
    IF sy-subrc = 0 AND url IS NOT INITIAL.
      CALL METHOD pic->load_picture_from_url_async
        EXPORTING
          url = url.
    ENDIF.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_display_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> GV_EMPNAME
*&      --> P_
*&      --> GV_EMPOS
*&      --> P_
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form save_after
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_after .

*  LOOP AT gt_emp INTO gs_emp.
*    IF gs_emp-gender = '1'.
*      gs_emp-gender = '남성'.
*    ELSEIF gs_emp-gender = '2'.
*      gs_emp-gender = '여성'.
*    ELSE.
*    ENDIF.
*    MODIFY gt_emp FROM gs_emp INDEX sy-tabix.
*  ENDLOOP.

*  PERFORM set_screen.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_emp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_emp .

  CLEAR gs_emp.
  PERFORM refresh_pop.
  CALL SCREEN 102 STARTING AT 5 5.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_new_emp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_new_emp .

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_pop
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_pop .

  CLEAR :  pv_empname,
   pv_dptcode,
   pv_telno,
   pv_birth,
   pv_gender,
   pv_email,
   pv_joindate,
   pv_emppos.

ENDFORM.
